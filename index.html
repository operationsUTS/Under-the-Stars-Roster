<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under the Stars Volunteer Roster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .print-full-width { max-width: 100% !important; }
        }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        @media (max-width: 768px) { .role-cell { min-width: 160px; } }
        .progress-bar { height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.3s ease; }
        .date-past { opacity: 0.5; background-color: #f3f4f6 !important; }
        .date-today { background-color: #fef3c7 !important; border-left: 4px solid #f59e0b; }
        .date-next-shift { background-color: #dbeafe !important; border: 3px solid #3b82f6 !important; }
        .coverage-excellent { background-color: #dcfce7; }
        .coverage-good { background-color: #fef9c3; }
        .coverage-poor { background-color: #fee2e2; }
        .notification-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading-spinner { border: 3px solid #f3f4f6; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
    <div id="app"></div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL='https://evhjncobivtsxeeqvlue.supabase.co';const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aGpuY29iaXZ0c3hlZXF2bHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDAyMTUsImV4cCI6MjA3NzM3NjIxNX0.NZKMBV8WKbef8ADsWAYlgtWlTJsiLqo9T8tjruuy7_k';const ADMIN_PASSWORD='UTS2025Admin';const HISTORICAL_DATA={"thursday-hall":{"2025-10-02":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Alixandra Villis (new CIP)"},{name:"Anil (New, CIP)"}],"drinks":[{name:"Ali or Lesley"}],"laundry":[{name:"Catherine"}]},"2025-10-09":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Janet"},{name:"Sara"},{name:"Tina"}],"drinks":[{name:"Lesley"}],"dishes":[{name:"Catherine (coming early)"}],"laundry":[{name:"Catherine"}]},"2025-10-16":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Lesley"},{name:"Catherine"},{name:"Viv Clark (new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-10-23":{"managers":[{name:"Carl"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Paul"},{name:"Sarah Cornish (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley (hall help)"}],"laundry":[{name:"Adrian"}]},"2025-10-30":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Kerry (2 hours)"},{name:"Sara"},{name:"Lesley"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-11-06":{"managers":[{name:"Ani"},{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Maria and Maca (until 115)"},{name:"Tina"},{name:"Deb"},{name:"Richard (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}],"laundry":[{name:"Adrian"}]},"2025-11-13":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Sarah Cornish"},{name:"Harina (FCU, new)"},{name:"Lesley"},{name:"Larissa (FCU)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-11-20":{"managers":[{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Matthew Poland (one lineage, new)"},{name:"Nikita (one lineage)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}]},"2025-11-27":{"managers":[{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Ali"},{name:"Sara"},{name:"Rachel K"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-04":{"managers":[{name:"Ani"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"MJ (one lineage)"},{name:"Nick (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Catherine"}],"laundry":[{name:"Catherine"}]},"2025-12-11":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Elaine (one lineage, new)"},{name:"Matthew (one lineage, new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-18":{"managers":[{name:"Ani"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Josh (one lineage, new)"},{name:"Lesley"}],"drinks":[{name:"Sue"}]},"2025-12-25":{"hall-help":[{name:"Carol"},{name:"Lesley"},{name:"Steve (Lesley husband)"},{name:"Harley"},{name:"Elle"}]}},"saturday-hall":{"2025-10-04":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey (new)"},{name:"Sarah (new)"},{name:"Morgan"}],"hall-help-2":[{name:"Aimi"},{name:"Steve"}],"drinks":[{name:"Christine"}],"dishes":[{name:"Uatesoni"}],"laundry":[{name:"Morgan"}]},"2025-10-11":{"managers":[{name:"Carl"},{name:"Keiran"}],"hall-help-1":[{name:"Harriet Campbell (new)"},{name:"Jolene"},{name:"Cathleen"}],"hall-help-2":[{name:"Uatesoni"},{name:"Elle"}],"drinks":[{name:"Catherine"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-10-18":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Paul"},{name:"Cecilia (new)"},{name:"Michelle"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Sara"}],"laundry":[{name:"Sue"}]},"2025-10-25":{"managers":[{name:"Rose"}],"hall-help-1":[{name:"Paul"},{name:"Joanne (new)"},{name:"Harley"}],"hall-help-2":[{name:"Jaylah (16,new)"},{name:"Jaylah's mum (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Maria Moran"}],"laundry":[{name:"Liz"}]},"2025-11-01":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey"},{name:"Kaaren"},{name:"Harley"}],"hall-help-2":[{name:"Cecilia"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jimmy"}],"laundry":[{name:"Sue"}]},"2025-11-08":{"managers":[{name:"Keiran 4 - 6"},{name:"Carl"}],"hall-help-1":[{name:"Harriet Campbell"},{name:"Elle"}],"hall-help-2":[{name:"Cathleen Meichtry"},{name:"Karen P"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-11-15":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Sara"},{name:"Morgan"},{name:"Elle"}],"hall-help-2":[{name:"Maryanne"},{name:"Lisa"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jolene"}],"laundry":[{name:"Sue"}]},"2025-11-22":{"managers":[{name:"Carl"},{name:"Ani 4 - 6"}],"hall-help-1":[{name:"Jaylah"},{name:"Jaylahs mum"},{name:"Cecilia"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-11-29":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help-1":[{name:"Rachelt"},{name:"Steve"},{name:"Arshy (new)"}],"drinks":[{name:"Sue"}]},"2025-12-06":{"hall-help-1":[{name:"Abbey"},{name:"Cathleen Meichtry"}],"hall-help-2":[{name:"Harley"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-12-13":{"managers":[{name:"Keiran"}],"hall-help-2":[{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-20":{"hall-help-1":[{name:"Paul"},{name:"Harriet"},{name:"Elle"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-27":{"managers":[{name:"Rose"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]}},"weekly-tasks":{"2025-10-01":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-08":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-15":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}],"cheesecake":[{name:"Rose"}]},"2025-10-22":{"wed-pickup":[{name:"Greg"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-29":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-05":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-12":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Catherine"}]}}};let supabase=null,useLocalStorage=!1;try{supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY)}catch(e){console.error("Supabase failed, using localStorage"),useLocalStorage=!0}const app={currentView:"welcome",selectedPeriod:"oct-dec-2025",showModal:!1,selectedSlot:null,volunteerName:"",signups:{},connectionStatus:"checking",lastSaveTime:null,backupCount:5,isInitialized:!1,isAdmin:!1,adminView:"dashboard",dateNotes:{},giveawayDates:{},showMySignups:!1,searchName:"",isLoading:!1,editingSignup:null,periods:[{id:"oct-dec-2025",label:"October - December 2025",months:[10,11,12],year:2025},{id:"jan-mar-2026",label:"January - March 2026",months:[1,2,3],year:2026},{id:"apr-jun-2026",label:"April - June 2026",months:[4,5,6],year:2026},{id:"jul-sep-2026",label:"July - September 2026",months:[7,8,9],year:2026},{id:"oct-dec-2026",label:"October - December 2026",months:[10,11,12],year:2026}],roles:{"thursday-hall":[{id:"managers",name:"Managers",time:"9:45am-1:30pm",capacity:2},{id:"hall-help",name:"Hall Help",time:"10:00am-1:30pm",capacity:4},{id:"drinks",name:"Drinks Trolley",time:"11:15am-1:30pm",capacity:1},{id:"dishes",name:"Dishes",time:"11:30am-1:30pm",capacity:1},{id:"laundry",name:"Laundry",time:"Various",capacity:1},{id:"giveaway",name:"Giveaway Table",time:"10:45am-12:45pm",capacity:2}],"saturday-hall":[{id:"managers",name:"Managers",time:"2:45pm-6:30pm",capacity:2},{id:"hall-help-1",name:"Hall Help - Shift 1",time:"3:15pm-6:30pm",capacity:3},{id:"hall-help-2",name:"Hall Help - Shift 2",time:"4:30pm-6:30pm (can come earlier)",capacity:2},{id:"drinks",name:"Drinks Trolley",time:"4:00pm-6:30pm",capacity:1},{id:"dishes",name:"Dishes",time:"4:30pm-6:30pm",capacity:1},{id:"laundry",name:"Laundry",time:"Various",capacity:1},{id:"giveaway",name:"Giveaway Table",time:"3:45pm-5:45pm",capacity:2}],"weekly-tasks":[{id:"wed-pickup",name:"Wed Bakers Delight",time:"~3:45pm",capacity:1},{id:"thurs-pickup",name:"Thurs Bakers Delight",time:"4:50pm",capacity:1},{id:"cheesecake",name:"Cheesecake Shop",time:"3-6pm Fri",capacity:1}]},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       getVisibleRoles(e){const t=this.roles[e]||[];return t.filter(t=>"giveaway"!==t.id||this.hasAnyGiveaway(e))},hasAnyGiveaway(e){const t=this.getDatesForPeriod();return t.some(t=>this.isGiveawayEnabled(e,t.date))},isGiveawayEnabled(e,t){const a=`${e}-${t}`;return!0===this.giveawayDates[a]},toggleGiveaway(e,t){const a=`${e}-${t}`;this.giveawayDates[a]=!this.giveawayDates[a],localStorage.setItem("uts-giveaway-dates",JSON.stringify(this.giveawayDates)),this.showNotification(this.giveawayDates[a]?"Giveaway table enabled":"Giveaway table disabled"),this.render()},getNextUpcomingDate(){const e=new Date;e.setHours(0,0,0,0);const t=this.getDatesForPeriod();for(let a of t){const t=new Date(a.date);if(t.setHours(0,0,0,0),t>=e)return a.date}return null},getDateClass(e){const t=new Date;t.setHours(0,0,0,0);const a=new Date(e);a.setHours(0,0,0,0);const s=this.getNextUpcomingDate();return e===s?"date-next-shift":a<t?"date-past":a.getTime()===t.getTime()?"date-today":"date-future"},getCoverageClass(e,t){const a=e/t*100;return a>=90?"coverage-excellent":a>=60?"coverage-good":"coverage-poor"},getMySignups(){if(!this.searchName.trim())return void alert("Please enter your name to find your signups");const e=this.searchName.trim().toLowerCase(),t=[];for(let a in this.signups)for(let s in this.signups[a])for(let i in this.signups[a][s]){const n=this.signups[a][s][i];n.forEach(n=>{if(n.name.toLowerCase().includes(e)){const e=this.roles[a]?.find(e=>e.id===i),r="thursday-hall"===a?"Thursday Hall":"saturday-hall"===a?"Saturday Hall":"Weekly Tasks";t.push({date:s,dateLabel:new Date(s).toLocaleDateString("en-NZ",{weekday:"long",day:"numeric",month:"long",year:"numeric"}),roster:r,role:e?.name||i,time:e?.time||""})}})}if(t.sort((e,t)=>new Date(e.date)-new Date(t.date)),0===t.length)this.showNotification(`No signups found for "${this.searchName}"`,"warning");else{this.showMySignups=!0,this.mySignupsList=t,this.render()}},startEdit(e,t,a,s){this.editingSignup={view:e,dateStr:t,roleId:a,signup:s},this.render()},cancelEdit(){this.editingSignup=null,this.render()},async saveEdit(e){if(!e.trim())return void alert("Name cannot be empty");const{view:t,dateStr:a,roleId:s,signup:i}=this.editingSignup;if(useLocalStorage){const n=this.signups[t][a][s].indexOf(i);-1!==n&&(this.signups[t][a][s][n].name=e.trim(),localStorage.setItem("uts-roster",JSON.stringify(this.signups)),this.createBackup(),this.showNotification("Name updated successfully!"))}else try{const{error:n}=await supabase.from("volunteer_signups").update({volunteer_name:e.trim()}).eq("id",i.id);if(n)throw n;await this.loadSignups(),this.showNotification("Name updated successfully!")}catch(e){this.showNotification("Error updating name","error"),console.error(e)}this.editingSignup=null,this.render()},validateData(e){if(!e||"object"!=typeof e)return!1;for(let t in e){if(!["thursday-hall","saturday-hall","weekly-tasks"].includes(t))continue;const a=e[t];if("object"!=typeof a)return!1;for(let e in a){const t=a[e];if("object"!=typeof t)return!1;for(let e in t){const a=t[e];if(!Array.isArray(a))return!1;for(let e of a)if(!e.name||"string"!=typeof e.name)return!1}}}return!0},createBackup(){try{const e=new Date().toISOString(),t={data:this.signups,timestamp:e,version:"1.0"},a=this.getBackups();a.push(t),a.length>this.backupCount&&a.shift(),localStorage.setItem("uts-roster-backups",JSON.stringify(a)),console.log("Backup created:",e)}catch(e){console.error("Backup creation failed:",e)}},getBackups(){try{const e=localStorage.getItem("uts-roster-backups");if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(e){return[]}},restoreFromBackup(){const e=this.getBackups();for(let t=e.length-1;t>=0;t--){const a=e[t];if(a.data&&this.validateData(a.data))return this.signups=a.data,console.log("Restored from backup:",a.timestamp),!0}return console.log("No valid backups found. Starting fresh."),this.signups={},!1},showNotification(e,t="success"){if("welcome"===this.currentView&&!this.isInitialized)return void console.log("Notification suppressed on welcome:",e);const a=document.createElement("div");a.className=`notification-enter fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${"success"===t?"bg-green-600":"warning"===t?"bg-yellow-600":"bg-red-600"} text-white font-semibold`,a.textContent=e,document.body.appendChild(a),setTimeout(()=>a.remove(),3e3)},async init(){this.isLoading=!0,this.render(),await this.checkConnection(),await this.loadHistoricalData(),await this.loadSignups(),this.isLoading=!1,this.isInitialized=!0,this.render(),useLocalStorage||!supabase||supabase.channel("signups").on("postgres_changes",{event:"*",schema:"public",table:"volunteer_signups"},()=>this.loadSignups()).subscribe(),setInterval(()=>this.autoBackup(),3e5),this.createBackup()},async checkConnection(){if(useLocalStorage)return void(this.connectionStatus="offline");try{const{error:e}=await supabase.from("volunteer_signups").select("id").limit(1);this.connectionStatus=e?"error":"connected"}catch(e){this.connectionStatus="error",console.error("Connection check failed:",e)}},
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       async loadHistoricalData(){const e=localStorage.getItem("uts-historical-loaded-to-supabase");if(e)return void console.log("Historical data already loaded to database");if(console.log("Loading historical data to database..."),useLocalStorage)this.signups=JSON.parse(JSON.stringify(HISTORICAL_DATA)),localStorage.setItem("uts-roster",JSON.stringify(this.signups)),localStorage.setItem("uts-historical-loaded-to-supabase","true"),console.log("✓ Historical data loaded to localStorage");else try{const e=[];for(let t in HISTORICAL_DATA)for(let a in HISTORICAL_DATA[t])for(let s in HISTORICAL_DATA[t][a]){const i=HISTORICAL_DATA[t][a][s];i.forEach(i=>{e.push({roster_type:t,shift_date:a,role_id:s,volunteer_name:i.name})})}console.log(`Inserting ${e.length} historical signups...`);const t=50;for(let a=0;a<e.length;a+=t){const s=e.slice(a,a+t),{error:i}=await supabase.from("volunteer_signups").insert(s);if(i)throw i;console.log(`Inserted batch ${Math.floor(a/t)+1}/${Math.ceil(e.length/t)}`)}localStorage.setItem("uts-historical-loaded-to-supabase","true"),console.log("✓ Historical data loaded to Supabase successfully!")}catch(e){console.error("Error loading historical data to Supabase:",e),this.signups=JSON.parse(JSON.stringify(HISTORICAL_DATA)),localStorage.setItem("uts-roster",JSON.stringify(this.signups)),localStorage.setItem("uts-historical-loaded-to-supabase","true"),console.log("✓ Historical data loaded to localStorage (fallback)")}this.createBackup()},autoBackup(){try{this.validateData(this.signups)?this.createBackup():console.error("Data validation failed - backup skipped")}catch(e){console.error("Auto-backup failed:",e)}},getDatesForPeriod(){const e=this.periods.find(e=>e.id===this.selectedPeriod);if(!e)return[];const t=[];if("weekly-tasks"===this.currentView)e.months.forEach(e=>{const a=new Date(this.periods.find(t=>t.id===this.selectedPeriod).year,e-1,1);for(;a.getMonth()===e-1;){if(3===a.getDay()){const e=new Date(a),s=new Date(a);s.setDate(s.getDate()+1),t.push({date:e.toISOString().split("T")[0],label:`${e.toLocaleDateString("en-NZ",{day:"numeric",month:"short"})} - ${s.toLocaleDateString("en-NZ",{day:"numeric",month:"short"})}`})}a.setDate(a.getDate()+1)}});else{const a="thursday-hall"===this.currentView?4:6;e.months.forEach(e=>{const s=new Date(this.periods.find(e=>e.id===this.selectedPeriod).year,e-1,1);for(;s.getMonth()===e-1;)s.getDay()===a&&t.push({date:s.toISOString().split("T")[0],label:s.toLocaleDateString("en-NZ",{day:"numeric",month:"short"})}),s.setDate(s.getDate()+1)})}return t},async loadSignups(){if(useLocalStorage){const e=localStorage.getItem("uts-roster");if(e)try{const t=JSON.parse(e);this.validateData(t)?(this.signups=t,this.createBackup()):(console.error("Loaded data is corrupted. Attempting recovery..."),this.restoreFromBackup())}catch(e){console.error("Error parsing data:",e),this.restoreFromBackup()}const t=localStorage.getItem("uts-date-notes");if(t)try{this.dateNotes=JSON.parse(t)}catch(e){this.dateNotes={}}const a=localStorage.getItem("uts-giveaway-dates");if(a)try{this.giveawayDates=JSON.parse(a)}catch(e){this.giveawayDates={}}}else{let e=3;for(;e>0;)try{const{data:t,error:a}=await supabase.from("volunteer_signups").select("*");if(a)throw a;if(this.signups={},t.forEach(e=>{this.signups[e.roster_type]||(this.signups[e.roster_type]={}),this.signups[e.roster_type][e.shift_date]||(this.signups[e.roster_type][e.shift_date]={}),this.signups[e.roster_type][e.shift_date][e.role_id]||(this.signups[e.roster_type][e.shift_date][e.role_id]=[]),this.signups[e.roster_type][e.shift_date][e.role_id].push({id:e.id,name:e.volunteer_name})}),!this.validateData(this.signups))throw new Error("Loaded data failed validation");this.connectionStatus="connected",this.lastSaveTime=new Date,this.createBackup();break}catch(t){if(e--,0===e){console.error("Load failed after retries:",t),this.connectionStatus="error",this.restoreFromBackup();break}await new Promise(e=>setTimeout(e,1e3))}const e=localStorage.getItem("uts-date-notes");if(e)try{this.dateNotes=JSON.parse(e)}catch(e){this.dateNotes={}}const t=localStorage.getItem("uts-giveaway-dates");if(t)try{this.giveawayDates=JSON.parse(t)}catch(e){this.giveawayDates={}}}this.isInitialized&&this.render()},saveNote(e,t,a){const s=`${e}-${t}`;a.trim()?this.dateNotes[s]=a.trim():delete this.dateNotes[s],localStorage.setItem("uts-date-notes",JSON.stringify(this.dateNotes)),this.showNotification("Note saved")},getNote(e,t){const a=`${e}-${t}`;return this.dateNotes[a]||""},async addSignup(){if(!this.volunteerName.trim())return alert("Please enter your name");const{view:e,dateStr:t,roleId:a}=this.selectedSlot,s=JSON.parse(JSON.stringify(this.signups));if(useLocalStorage)try{this.signups[e]||(this.signups[e]={}),this.signups[e][t]||(this.signups[e][t]={}),this.signups[e][t][a]||(this.signups[e][t][a]=[]),this.signups[e][t][a].push({name:this.volunteerName.trim()}),this.validateData(this.signups)||(()=>{throw new Error("Data validation failed")})(),localStorage.setItem("uts-roster",JSON.stringify(this.signups)),this.createBackup(),this.showNotification("✓ Signed up successfully!")}catch(e){return this.signups=s,void this.showNotification("Error signing up: "+e.message,"error")}else{let s=3;for(;s>0;)try{const{data:s,error:i}=await supabase.from("volunteer_signups").insert({roster_type:e,shift_date:t,role_id:a,volunteer_name:this.volunteerName.trim()}).select();if(i)throw i;await this.loadSignups(),this.showNotification("✓ Signed up successfully!");break}catch(e){if(s--,0===s)return void this.showNotification("Error signing up. Please try again.","error");await new Promise(e=>setTimeout(e,1e3))}}this.showModal=!1,this.volunteerName="",this.render()},async removeSignup(e,t,a,s){if(!confirm(`Remove ${s.name}?`))return;const i=JSON.parse(JSON.stringify(this.signups));if(useLocalStorage)try{this.signups[e][t][a]=this.signups[e][t][a].filter(e=>e!==s),this.validateData(this.signups)||(()=>{throw new Error("Data validation failed")})(),localStorage.setItem("uts-roster",JSON.stringify(this.signups)),this.createBackup(),this.showNotification("✓ Removed successfully")}catch(e){this.signups=i,this.showNotification("Error removing: "+e.message,"error")}else{let e=3;for(;e>0;)try{const{error:t}=await supabase.from("volunteer_signups").delete().eq("id",s.id);if(t)throw t;await this.loadSignups(),this.showNotification("✓ Removed successfully");break}catch(t){if(e--,0===e)return void this.showNotification("Error removing. Please try again.","error");await new Promise(e=>setTimeout(e,1e3))}}this.render()},getSignups(e,t,a){return this.signups[e]?.[t]?.[a]||[]},getNextShiftStats(){const e=this.getNextUpcomingDate();if(!e)return null;const t=this.getVisibleRoles(this.currentView);let a=0,s=0;t.forEach(t=>{const i=this.getSignups(this.currentView,e,t.id);a+=t.capacity,s+=Math.min(i.length,t.capacity)});const i=new Date(e),n=i.toLocaleDateString("en-NZ",{weekday:"long",day:"numeric",month:"long"});return{totalSlots:a,filledSlots:s,coverage:Math.round(s/a*100),dateLabel:n,needsHelp:a-s}},getRosterStats(){const e=this.getDatesForPeriod(),t=this.getVisibleRoles(this.currentView);let a=0,s=0,i=0;return e.forEach(e=>{t.forEach(t=>{const n=this.getSignups(this.currentView,e.date,t.id);a+=t.capacity,s+=Math.min(n.length,t.capacity),n.length<t.capacity&&i++})}),{totalSlots:a,filledSlots:s,needsHelp:i,coverage:Math.round(s/a*100)}},loginAdmin(){const e=prompt("Enter admin password:");e===ADMIN_PASSWORD?(this.isAdmin=!0,this.currentView="admin",this.render()):null!==e&&alert("Incorrect password")},logoutAdmin(){this.isAdmin=!1,this.currentView="welcome",this.render()},addNextQuarter(){const e=this.periods[this.periods.length-1],t=e.year,a=e.months,s=a[a.length-1];let i=t,n=[],r=s+1;r>12&&(r=1,i++);for(let e=0;e<3;e++){let a=r+e;a>12&&(a-=12,i=t+1),n.push(a)}const o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],l=`${o[n[0]-1]} - ${o[n[2]-1]} ${i}`,d=`${o[n[0]-1].toLowerCase()}-${o[n[2]-1].toLowerCase()}-${i}`;this.periods.push({id:d,label:l,months:n,year:i}),this.showNotification(`Added quarter: ${l}`,"success"),this.render()},exportToCSV(){const e=[["Date","Day","Roster Type","Role","Time","Volunteer","Capacity"]];for(let t in this.signups){const a="thursday-hall"===t?"Thursday Hall":"saturday-hall"===t?"Saturday Hall":"Weekly Tasks";for(let s in this.signups[t]){const i=new Date(s),n=i.toLocaleDateString("en-NZ",{weekday:"long"}),r=i.toLocaleDateString("en-NZ",{day:"numeric",month:"short",year:"numeric"});for(let i in this.signups[t][s]){const o=this.roles[t]?.find(e=>e.id===i),l=this.signups[t][s][i];0===l.length?e.push([r,n,a,o?.name||i,o?.time||"","(empty)",o?.capacity||""]):l.forEach(s=>{e.push([r,n,a,o?.name||i,o?.time||"",s.name,o?.capacity||""])})}}}const t=e.map(e=>e.map(e=>`"${e}"`).join(",")).join("\n"),a=new Blob([t],{type:"text/csv"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download=`uts-roster-${(new Date).toISOString().split("T")[0]}.csv`,i.click(),URL.revokeObjectURL(s),this.showNotification("CSV exported successfully!")},generateReport(){const e={totalSignups:0,volunteerList:new Set,byRoster:{},coverageByDate:{},volunteerCounts:{},volunteersByRole:{managers:{},"hall-help":{},"hall-help-1":{},"hall-help-2":{},drinks:{},dishes:{},laundry:{},giveaway:{}}};for(let t in this.signups){e.byRoster[t]={total:0,volunteers:new Set};for(let a in this.signups[t]){e.coverageByDate[a]||(e.coverageByDate[a]={filled:0,total:0});for(let s in this.signups[t][a]){const i=this.roles[t]?.find(e=>e.id===s),n=this.signups[t][a][s];e.totalSignups+=n.length,e.byRoster[t].total+=n.length,e.coverageByDate[a].filled+=n.length,e.coverageByDate[a].total+=i?.capacity||1,n.forEach(a=>{const n=a.name.replace(/\s*\(.*?\)\s*/g,"").trim();e.volunteerList.add(n),e.byRoster[t].volunteers.add(n),e.volunteerCounts[n]||(e.volunteerCounts[n]=0),e.volunteerCounts[n]++;const r=s.includes("hall-help")?s:s;e.volunteersByRole[r]&&(e.volunteersByRole[r][n]||(e.volunteersByRole[r][n]=0),e.volunteersByRole[r][n]++)})}}}return e.topVolunteers=Object.entries(e.volunteerCounts).sort((e,t)=>t[1]-e[1]).slice(0,10),e},downloadBackup(){const e={data:this.signups,periods:this.periods,timestamp:(new Date).toISOString(),version:"1.0"},t=JSON.stringify(e,null,2),a=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download=`uts-backup-${(new Date).toISOString().split("T")[0]}.json`,i.click(),URL.revokeObjectURL(s),this.showNotification("Backup downloaded!")},uploadBackup(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=t=>{const a=t.target.files[0],s=new FileReader;s.onload=t=>{try{const a=JSON.parse(t.target.result);if(!a.data||!this.validateData(a.data))throw new Error("Invalid backup file");this.signups=a.data,a.periods&&Array.isArray(a.periods)&&(this.periods=a.periods),this.createBackup(),this.showNotification("Backup restored successfully!"),this.render()}catch(e){this.showNotification("Error loading backup: "+e.message,"error")}},s.readAsText(a)},e.click()},render(){const e=document.getElementById("app");if(this.isLoading)return void(e.innerHTML='\n                        <div class="min-h-screen flex items-center justify-center">\n                            <div class="text-center">\n                                <div class="loading-spinner mx-auto mb-4"></div>\n                                <p class="text-gray-600">Loading roster...</p>\n                            </div>\n                        </div>\n                    ');this.showMySignups?e.innerHTML=this.renderMySignups():"welcome"===this.currentView?e.innerHTML=this.renderWelcome():"admin"===this.currentView?e.innerHTML=this.renderAdmin():e.innerHTML=this.renderRoster()}};window.addEventListener("DOMContentLoaded",()=>app.init());
    </script>
</body>
</html>
