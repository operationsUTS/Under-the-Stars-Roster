<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under the Stars Volunteer Roter</title>
   <!-- Cache busting meta tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <script src="https://cdn.tailwindcss.com?v=20241218"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .print-full-width { max-width: 100% !important; }
        }
.table-container {
    width: 100%;
    overflow-x: auto !important;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    position: relative;
}

/* Force scrolling on mobile */
@media (max-width: 768px) {
    .table-container {
        overflow-x: scroll !important;
        -webkit-overflow-scrolling: touch;
        display: block !important;
        width: 100vw;
        margin-left: -1rem;
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    .table-container table {
        width: auto !important;
        min-width: 900px !important;
        display: table !important;
    }
    
    .role-cell {
        min-width: 150px !important;
    }
    
    th, td {
        padding: 0.5rem !important;
        font-size: 0.75rem !important;
    }
}
 .giveaway-disabled {
    background-color: #f9fafb;
    color: #9ca3af;
    font-style: italic;
    text-align: center;
}       
        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .date-past { opacity: 0.4; background-color: #f3f4f6 !important; }
        .date-today { background-color: #fef3c7 !important; border-left: 4px solid #f59e0b; }
        .date-future { }
        .date-next-shift { 
            background: linear-gradient(135deg, #bfdbfe 0%, #dbeafe 100%) !important;
            border: 4px solid #2563eb !important;
            position: relative;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
 .next-shift-badge {
    display: inline-block;
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
    animation: pulse-glow 2s ease-in-out infinite;
    margin-right: 4px;
    white-space: nowrap;
}
        
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        .coverage-excellent { background-color: #dcfce7; }
        .coverage-good { background-color: #fef9c3; }
        .coverage-poor { background-color: #fee2e2; }
        
        .notification-enter {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .edit-mode input {
            width: 100%;
            padding: 2px 4px;
            border: 2px solid #3b82f6;
            border-radius: 4px;
        }
        
        .edit-icon {
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            color: #6b7280;
        }
        
        .volunteer-item:hover .edit-icon {
            opacity: 1;
        }
        
.edit-icon:hover {
            color: #3b82f6;
        }
        
        /* Collapsible month sections */
        .month-section {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .month-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        
        .month-header:hover {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
        }
        
        .month-header .chevron {
            transition: transform 0.3s;
            font-size: 1.5rem;
        }
        
        .month-header.collapsed .chevron {
            transform: rotate(-90deg);
        }
        
        .month-content {
            max-height: 10000px;
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
        
        .month-content.collapsed {
            max-height: 0;
        }

        /* Mobile scroll hint */
        .table-container::after {
            content: '‚Üê Scroll to see all roles ‚Üí';
            position: sticky;
            left: 0;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #4f46e5, transparent);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.75rem;
            font-weight: bold;
            pointer-events: none;
        }

        @media (min-width: 768px) {
            .table-container::after {
                display: none;/* Hide on desktop */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
    <div id="app"></div>

 <script>
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
        });
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" 
            onerror="console.error('Failed to load Supabase library'); window.supabaseLoadFailed = true;"></script>
    <script>
   const APP_VERSION = '20241218-001';
        console.log('üöÄ App version:', APP_VERSION);
        
        const SUPABASE_URL = 'https://evhjncobivtsxeeqvlue.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aGpuY29iaXZ0c3hlZXF2bHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDAyMTUsImV4cCI6MjA3NzM3NjIxNX0.NZKMBV8WKbef8ADsWAYlgtWlTJsiLqo9T8tjruuy7_k';
        const ADMIN_PASSWORD = 'UTS2025Admin';

        const HISTORICAL_DATA = {"thursday-hall":{"2025-10-02":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Alixandra Villis (new CIP)"},{name:"Anil (New, CIP)"}],"drinks":[{name:"Ali or Lesley"}],"laundry":[{name:"Catherine"}]},"2025-10-09":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Janet"},{name:"Sara"},{name:"Tina"}],"drinks":[{name:"Lesley"}],"dishes":[{name:"Catherine (coming early)"}],"laundry":[{name:"Catherine"}]},"2025-10-16":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Lesley"},{name:"Catherine"},{name:"Viv Clark (new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-10-23":{"managers":[{name:"Carl"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Paul"},{name:"Sarah Cornish (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley (hall help)"}],"laundry":[{name:"Adrian"}]},"2025-10-30":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Kerry (2 hours)"},{name:"Sara"},{name:"Lesley"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-11-06":{"managers":[{name:"Ani"},{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Maria and Maca (until 115)"},{name:"Tina"},{name:"Deb"},{name:"Richard (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}],"laundry":[{name:"Adrian"}]},"2025-11-13":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Sarah Cornish"},{name:"Harina (FCU, new)"},{name:"Lesley"},{name:"Larissa (FCU)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-11-20":{"managers":[{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Matthew Poland (one lineage, new)"},{name:"Nikita (one lineage)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}]},"2025-11-27":{"managers":[{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Ali"},{name:"Sara"},{name:"Rachel K"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-04":{"managers":[{name:"Ani"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"MJ (one lineage)"},{name:"Nick (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Catherine"}],"laundry":[{name:"Catherine"}]},"2025-12-11":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Elaine (one lineage, new)"},{name:"Matthew (one lineage, new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-18":{"managers":[{name:"Ani"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Josh (one lineage, new)"},{name:"Lesley"}],"drinks":[{name:"Sue"}]},"2025-12-25":{"hall-help":[{name:"Carol"},{name:"Lesley"},{name:"Steve (Lesley husband)"},{name:"Harley"},{name:"Elle"}]}},"saturday-hall":{"2025-10-04":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey (new)"},{name:"Sarah (new)"},{name:"Morgan"}],"hall-help-2":[{name:"Aimi"},{name:"Steve"}],"drinks":[{name:"Christine"}],"dishes":[{name:"Uatesoni"}],"laundry":[{name:"Morgan"}]},"2025-10-11":{"managers":[{name:"Carl"},{name:"Keiran"}],"hall-help-1":[{name:"Harriet Campbell (new)"},{name:"Jolene"},{name:"Cathleen"}],"hall-help-2":[{name:"Uatesoni"},{name:"Elle"}],"drinks":[{name:"Catherine"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-10-18":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Paul"},{name:"Cecilia (new)"},{name:"Michelle"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Sara"}],"laundry":[{name:"Sue"}]},"2025-10-25":{"managers":[{name:"Rose"}],"hall-help-1":[{name:"Paul"},{name:"Joanne (new)"},{name:"Harley"}],"hall-help-2":[{name:"Jaylah (16,new)"},{name:"Jaylah's mum (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Maria Moran"}],"laundry":[{name:"Liz"}]},"2025-11-01":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey"},{name:"Kaaren"},{name:"Harley"}],"hall-help-2":[{name:"Cecilia"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jimmy"}],"laundry":[{name:"Sue"}]},"2025-11-08":{"managers":[{name:"Keiran 4 - 6"},{name:"Carl"}],"hall-help-1":[{name:"Harriet Campbell"},{name:"Elle"}],"hall-help-2":[{name:"Cathleen Meichtry"},{name:"Karen P"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-11-15":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Sara"},{name:"Morgan"},{name:"Elle"}],"hall-help-2":[{name:"Maryanne"},{name:"Lisa"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jolene"}],"laundry":[{name:"Sue"}]},"2025-11-22":{"managers":[{name:"Carl"},{name:"Ani 4 - 6"}],"hall-help-1":[{name:"Jaylah"},{name:"Jaylahs mum"},{name:"Cecilia"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-11-29":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help-1":[{name:"Rachelt"},{name:"Steve"},{name:"Arshy (new)"}],"drinks":[{name:"Sue"}]},"2025-12-06":{"hall-help-1":[{name:"Abbey"},{name:"Cathleen Meichtry"}],"hall-help-2":[{name:"Harley"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-12-13":{"managers":[{name:"Keiran"}],"hall-help-2":[{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-20":{"hall-help-1":[{name:"Paul"},{name:"Harriet"},{name:"Elle"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-27":{"managers":[{name:"Rose"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]}},"weekly-tasks":{"2025-10-01":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-08":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-15":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}],"cheesecake":[{name:"Rose"}]},"2025-10-22":{"wed-pickup":[{name:"Greg"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-29":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-05":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-12":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Catherine"}]}}};

        let supabase = null;
        let useLocalStorage = false;

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error('Supabase failed, using localStorage');
            useLocalStorage = true;
        }

        const app = {
            currentView: 'welcome',
            selectedPeriod: 'oct-dec-2025',
            showModal: false,
            selectedSlot: null,
            volunteerName: '',
            signups: {},
            specialEvents: [],
            editingEvent: null,
            connectionStatus: 'checking',
            lastSaveTime: null,
            backupCount: 5,
            isInitialized: false,
            isAdmin: false,
            adminView: 'dashboard',
            dateNotes: {},
            giveawayDates: {},
            showMySignups: false,
            searchName: '',
            isLoading: false,
            editingSignup: null,
            collapsedMonths: {},

            periods: [
                { id: 'oct-dec-2025', label: 'October - December 2025', months: [10,11,12], year: 2025 },
                { id: 'jan-mar-2026', label: 'January - March 2026', months: [1,2,3], year: 2026 },
                { id: 'apr-jun-2026', label: 'April - June 2026', months: [4,5,6], year: 2026 },
                { id: 'jul-sep-2026', label: 'July - September 2026', months: [7,8,9], year: 2026 },
                { id: 'oct-dec-2026', label: 'October - December 2026', months: [10,11,12], year: 2026 },
            ],

            roles: {
                'thursday-hall': [
                    { id: 'managers', name: 'Managers', time: '9:45am-1:30pm', capacity: 2 },
                    { id: 'hall-help', name: 'Hall Help', time: '10:00am-1:30pm', capacity: 4 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '11:15am-1:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '11:30am-1:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                    { id: 'giveaway', name: 'Giveaway Table', time: '10:45am-12:45pm', capacity: 2 },
                ],
                'saturday-hall': [
                    { id: 'managers', name: 'Managers', time: '2:45pm-6:30pm', capacity: 2 },
                    { id: 'hall-help-1', name: 'Hall Help - Shift 1', time: '3:15pm-6:30pm', capacity: 3 },
                    { id: 'hall-help-2', name: 'Hall Help - Shift 2', time: '4:30pm-6:30pm (can come earlier)', capacity: 2 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '4:00pm-6:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '4:30pm-6:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                    { id: 'giveaway', name: 'Giveaway Table', time: '3:45pm-5:45pm', capacity: 2 },
                ],
                'weekly-tasks': [
                    { id: 'wed-pickup', name: 'Wed Bakers Delight', time: '~3:45pm', capacity: 1 },
                    { id: 'thurs-pickup', name: 'Thurs Bakers Delight', time: '4:50pm', capacity: 1 },
                    { id: 'cheesecake', name: 'Cheesecake Shop', time: '3-6pm Fri', capacity: 1 },
                ]
            },

            toggleMonth(monthKey) {
                this.collapsedMonths[monthKey] = !this.collapsedMonths[monthKey];
                this.render();
            },

            getVisibleRoles(view) {
                // Check if it's a special event
                const event = this.specialEvents.find(e => e.id === view);
                if (event) {
                    return event.roles;
                }
                
                const allRoles = this.roles[view] || [];
                return allRoles.filter(role => {
                    if (role.id !== 'giveaway') return true;
                    return this.hasAnyGiveaway(view);
                });
            },

            hasAnyGiveaway(view) {
                const dates = this.getDatesForPeriod();
                return dates.some(d => this.isGiveawayEnabled(view, d.date));
            },

            isGiveawayEnabled(view, dateStr) {
                const key = `${view}-${dateStr}`;
                return this.giveawayDates[key] === true;
            },

async toggleGiveaway(view, dateStr) {
    const key = `${view}-${dateStr}`;
    const newValue = !this.giveawayDates[key];
    
    this.createBackup();
    
    this.giveawayDates[key] = newValue;
    
    if (!newValue) {
        if (this.signups[view] && this.signups[view][dateStr] && this.signups[view][dateStr]['giveaway']) {
            const giveawaySignups = this.signups[view][dateStr]['giveaway'];
            
            if (!useLocalStorage && supabase && giveawaySignups.length > 0) {
                for (let signup of giveawaySignups) {
                    if (signup.id) {
                        await supabase.from('volunteer_signups').delete().eq('id', signup.id);
                    }
                }
            }
            
            this.signups[view][dateStr]['giveaway'] = [];
        }
    }
    
    localStorage.setItem('uts-giveaway-dates', JSON.stringify(this.giveawayDates));
    
    if (!useLocalStorage && supabase) {
        try {
            await supabase.from('roster_settings').upsert({
                setting_type: 'giveaway',
                setting_key: key,
                setting_value: newValue ? 'true' : 'false',
                updated_at: new Date().toISOString()
            }, { onConflict: 'setting_type,setting_key' });
        } catch (e) {
            console.error('Error syncing giveaway toggle:', e);
        }
    }
    
    if (useLocalStorage) {
        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
    }
    
    this.showNotification(newValue ? 'Giveaway table enabled' : 'Giveaway table disabled');
    this.render();
},

getNextUpcomingDate(view = null) {
    const targetView = view || this.currentView;
    
    if (targetView === 'weekly-tasks') {
        return null;
    }
    
    const today = new Date();
    today.setHours(0,0,0,0);
    
    const period = this.periods.find(p => p.id === this.selectedPeriod);
    if (!period) {
        return null;
    }
    
    const targetDay = targetView === 'thursday-hall' ? 4 : 6;
    
  const dates = this.getDatesForPeriod();
    
    for (let d of dates) {
        const [year, month, day] = d.date.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        date.setHours(12,0,0,0);
        if (date >= today) {
            return d.date;
        }
    }
    return null;
},

            getDateClass(dateStr) {
    const today = new Date();
    today.setHours(0,0,0,0);
    const [year, month, day] = dateStr.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    date.setHours(0,0,0,0);
    const nextShift = this.getNextUpcomingDate(this.currentView);
    
    if (dateStr === nextShift) return 'date-next-shift';
    if (date < today) return 'date-past';
    if (date.getTime() === today.getTime()) return 'date-today';
    return 'date-future';
},

            getCoverageClass(filled, total) {
                const percentage = (filled / total) * 100;
                if (percentage >= 90) return 'coverage-excellent';
                if (percentage >= 60) return 'coverage-good';
                return 'coverage-poor';
            },

            getMySignups() {
                if (!this.searchName.trim()) {
                    alert('Please enter your name to find your signups');
                    return;
                }
                
                const name = this.searchName.trim().toLowerCase();
                const mySignups = [];
                
                for (let rosterType in this.signups) {
                    for (let dateStr in this.signups[rosterType]) {
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            volunteers.forEach(v => {
                                if (v.name.toLowerCase().includes(name)) {
                                    const role = this.roles[rosterType]?.find(r => r.id === roleId);
                                    const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                                      rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';
                                    const [year, month, day] = dateStr.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    mySignups.push({
                                        date: dateStr,
                                        dateLabel: date.toLocaleDateString('en-NZ', { 
                                            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
                                        }),
                                        roster: rosterName,
                                        role: role?.name || roleId,
                                        time: role?.time || ''
                                    });
                                }
                            });
                        }
                    }
                }
                
                mySignups.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (mySignups.length === 0) {
                    this.showNotification(`No signups found for "${this.searchName}"`, 'warning');
                } else {
                    this.showMySignups = true;
                    this.mySignupsList = mySignups;
                    this.render();
                }
            },

            startEdit(view, dateStr, roleId, signup) {
                this.editingSignup = { view, dateStr, roleId, signup, originalName: signup.name };
                this.render();
            },

            cancelEdit() {
                this.editingSignup = null;
                this.render();
            },

            async saveEdit(newName) {
                if (!newName.trim()) {
                    alert('Name cannot be empty');
                    return;
                }

                const { view, dateStr, roleId, signup } = this.editingSignup;
                
                if (useLocalStorage) {
                    const signupIndex = this.signups[view][dateStr][roleId].indexOf(signup);
                    if (signupIndex !== -1) {
                        this.signups[view][dateStr][roleId][signupIndex].name = newName.trim();
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        this.createBackup();
                        this.showNotification('Name updated successfully!');
                    }
                } else {
                    try {
                        const { error } = await supabase
                            .from('volunteer_signups')
                            .update({ volunteer_name: newName.trim() })
                            .eq('id', signup.id);
                        
                        if (error) throw error;
                        await this.loadSignups();
                        this.showNotification('Name updated successfully!');
                    } catch (e) {
                        this.showNotification('Error updating name', 'error');
                        console.error(e);
                    }
                }
                
                this.editingSignup = null;
                this.render();
            },

            validateData(data) {
                if (!data || typeof data !== 'object') return false;
                for (let rosterType in data) {
                    if (!['thursday-hall', 'saturday-hall', 'weekly-tasks'].includes(rosterType)) continue;
                    const dates = data[rosterType];
                    if (typeof dates !== 'object') return false;
                    for (let date in dates) {
                        const roles = dates[date];
                        if (typeof roles !== 'object') return false;
                        for (let roleId in roles) {
                            const signups = roles[roleId];
                            if (!Array.isArray(signups)) return false;
                            for (let signup of signups) {
                                if (!signup.name || typeof signup.name !== 'string') return false;
                            }
                        }
                    }
                }
                return true;
            },

          async createBackup() {
    try {
        const timestamp = new Date().toISOString();
        const backup = { 
            data: this.signups, 
            timestamp: timestamp, 
            version: '1.0' 
        };
        
        const backups = this.getBackups();
        backups.push(backup);
        if (backups.length > this.backupCount) backups.shift();
        localStorage.setItem('uts-roster-backups', JSON.stringify(backups));
        console.log('Backup created (localStorage):', timestamp);
        
        if (!useLocalStorage && supabase) {
            try {
                const { error } = await supabase.from('roster_backups').insert({
                    backup_data: this.signups,
                    backup_timestamp: timestamp,
                    backup_version: '1.0',
                    created_at: timestamp
                });
                
                if (error) throw error;
                console.log('‚úì Backup also saved to Supabase:', timestamp);
                
                const { data: allBackups } = await supabase
                    .from('roster_backups')
                    .select('id, created_at')
                    .order('created_at', { ascending: false });
                
                if (allBackups && allBackups.length > 20) {
                    const toDelete = allBackups.slice(20).map(b => b.id);
                    await supabase.from('roster_backups').delete().in('id', toDelete);
                    console.log(`üóëÔ∏è Cleaned up ${toDelete.length} old backups from Supabase`);
                }
            } catch (e) {
                console.error('Failed to backup to Supabase (localStorage backup still succeeded):', e);
            }
        }
    } catch (e) {
        console.error('Backup creation failed:', e);
    }
},

            getBackups() {
                try {
                    const stored = localStorage.getItem('uts-roster-backups');
                    if (!stored) return [];
                    const backups = JSON.parse(stored);
                    return Array.isArray(backups) ? backups : [];
                } catch (e) {
                    return [];
                }
            },

        async restoreFromBackup() {
    if (!useLocalStorage && supabase) {
        try {
            const { data, error } = await supabase
                .from('roster_backups')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);
            
            if (!error && data && data.length > 0) {
                for (let backup of data) {
                    if (backup.backup_data && this.validateData(backup.backup_data)) {
                        this.signups = backup.backup_data;
                        console.log('‚úì Restored from Supabase backup:', backup.backup_timestamp);
                        this.showNotification('Restored from cloud backup', 'success');
                        return true;
                    }
                }
            }
        } catch (e) {
            console.error('Failed to restore from Supabase:', e);
        }
    }
    
    const backups = this.getBackups();
    for (let i = backups.length - 1; i >= 0; i--) {
        const backup = backups[i];
        if (backup.data && this.validateData(backup.data)) {
            this.signups = backup.data;
            console.log('Restored from localStorage backup:', backup.timestamp);
            this.showNotification('Restored from local backup', 'warning');
            return true;
        }
    }
    
    console.log('No valid backups found. Starting fresh.');
    this.signups = {};
    return false;
},
      
            showNotification(message, type = 'success') {
                if (this.currentView === 'welcome' && !this.isInitialized) {
                    console.log('Notification suppressed on welcome:', message);
                    return;
                }
                const notif = document.createElement('div');
                notif.className = `notification-enter fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-red-600'
                } text-white font-semibold`;
                notif.textContent = message;
                document.body.appendChild(notif);
     const duration = type === 'success' ? 5000 : 3000;
                setTimeout(() => notif.remove(), duration);
            },

        async init() {
    this.isLoading = true;
    this.render();
    
    await this.checkConnection();
    await this.loadHistoricalData();
    await this.loadSignups();
    await this.loadSpecialEvents();
    await this.loadSettings();
    
    this.isLoading = false;
    this.isInitialized = true;
    this.render();

    if (!useLocalStorage && supabase) {
        supabase.channel('signups').on('postgres_changes', 
            { event: '*', schema: 'public', table: 'volunteer_signups' }, 
            () => this.loadSignups()
        ).subscribe();
        
        supabase.channel('special-events').on('postgres_changes',
            { event: '*', schema: 'public', table: 'special_events' },
            () => this.loadSpecialEvents()
        ).subscribe();
        
        supabase.channel('settings').on('postgres_changes',
            { event: '*', schema: 'public', table: 'roster_settings' },
            () => this.loadSettings()
        ).subscribe();
    }

    setInterval(() => this.autoBackup(), 300000);
    this.createBackup();
    
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.view) {
            this.currentView = event.state.view;
            this.selectedPeriod = event.state.period || this.selectedPeriod;
            this.showMySignups = event.state.showMySignups || false;
            this.isAdmin = event.state.isAdmin || false;
            this.adminView = event.state.adminView || 'dashboard';
            this.render();
        }
    });
    
    history.replaceState({
        view: this.currentView,
        period: this.selectedPeriod,
        isAdmin: this.isAdmin,
        adminView: this.adminView
    }, '', window.location.href);
},
            async checkConnection() {
                if (useLocalStorage) {
                    this.connectionStatus = 'offline';
                    return;
                }
                try {
                    const { error } = await supabase.from('volunteer_signups').select('id').limit(1);
                    this.connectionStatus = error ? 'error' : 'connected';
                } catch (e) {
                    this.connectionStatus = 'error';
                    console.error('Connection check failed:', e);
                }
            },

          async loadHistoricalData() {
    if (!useLocalStorage && supabase) {
        try {
            const { data, error } = await supabase.from('volunteer_signups').select('id').limit(1);
            if (!error && data && data.length > 0) {
                console.log('Historical data already exists in database');
                return;
            }
        } catch (e) {
            console.error('Error checking for existing data:', e);
        }
    }
    
    const hasHistoricalData = localStorage.getItem('uts-historical-loaded-to-supabase');
    if (hasHistoricalData === 'true') {
                    console.log('Historical data already loaded to database');
                    return;
                }

                console.log('Loading historical data to database...');

                if (useLocalStorage) {
                    this.signups = JSON.parse(JSON.stringify(HISTORICAL_DATA));
                    localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                    localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                    console.log('‚úì Historical data loaded to localStorage');
                } else {
                    try {
                        const insertions = [];
                        
                        for (let rosterType in HISTORICAL_DATA) {
                            for (let dateStr in HISTORICAL_DATA[rosterType]) {
                                for (let roleId in HISTORICAL_DATA[rosterType][dateStr]) {
                                    const volunteers = HISTORICAL_DATA[rosterType][dateStr][roleId];
                                    volunteers.forEach(v => {
                                        insertions.push({
                                            roster_type: rosterType,
                                            shift_date: dateStr,
                                            role_id: roleId,
                                            volunteer_name: v.name
                                        });
                                    });
                                }
                            }
                        }

                        console.log(`Inserting ${insertions.length} historical signups...`);
                        
                        const batchSize = 50;
                        for (let i = 0; i < insertions.length; i += batchSize) {
                            const batch = insertions.slice(i, i + batchSize);
                            const { error } = await supabase.from('volunteer_signups').insert(batch);
                            if (error) throw error;
                            console.log(`Inserted batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(insertions.length/batchSize)}`);
                        }

                        localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                        console.log('‚úì Historical data loaded to Supabase successfully!');
                        
                    } catch (e) {
                        console.error('Error loading historical data to Supabase:', e);
                        this.signups = JSON.parse(JSON.stringify(HISTORICAL_DATA));
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                        console.log('‚úì Historical data loaded to localStorage (fallback)');
                    }
                }

                this.createBackup();
            },

            autoBackup() {
                try {
                    if (!this.validateData(this.signups)) {
                        console.error('Data validation failed - backup skipped');
                        return;
                    }
                    this.createBackup();
                } catch (e) {
                    console.error('Auto-backup failed:', e);
                }
            },

getDayOfWeek(dateStr) {
    const [year, month, day] = dateStr.split('-').map(Number);
    
    let m = month;
    let y = year;
    
    if (m < 3) {
        m += 12;
        y--;
    }
    
    const q = day;
    const K = y % 100;
    const J = Math.floor(y / 100);
    
    const h = (q + Math.floor((13 * (m + 1)) / 5) + K + Math.floor(K / 4) + Math.floor(J / 4) - (2 * J)) % 7;
    
    return (h + 6) % 7;
},

getDatesForPeriod() {
    const period = this.periods.find(p => p.id === this.selectedPeriod);
    if (!period) return [];
    const dates = [];
    
    if (this.currentView === 'weekly-tasks') {
        const targetDay = 3;
        period.months.forEach(month => {
            for (let day = 1; day <= 31; day++) {
                const dateStr = `${period.year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const testDate = new Date(period.year, month - 1, day);
                if (testDate.getMonth() !== month - 1) break;
                
                if (this.getDayOfWeek(dateStr) === targetDay) {
                    const wed = new Date(period.year, month - 1, day);
                    const thurs = new Date(period.year, month - 1, day + 1);
                    
                    dates.push({
                        date: dateStr,
                        label: `${wed.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })} - ${thurs.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })}`
                    });
                }
            }
        });
    } else {
        const targetDay = this.currentView === 'thursday-hall' ? 4 : 6;
        period.months.forEach(month => {
            for (let day = 1; day <= 31; day++) {
                const dateStr = `${period.year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const testDate = new Date(period.year, month - 1, day);
                if (testDate.getMonth() !== month - 1) break;
                
                if (this.getDayOfWeek(dateStr) === targetDay) {
                    const date = new Date(period.year, month - 1, day);
                    dates.push({
                        date: dateStr,
                        label: date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })
                    });
                }
            }
        });
    }
    return dates;
},
        async loadSignups() {
    if (useLocalStorage) {
        const saved = localStorage.getItem('uts-roster');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                if (this.validateData(parsed)) {
                    this.signups = parsed;
                    this.createBackup();
                } else {
                    console.error('Loaded data is corrupted. Attempting recovery...');
                    this.restoreFromBackup();
                }
            } catch (e) {
                console.error('Error parsing data:', e);
                this.restoreFromBackup();
            }
        }
        const savedNotes = localStorage.getItem('uts-date-notes');
        if (savedNotes) {
            try {
                this.dateNotes = JSON.parse(savedNotes);
            } catch (e) {
                this.dateNotes = {};
            }
        }
        const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
        if (savedGiveaway) {
            try {
                this.giveawayDates = JSON.parse(savedGiveaway);
            } catch (e) {
                this.giveawayDates = {};
            }
        }
        const savedEvents = localStorage.getItem('uts-special-events');
        if (savedEvents) {
            try {
                this.specialEvents = JSON.parse(savedEvents);
            } catch (e) {
                this.specialEvents = [];
            }
        }
    } else {
        let retries = 3;
        while (retries > 0) {
            try {
                let allData = [];
                let from = 0;
                const pageSize = 1000;
                
                let maxPages = 100;
                
                while (maxPages > 0) {
                    maxPages--;
                    
                    const { data, error } = await supabase
                        .from('volunteer_signups')
                        .select('*')
                        .range(from, from + pageSize - 1);
                        
                    if (error) throw error;
                    if (!data || data.length === 0) break;
                    
                    allData = allData.concat(data);
                    if (data.length < pageSize) break;
                    from += pageSize;
                }
                
                if (maxPages === 0) {
                    console.warn('‚ö†Ô∏è Hit pagination safety limit! You may have incomplete data.');
                    this.showNotification('Warning: Large dataset detected', 'warning');
                }
                
                console.log('üì• Loaded from Supabase:', allData.length, 'signups (ALL data)');
                
                this.signups = {};
                allData.forEach(s => {
                    if (!this.signups[s.roster_type]) this.signups[s.roster_type] = {};
                    if (!this.signups[s.roster_type][s.shift_date]) this.signups[s.roster_type][s.shift_date] = {};
                    if (!this.signups[s.roster_type][s.shift_date][s.role_id]) this.signups[s.roster_type][s.shift_date][s.role_id] = [];
                    this.signups[s.roster_type][s.shift_date][s.role_id].push({
                        id: s.id,
                        name: s.volunteer_name
                    });
                });
                
                if (!this.validateData(this.signups)) {
                    throw new Error('Loaded data failed validation');
                }
                this.connectionStatus = 'connected';
                this.lastSaveTime = new Date();
                this.createBackup();
                break;
            } catch (e) {
                retries--;
                if (retries === 0) {
                    console.error('Load failed after retries:', e);
                    this.connectionStatus = 'error';
                    this.restoreFromBackup();
                } else {
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }
        const savedNotes = localStorage.getItem('uts-date-notes');
        if (savedNotes) {
            try {
                this.dateNotes = JSON.parse(savedNotes);
            } catch (e) {
                this.dateNotes = {};
            }
        }
        const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
        if (savedGiveaway) {
            try {
                this.giveawayDates = JSON.parse(savedGiveaway);
            } catch (e) {
                this.giveawayDates = {};
            }
        }
        const savedEvents = localStorage.getItem('uts-special-events');
        if (savedEvents) {
            try {
                this.specialEvents = JSON.parse(savedEvents);
            } catch (e) {
                this.specialEvents = [];
            }
        }
    }
    if (this.isInitialized) {
        this.render();
    }
},

            async loadSpecialEvents() {
                if (useLocalStorage) {
                    const savedEvents = localStorage.getItem('uts-special-events');
                    if (savedEvents) {
                        try {
                            this.specialEvents = JSON.parse(savedEvents);
                        } catch (e) {
                            console.error('Error parsing special events:', e);
                            this.specialEvents = [];
                        }
                    }
                } else {
                    try {
                        const { data, error } = await supabase.from('special_events').select('*');
                        if (error) throw error;
                        
                        this.specialEvents = (data || []).map(e => ({
                            id: e.id,
                            name: e.name,
                            dates: e.dates,
                            roles: e.roles,
                            visible: e.visible,
                            created: e.created_at
                        }));
                        
                        localStorage.setItem('uts-special-events', JSON.stringify(this.specialEvents));
                    } catch (e) {
                        console.error('Error loading special events from Supabase:', e);
                        const savedEvents = localStorage.getItem('uts-special-events');
                        if (savedEvents) {
                            try {
                                this.specialEvents = JSON.parse(savedEvents);
                            } catch (e2) {
                                this.specialEvents = [];
                            }
                        }
                    }
                }
                if (this.isInitialized) {
                    this.render();
                }
            },

            async loadSettings() {
                if (useLocalStorage) {
                    const savedNotes = localStorage.getItem('uts-date-notes');
                    if (savedNotes) {
                        try {
                            this.dateNotes = JSON.parse(savedNotes);
                        } catch (e) {
                            this.dateNotes = {};
                        }
                    }
                    const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
                    if (savedGiveaway) {
                        try {
                            this.giveawayDates = JSON.parse(savedGiveaway);
                        } catch (e) {
                            this.giveawayDates = {};
                        }
                    }
                } else {
                    try {
                        const { data, error } = await supabase.from('roster_settings').select('*');
                        if (error) throw error;
                        
                        this.dateNotes = {};
                        this.giveawayDates = {};
                        
                        data.forEach(setting => {
                            if (setting.setting_type === 'note') {
                                this.dateNotes[setting.setting_key] = setting.setting_value;
                            } else if (setting.setting_type === 'giveaway') {
                                this.giveawayDates[setting.setting_key] = setting.setting_value === 'true';
                            }
                        });
                        
                        localStorage.setItem('uts-date-notes', JSON.stringify(this.dateNotes));
                        localStorage.setItem('uts-giveaway-dates', JSON.stringify(this.giveawayDates));
                    } catch (e) {
                        console.error('Error loading settings from Supabase:', e);
                        const savedNotes = localStorage.getItem('uts-date-notes');
                        if (savedNotes) {
                            try {
                                this.dateNotes = JSON.parse(savedNotes);
                            } catch (e2) {
                                this.dateNotes = {};
                            }
                        }
                        const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
                        if (savedGiveaway) {
                            try {
                                this.giveawayDates = JSON.parse(savedGiveaway);
                            } catch (e2) {
                                this.giveawayDates = {};
                            }
                        }
                    }
                    
                    const savedPeriod = localStorage.getItem('uts-selected-period');
                    if (savedPeriod) {
                        this.selectedPeriod = savedPeriod;
                    }
                }
                if (this.isInitialized) {
                    this.render();
                }
            },

            async saveSpecialEvents() {
                localStorage.setItem('uts-special-events', JSON.stringify(this.specialEvents));
                
                if (!useLocalStorage && supabase) {
                    try {
                        await supabase.from('special_events').delete().neq('id', '');
                        
                        if (this.specialEvents.length > 0) {
                            const eventsToInsert = this.specialEvents.map(e => ({
                                id: e.id,
                                name: e.name,
                                dates: e.dates,
                                roles: e.roles,
                                visible: e.visible,
                                created_at: e.created,
                                updated_at: new Date().toISOString()
                            }));
                            
                            const { error } = await supabase.from('special_events').insert(eventsToInsert);
                            if (error) throw error;
                        }
                        console.log('‚úì Special events synced to Supabase');
                    } catch (e) {
                        console.error('Error syncing special events:', e);
                        this.showNotification('Saved locally (offline mode)', 'warning');
                    }
                }
                
       this.createBackup();
            },

            async createSpecialEvent(name, dates, roles, visible = true) {
                const event = {
                    id: Date.now().toString(),
                    name: name.trim(),
                    dates: dates,
                    roles: roles,
                    visible: visible,
                    created: new Date().toISOString()
                };
                this.specialEvents.push(event);
                
                this.signups[event.id] = {};
                dates.forEach(dateStr => {
                    this.signups[event.id][dateStr] = {};
                    roles.forEach(role => {
                        this.signups[event.id][dateStr][role.id] = [];
                    });
                });
                
                await this.saveSpecialEvents();
                localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                this.showNotification(`Event "${name}" created!`);
                return event.id;
            },

            async updateSpecialEvent(eventId, updates) {
                const eventIndex = this.specialEvents.findIndex(e => e.id === eventId);
                if (eventIndex === -1) return;
                
                this.specialEvents[eventIndex] = { ...this.specialEvents[eventIndex], ...updates };
                await this.saveSpecialEvents();
                this.showNotification('Event updated!');
            },

            async deleteSpecialEvent(eventId) {
                const event = this.specialEvents.find(e => e.id === eventId);
                if (!event) return;
                
                if (!confirm(`Delete event "${event.name}"? This will remove all volunteer signups for this event.`)) return;
                
                this.specialEvents = this.specialEvents.filter(e => e.id !== eventId);
                
                delete this.signups[eventId];
                
                await this.saveSpecialEvents();
                localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                this.showNotification('Event deleted');
            },

            async toggleEventVisibility(eventId) {
                const event = this.specialEvents.find(e => e.id === eventId);
                if (!event) return;
                
                event.visible = !event.visible;
                await this.saveSpecialEvents();
                this.showNotification(event.visible ? 'Event visible on welcome screen' : 'Event hidden from welcome screen');
            },

            async saveNote(view, dateStr, note) {
                const key = `${view}-${dateStr}`;
                if (note.trim()) {
                    this.dateNotes[key] = note.trim();
                } else {
                    delete this.dateNotes[key];
                }
                
                localStorage.setItem('uts-date-notes', JSON.stringify(this.dateNotes));
                
                if (!useLocalStorage && supabase) {
                    try {
                        if (note.trim()) {
                            await supabase.from('roster_settings').upsert({
                                setting_type: 'note',
                                setting_key: key,
                                setting_value: note.trim(),
                                updated_at: new Date().toISOString()
                            }, { onConflict: 'setting_type,setting_key' });
                        } else {
                            await supabase.from('roster_settings').delete()
                                .eq('setting_type', 'note')
                                .eq('setting_key', key);
                        }
                    } catch (e) {
                        console.error('Error syncing note:', e);
                    }
                }
                
                this.showNotification('Note saved');
            },

            getNote(view, dateStr) {
                const key = `${view}-${dateStr}`;
                return this.dateNotes[key] || '';
            },
async addSignup() {
    if (!this.volunteerName.trim()) return alert('Please enter your name');
    const { view, dateStr, roleId } = this.selectedSlot;
    
    const role = this.getVisibleRoles(view).find(r => r.id === roleId);
    const currentSignups = this.getSignups(view, dateStr, roleId);
    
    if (currentSignups.length >= role.capacity) {
        const override = confirm(`‚ö†Ô∏è This role is at full capacity (${role.capacity}/${role.capacity}).\n\nDo you want to add an extra volunteer anyway?`);
        if (!override) {
            return;
        }
    }
    
    const originalSignups = JSON.parse(JSON.stringify(this.signups));

    if (useLocalStorage) {
        try {
            if (!this.signups[view]) this.signups[view] = {};
            if (!this.signups[view][dateStr]) this.signups[view][dateStr] = {};
            if (!this.signups[view][dateStr][roleId]) this.signups[view][dateStr][roleId] = [];
            this.signups[view][dateStr][roleId].push({ name: this.volunteerName.trim() });
            if (!this.validateData(this.signups)) {
                throw new Error('Data validation failed');
            }
            localStorage.setItem('uts-roster', JSON.stringify(this.signups));
            this.createBackup();
            this.showNotification('‚úì Signed up successfully!');
        } catch (e) {
            console.error('Error during signup:', e);
            this.signups = originalSignups;
            this.showNotification('Error signing up: ' + e.message, 'error');
            return;
        }
    } else {
        let retries = 3;
        while (retries > 0) {
            try {
                const { data, error } = await supabase.from('volunteer_signups').insert({
                    roster_type: view,
                    shift_date: dateStr,
                    role_id: roleId,
                    volunteer_name: this.volunteerName.trim()
                }).select();
                if (error) throw error;
                await this.loadSignups();
                this.showNotification('‚úì Signed up successfully!');
                break;
            } catch (e) {
                retries--;
                if (retries === 0) {
                    this.showNotification('Error signing up. Please try again.', 'error');
                    return;
                }
                await new Promise(r => setTimeout(r, 1000));
            }
        }
    }
    this.showModal = false;
    this.volunteerName = '';
    this.render();
},

async removeSignup(view, dateStr, roleId, signup) {
    if (!confirm(`Remove ${signup.name}?`)) return;
    const originalSignups = JSON.parse(JSON.stringify(this.signups));
    
    this.createBackup();

    if (useLocalStorage) {
        try {
            this.signups[view][dateStr][roleId] = this.signups[view][dateStr][roleId].filter(s => {
                if (signup.id) {
                    return s.id !== signup.id;
                } else {
                    return s.name !== signup.name;
                }
            });
            
            if (!this.validateData(this.signups)) {
                throw new Error('Data validation failed');
            }
            localStorage.setItem('uts-roster', JSON.stringify(this.signups));
            this.createBackup();
            this.showNotification('‚úì Removed successfully');
        } catch (e) {
            this.signups = originalSignups;
            this.showNotification('Error removing: ' + e.message, 'error');
            return;
        }
    } else {
        let retries = 3;
        while (retries > 0) {
            try {
                const { error } = await supabase.from('volunteer_signups').delete().eq('id', signup.id);
                if (error) throw error;
                await this.loadSignups();
                this.showNotification('‚úì Removed successfully');
                break;
            } catch (e) {
                retries--;
                if (retries === 0) {
                    this.showNotification('Error removing. Please try again.', 'error');
                    return;
                }
                await new Promise(r => setTimeout(r, 1000));
            }
        }
    }
    this.render();
},

            getSignups(view, dateStr, roleId) {
                return this.signups[view]?.[dateStr]?.[roleId] || [];
            },

            getNextShiftStats() {
    // Don't show next shift for weekly tasks or special events
    if (this.currentView === 'weekly-tasks') return null;
    
    // Check if it's a special event (not thursday-hall or saturday-hall)
    if (this.currentView !== 'thursday-hall' && this.currentView !== 'saturday-hall') {
        return null;
    }
    
    const nextDate = this.getNextUpcomingDate(this.currentView);
    if (!nextDate) return null;
    
    const roles = this.getVisibleRoles(this.currentView);
    let totalSlots = 0;
    let filledSlots = 0;
roles.forEach(role => {
    if (role.id === 'giveaway' && !this.isGiveawayEnabled(this.currentView, nextDate)) {
        return;
    }
    
    const signups = this.getSignups(this.currentView, nextDate, role.id);
    totalSlots += role.capacity;
    filledSlots += Math.min(signups.length, role.capacity);
});

const [year, month, day] = nextDate.split('-').map(Number);
const date = new Date(year, month - 1, day);
const dateLabel = date.toLocaleDateString('en-NZ', { 
    weekday: 'long', day: 'numeric', month: 'long'
});

return { 
    totalSlots, 
    filledSlots, 
    coverage: Math.round((filledSlots / totalSlots) * 100),
    dateLabel,
    needsHelp: totalSlots - filledSlots
};
},

            getRosterStats() {
                const dates = this.getDatesForPeriod();
                const roles = this.getVisibleRoles(this.currentView);
                let totalSlots = 0;
                let filledSlots = 0;
                let needsHelp = 0;
                
                dates.forEach(d => {
                    roles.forEach(role => {
                        const signups = this.getSignups(this.currentView, d.date, role.id);
                        totalSlots += role.capacity;
                        filledSlots += Math.min(signups.length, role.capacity);
                        if (signups.length < role.capacity) needsHelp++;
                    });
                });
                
                return { totalSlots, filledSlots, needsHelp, coverage: Math.round((filledSlots / totalSlots) * 100) };
            },

         loginAdmin() {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    this.isAdmin = true;
                    this.currentView = 'admin';
                    this.pushState();
                    this.render();
                } else if (password !== null) {
                    alert('Incorrect password');
                }
            },

       logoutAdmin() {
                this.isAdmin = false;
                this.currentView = 'welcome';
                this.pushState();
                this.render();
            },

            addNextQuarter() {
                const lastPeriod = this.periods[this.periods.length - 1];
                const lastYear = lastPeriod.year;
                const lastMonths = lastPeriod.months;
                const lastMonth = lastMonths[lastMonths.length - 1];
                
                let newYear = lastYear;
                let newMonths = [];
                let startMonth = lastMonth + 1;
                
                if (startMonth > 12) {
                    startMonth = 1;
                    newYear++;
                }
                
                for (let i = 0; i < 3; i++) {
                    let month = startMonth + i;
                    if (month > 12) {
                        month = month - 12;
                        newYear = lastYear + 1;
                    }
                    newMonths.push(month);
                }
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const label = `${monthNames[newMonths[0]-1]} - ${monthNames[newMonths[2]-1]} ${newYear}`;
                const id = `${monthNames[newMonths[0]-1].toLowerCase()}-${monthNames[newMonths[2]-1].toLowerCase()}-${newYear}`;
                
                this.periods.push({
                    id: id,
                    label: label,
                    months: newMonths,
                    year: newYear
                });
                
                this.showNotification(`Added quarter: ${label}`, 'success');
                this.render();
            },

            exportToCSV() {
                const rows = [['Date', 'Day', 'Roster Type', 'Role', 'Time', 'Volunteer', 'Capacity']];
                
                for (let rosterType in this.signups) {
                    const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                      rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';
                    
                    for (let dateStr in this.signups[rosterType]) {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const date = new Date(year, month - 1, day);
                        const dayName = date.toLocaleDateString('en-NZ', { weekday: 'long' });
                        const dateLabel = date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short', year: 'numeric' });
                        
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const role = this.roles[rosterType]?.find(r => r.id === roleId);
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            
                            if (volunteers.length === 0) {
                                rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', '(empty)', role?.capacity || '']);
                            } else {
                                volunteers.forEach(v => {
                                    rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', v.name, role?.capacity || '']);
                                });
                            }
                        }
                    }
                }
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-roster-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('CSV exported successfully!');
            },

            generateReport() {
                const stats = {
                    totalSignups: 0,
                    volunteerList: new Set(),
                    byRoster: {},
                    coverageByDate: {},
                    volunteerCounts: {},
                    volunteersByRole: {
                        managers: new Set(),
                        hallHelp: new Set(),
                        drinks: new Set(),
                        dishes: new Set(),
                        laundry: new Set()
                    },
                    volunteerCountsByRole: {
                        managers: {},
                        hallHelp: {},
                        drinks: {},
                        dishes: {},
                        laundry: {}
                    }
                };
                
                for (let rosterType in this.signups) {
                    stats.byRoster[rosterType] = { total: 0, volunteers: new Set() };
                    
                    for (let dateStr in this.signups[rosterType]) {
                        if (!stats.coverageByDate[dateStr]) {
                            stats.coverageByDate[dateStr] = { filled: 0, total: 0 };
                        }
                        
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const role = this.roles[rosterType]?.find(r => r.id === roleId);
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            
                            stats.totalSignups += volunteers.length;
                            stats.byRoster[rosterType].total += volunteers.length;
                            stats.coverageByDate[dateStr].filled += volunteers.length;
                            stats.coverageByDate[dateStr].total += role?.capacity || 1;
                            
                            volunteers.forEach(v => {
                                const fullName = v.name.trim();
                                stats.volunteerList.add(fullName);
                                stats.byRoster[rosterType].volunteers.add(fullName);
                                
                                if (!stats.volunteerCounts[fullName]) {
                                    stats.volunteerCounts[fullName] = 0;
                                }
                                stats.volunteerCounts[fullName]++;
                                
                                if (roleId === 'managers') {
                                    stats.volunteersByRole.managers.add(fullName);
                                    if (!stats.volunteerCountsByRole.managers[fullName]) {
                                        stats.volunteerCountsByRole.managers[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.managers[fullName]++;
                                } else if (roleId.includes('hall-help')) {
                                    stats.volunteersByRole.hallHelp.add(fullName);
                                    if (!stats.volunteerCountsByRole.hallHelp[fullName]) {
                                        stats.volunteerCountsByRole.hallHelp[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.hallHelp[fullName]++;
                                } else if (roleId === 'drinks') {
                                    stats.volunteersByRole.drinks.add(fullName);
                                    if (!stats.volunteerCountsByRole.drinks[fullName]) {
                                        stats.volunteerCountsByRole.drinks[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.drinks[fullName]++;
                                } else if (roleId === 'dishes') {
                                    stats.volunteersByRole.dishes.add(fullName);
                                    if (!stats.volunteerCountsByRole.dishes[fullName]) {
                                        stats.volunteerCountsByRole.dishes[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.dishes[fullName]++;
                                } else if (roleId === 'laundry') {
                                    stats.volunteersByRole.laundry.add(fullName);
                                    if (!stats.volunteerCountsByRole.laundry[fullName]) {
                                        stats.volunteerCountsByRole.laundry[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.laundry[fullName]++;
                                }
                            });
                        }
                    }
                }
                
                stats.topVolunteers = Object.entries(stats.volunteerCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                stats.topByRole = {
                    managers: Object.entries(stats.volunteerCountsByRole.managers)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    hallHelp: Object.entries(stats.volunteerCountsByRole.hallHelp)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    drinks: Object.entries(stats.volunteerCountsByRole.drinks)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    dishes: Object.entries(stats.volunteerCountsByRole.dishes)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    laundry: Object.entries(stats.volunteerCountsByRole.laundry)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10)
                };
                
                return stats;
            },

            downloadBackup() {
                const backup = {
                    data: this.signups,
                    periods: this.periods,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Backup downloaded!');
            },

            uploadBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            if (backup.data && this.validateData(backup.data)) {
                                this.signups = backup.data;
                                if (backup.periods && Array.isArray(backup.periods)) {
                                    this.periods = backup.periods;
                                }
                                this.createBackup();
                                this.showNotification('Backup restored successfully!');
                                this.render();
                            } else {
                                throw new Error('Invalid backup file');
                            }
                        } catch (e) {
                            this.showNotification('Error loading backup: ' + e.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

navigateTo(view, extraState = {}) {
    this.currentView = view;
    Object.assign(this, extraState);
    this.pushState();
    this.render();
},

pushState() {
    const state = {
        view: this.currentView,
        period: this.selectedPeriod,
        showMySignups: this.showMySignups,
        isAdmin: this.isAdmin,
        adminView: this.adminView
    };
    
    const title = this.currentView === 'welcome' ? 'Under the Stars - Home' :
                 this.currentView === 'admin' ? 'Under the Stars - Admin' :
                 this.currentView === 'thursday-hall' ? 'Thursday Hall Help' :
                 this.currentView === 'saturday-hall' ? 'Saturday Hall Help' :
                 'Under the Stars';
    
    history.pushState(state, title, window.location.pathname);
},
            render() {
                const appEl = document.getElementById('app');
                
                if (this.isLoading) {
                    appEl.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center">
                            <div class="text-center">
                                <div class="loading-spinner mx-auto mb-4"></div>
                          <p class="text-gray-600 text-lg mb-4">Loading roster...</p>
                                <div class="text-sm text-gray-500 bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                                    <p class="font-semibold mb-2">‚è±Ô∏è Taking longer than expected?</p>
                                    <ol class="list-decimal list-inside space-y-1">
                                        <li>Wait up to 30 seconds</li>
                                        <li>Try refreshing (Ctrl+R or Cmd+R)</li>
                                        <li>Clear browser cache and try again</li>
                                        <li>Try a different browser (Chrome/Firefox/Safari)</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                if (this.showMySignups) {
                    appEl.innerHTML = this.renderMySignups();
                } else if (this.currentView === 'welcome') {
                    appEl.innerHTML = this.renderWelcome();
                } else if (this.currentView === 'admin') {
                    appEl.innerHTML = this.renderAdmin();
                } else {
                    appEl.innerHTML = this.renderRoster();
                }
            },

            renderMySignups() {
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-bold">My Signups: ${this.searchName}</h2>
                                    <button onclick="app.showMySignups=false; app.render();" class="text-gray-600 hover:text-gray-800">‚úï Close</button>
                                </div>
                                
                                ${this.mySignupsList.length === 0 ? `
                                    <p class="text-gray-600">No signups found.</p>
                                ` : `
                                    <div class="space-y-3">
                                        ${this.mySignupsList.map(s => `
                                            <div class="p-4 border rounded-lg ${this.getDateClass(s.date)}">
                                                <div class="font-bold text-lg mb-1">${s.dateLabel}</div>
                                                <div class="text-sm text-gray-700">
                                                    <span class="font-semibold">${s.roster}</span> - ${s.role}
                                                    ${s.time ? `<span class="text-gray-500"> (${s.time})</span>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                                
                                <button onclick="app.showMySignups=false; app.render();" class="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                    Back to Roster
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderWelcome() {
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-8">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-12 h-12 text-pink-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                        <div>
                                            <h1 class="text-4xl font-bold">Under the Stars</h1>
                                            <p class="text-xl text-gray-600">Meal Rosters</p>
                                        </div>
                                    </div>
                                    <button onclick="app.loginAdmin()" class="text-gray-400 hover:text-gray-600 text-sm">Admin</button>
                                </div>

                                <div class="mb-8 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                                    <h3 class="font-bold text-indigo-900 mb-2">üìÖ Choose your time period:</h3>
                                    <select onchange="app.selectedPeriod=this.value; localStorage.setItem('uts-selected-period', this.value); app.render();" 
                                            class="w-full p-3 border-2 border-indigo-300 rounded-lg text-lg font-semibold bg-white">
                                        ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="mb-8 text-gray-700 space-y-4">
                                    <p class="text-lg">Welcome! üòä</p>
                                    <p>Thanks for volunteering! We ask volunteers give their time once a month. Don't burn yourself out - we want you around for the long haul! üôÇ</p>
                                    
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h3 class="font-bold text-blue-900 mb-2">To sign up:</h3>
                                        <ol class="list-decimal list-inside space-y-1 text-blue-800">
                                            <li>Choose your preferred day and task below</li>
                                            <li>Find an available date and enter your name</li>
                                            <li><strong>If anything changes, please notify the operations coordinator at <a href="mailto:operations@underthestars.org.nz" class="underline">operations@underthestars.org.nz</a> as soon as possible</strong></li>
                                        </ol>
                                    </div>
                                    
                                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                                        <h3 class="font-bold text-green-900 mb-2">Find Your Signups:</h3>
                                        <div class="flex gap-2">
                                            <input 
                                                type="text" 
                                                placeholder="Enter your name" 
                                                id="searchNameInput"
                                                class="flex-1 px-4 py-2 border rounded-lg"
                                                onkeypress="if(event.key==='Enter'){app.searchName=this.value; app.getMySignups();}"
                                            />
                                            <button onclick="app.searchName=document.getElementById('searchNameInput').value; app.getMySignups();" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700">
                                                Search
                                            </button>
                                        </div>
                                    </div>

                                    <p><strong>Meal Managers:</strong> Ani Stace, Carol Machaj, Keiran Stuart, Carl Fenton, Rose Kent-Wilson, Adrian De Souza</p>
                                    <p><strong>Venue:</strong> Cliff Rd community hall, 45 Cliff Rd</p>
                                    <p class="text-sm">*Long hair tied back. Closed toe shoes required.</p>
                                </div>

                             <div class="space-y-3">
    <button onclick="app.navigateTo('thursday-hall');" 
            class="w-full bg-blue-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-blue-700 transition-colors">
        Thursday Hall Help ‚Üí
    </button>
    
    <button onclick="app.navigateTo('saturday-hall');" 
            class="w-full bg-orange-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-orange-700 transition-colors">
        Saturday Hall Help ‚Üí
    </button>
    
    <button onclick="app.navigateTo('weekly-tasks');" 
            class="w-full bg-pink-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-pink-700 transition-colors">
        Additional Weekly Tasks ‚Üí
    </button>
    
    ${this.specialEvents.filter(e => e.visible).map(event => `
        <button onclick="app.navigateTo('${event.id}');"
                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-lg font-bold text-xl hover:from-purple-700 hover:to-pink-700 transition-colors">
            ${event.name} ‚Üí
        </button>
    `).join('')}
</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderRoster() {
                const specialEvent = this.specialEvents.find(e => e.id === this.currentView);
                const isSpecialEvent = !!specialEvent;
                
                const currentPeriod = this.periods.find(p => p.id === this.selectedPeriod);
                const dates = isSpecialEvent ? this.getDatesForView(this.currentView) : this.getDatesForPeriod();
                const roles = this.getVisibleRoles(this.currentView);
                const stats = this.getRosterStats();
                const nextShiftStats = this.getNextShiftStats();
                const nextShiftDate = this.getNextUpcomingDate();

                const viewTitle = isSpecialEvent ? specialEvent.name :
                                 this.currentView === 'thursday-hall' ? 'Thursday Hall Help' : 
                                 this.currentView === 'saturday-hall' ? 'Saturday Hall Help' : 'Additional Weekly Tasks';

                // Group dates by month
                const datesByMonth = {};
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let currentMonthKey = null;

                dates.forEach(d => {
                    const [year, month, day] = d.date.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    date.setHours(0, 0, 0, 0);
                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                    const monthName = date.toLocaleDateString('en-NZ', { month: 'long', year: 'numeric' });
                    
                    if (!datesByMonth[monthKey]) {
                        datesByMonth[monthKey] = {
                            name: monthName,
                            dates: [],
                            containsToday: false
                        };
                    }
                    
                    datesByMonth[monthKey].dates.push(d);
                    
                    if (date.getTime() === today.getTime()) {
                        datesByMonth[monthKey].containsToday = true;
                        currentMonthKey = monthKey;
                    }
                });

                // If no current month found, find the next upcoming month
                if (!currentMonthKey) {
                    for (let monthKey in datesByMonth) {
                        const firstDateStr = datesByMonth[monthKey].dates[0].date;
                        const [y, m, d] = firstDateStr.split('-').map(Number);
                        const firstDate = new Date(y, m - 1, d);
                        if (firstDate >= today) {
                            currentMonthKey = monthKey;
                            break;
                        }
                    }
                }

                // Set collapsed state for months
                if (!this.collapsedMonths) this.collapsedMonths = {};
                for (let monthKey in datesByMonth) {
                    if (this.collapsedMonths[monthKey] === undefined) {
                        this.collapsedMonths[monthKey] = (monthKey !== currentMonthKey);
                    }
                }

                return `
                    <div class="min-h-screen p-2 md:p-4 print-full-width">
                        <div class="max-w-7xl mx-auto">
                            ${this.connectionStatus === 'connected' ? `
                                <div class="mb-4 p-3 bg-green-100 text-green-800 rounded-lg text-sm">
                                    ‚úì Connected - Changes sync across all devices
                                </div>
                            ` : this.connectionStatus === 'error' ? `
                                <div class="mb-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg text-sm">
                                    ‚ö†Ô∏è Working offline - Using local storage
                                </div>
                            ` : ''}

                            <div class="bg-white rounded-lg shadow-xl p-4 md:p-6 mb-6 no-print">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                    <div>
                                        <h1 class="text-2xl md:text-3xl font-bold mb-1">${viewTitle}</h1>
                                        ${!isSpecialEvent ? `<p class="text-gray-600">${currentPeriod.label}</p>` : `<p class="text-gray-600">Special Event</p>`}
                                    </div>
                                    <div class="flex gap-2">
                                <button onclick="app.isAdmin && app.currentView.startsWith('event-') ? app.navigateTo('admin', {adminView: 'special-events'}) : app.navigateTo('welcome');" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">‚Üê Back</button>
                                        <button onclick="window.print()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Print</button>
                                    </div>
                                </div>

                                ${nextShiftStats ? `
                                    <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border-2 border-blue-300">
                                        <div class="flex justify-between items-center mb-2">
                                            <div>
                                                <h3 class="font-bold text-blue-900">Next Shift: ${nextShiftStats.dateLabel}</h3>
                                                <p class="text-sm text-blue-700">${nextShiftStats.filledSlots} of ${nextShiftStats.totalSlots} positions filled</p>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-3xl font-bold ${nextShiftStats.coverage >= 90 ? 'text-green-600' : nextShiftStats.coverage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                                    ${nextShiftStats.coverage}%
                                                </div>
                                                ${nextShiftStats.needsHelp > 0 ? `
                                                    <div class="text-xs text-red-600 font-semibold">
                                                        Need ${nextShiftStats.needsHelp} more!
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill ${nextShiftStats.coverage >= 90 ? 'bg-green-500' : nextShiftStats.coverage >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                                 style="width: ${nextShiftStats.coverage}%"></div>
                                        </div>
                                    </div>
                                ` : ''}

                                ${!isSpecialEvent ? `
                                    <div class="flex flex-col md:flex-row gap-2 mb-4">
                                        <select onchange="app.selectedPeriod=this.value; localStorage.setItem('uts-selected-period', this.value); app.render();" class="flex-1 p-2 border rounded-lg">
                                            ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                                        </select>
                                        ${this.currentView !== 'weekly-tasks' ? `
                                            <button onclick="app.currentView='${this.currentView === 'thursday-hall' ? 'saturday-hall' : 'thursday-hall'}'; app.render();" 
                                                    class="px-4 py-2 ${this.currentView === 'thursday-hall' ? 'bg-orange-600' : 'bg-blue-600'} text-white rounded-lg hover:opacity-90">
                                                Switch to ${this.currentView === 'thursday-hall' ? 'Saturday' : 'Thursday'}
                                            </button>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>

<div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-4 no-print">
    <h3 class="font-bold text-blue-900 mb-2">üìù How to Sign Up:</h3>
    <ol class="list-decimal list-inside space-y-1 text-blue-800 text-sm">
        <li>Expand the month you want to volunteer</li>
        <li>Find a date that works for you</li>
        <li>Click the green "‚úã Sign me up!" button for your preferred role</li>
        <li>Type your name and click Confirm</li>
    </ol>
    <p class="text-xs text-blue-700 mt-2">üí° Tip: Click month headers to expand/collapse. Scroll right to see all roles.</p>
</div>

<!-- MONTHLY SECTIONS -->
${Object.entries(datesByMonth).map(([monthKey, monthData]) => {
    const isCollapsed = this.collapsedMonths[monthKey];
    
    return `
        <div class="month-section mb-4">
            <div class="month-header ${isCollapsed ? 'collapsed' : ''}" onclick="app.toggleMonth('${monthKey}'); app.render();">
                <span>${monthData.name}</span>
                <span class="chevron">‚ñº</span>
            </div>
            
            <div class="month-content ${isCollapsed ? 'collapsed' : ''}">
                <div class="bg-white overflow-hidden">
                    <div class="overflow-auto max-h-[600px]">
                        <table class="w-full">
                            <thead class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white z-20">
                                <tr>
                                    <th class="p-2 md:p-3 text-left text-xs md:text-sm font-semibold sticky left-0 bg-indigo-600 z-30">Date</th>
                                    ${roles.map(role => `
                                        <th class="p-2 md:p-3 text-left text-xs md:text-sm font-semibold role-cell">
                                            <div class="font-bold">${role.name}</div>
                                            <div class="text-xs opacity-90">${role.time}</div>
                                        </th>
                                    `).join('')}
                                    <th class="p-2 md:p-3 text-left text-xs md:text-sm font-semibold">
                                        <div class="font-bold">Notes</div>
                                        <div class="text-xs opacity-90">${this.isAdmin ? 'Admin only' : 'If any'}</div>
                                    </th>
                                    ${this.isAdmin && this.currentView !== 'weekly-tasks' ? '<th class="p-2 md:p-3 text-center text-xs md:text-sm font-semibold">Giveaway</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${monthData.dates.map((d, i) => {
                                    const dateClass = this.getDateClass(d.date);
                                    const isNextShift = d.date === nextShiftDate;
                                    return `
                                    <tr class="border-b hover:bg-gray-50 ${dateClass}">
                                        <td class="p-2 md:p-3 font-semibold text-xs md:text-sm sticky left-0 bg-white z-10 border-r">
                                            <div class="flex flex-col gap-1">
                                                ${isNextShift ? '<div class="next-shift-badge">NEXT</div>' : ''}
                                                <span>${d.label}</span>
                                            </div>
                                        </td>
                                        ${roles.map(role => {
                                            const isGiveawayRole = role.id === 'giveaway';
                                            const giveawayEnabled = this.isGiveawayEnabled(this.currentView, d.date);
                                            
                                            if (isGiveawayRole && !giveawayEnabled) {
                                                return `
                                                    <td class="p-2 md:p-3 text-xs md:text-sm role-cell giveaway-disabled">
                                                        Not available
                                                    </td>
                                                `;
                                            }
                                            
                                            const signups = this.getSignups(this.currentView, d.date, role.id);
                                            const slotsLeft = role.capacity - signups.length;
                                            return `
                                            <td class="p-2 md:p-3 text-xs md:text-sm role-cell">
                                                ${signups.map(signup => {
                                                    const isEditing = this.editingSignup && 
                                                                    this.editingSignup.view === this.currentView && 
                                                                    this.editingSignup.dateStr === d.date && 
                                                                    this.editingSignup.roleId === role.id && 
                                                                    this.editingSignup.signup === signup;
                                                    
                                                    return `
                                                        <div class="mb-1 flex items-center gap-1 volunteer-item">
                                                            ${isEditing ? `
                                                                <input 
                                                                    type="text" 
                                                                    value="${signup.name}" 
                                                                    id="editInput-${monthKey}-${i}"
                                                                    class="flex-1 px-2 py-1 border-2 border-blue-500 rounded"
                                                                    onkeypress="if(event.key==='Enter'){app.saveEdit(this.value);}"
                                                                />
                                                                <button onclick="app.saveEdit(document.getElementById('editInput-${monthKey}-${i}').value);" class="text-green-600 hover:text-green-800 text-lg">‚úì</button>
                                                                <button onclick="app.cancelEdit();" class="text-red-600 hover:text-red-800 text-lg">‚úï</button>
                                                            ` : `
                                                                <span class="flex-1">‚úì ${signup.name}</span>
                                                                <button onclick="app.startEdit('${this.currentView}', '${d.date}', '${role.id}', app.getSignups('${this.currentView}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="edit-icon text-sm">‚úèÔ∏è</button>
                                                                <button onclick="app.removeSignup('${this.currentView}', '${d.date}', '${role.id}', app.getSignups('${this.currentView}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="text-red-600 hover:text-red-800 text-sm ml-1">‚úï</button>
                                                            `}
                                                        </div>
                                                    `;
                                                }).join('')}
                                                ${!this.editingSignup || this.editingSignup.view !== this.currentView || this.editingSignup.dateStr !== d.date || this.editingSignup.roleId !== role.id ? `
                                                    <button onclick="app.selectedSlot={view:'${this.currentView}', dateStr:'${d.date}', roleId:'${role.id}'}; app.showModal=true; app.render();" 
                                                            class="w-full text-left px-2 py-1 mb-1 text-xs font-semibold rounded transition-all
                                                                   ${slotsLeft > 0 
                                                                     ? 'bg-green-50 border-2 border-green-400 text-green-700 hover:bg-green-100 hover:border-green-600' 
                                                                     : 'bg-orange-50 border-2 border-orange-400 text-orange-700 hover:bg-orange-100'}">
                                                        ${slotsLeft > 0 
                                                          ? `‚úã Sign me up! (${slotsLeft} ${slotsLeft === 1 ? 'spot' : 'spots'} left)` 
                                                          : '‚ö†Ô∏è FULL - Add anyway?'}
                                                    </button>
                                                ` : ''}
                                            </td>
                                        `;
                                        }).join('')}
                                        <td class="p-2 md:p-3">
                                            ${this.isAdmin ? `
                                                <input type="text" 
                                                       placeholder="Add note..." 
                                                       value="${this.getNote(this.currentView, d.date)}"
                                                       onchange="app.saveNote('${this.currentView}', '${d.date}', this.value)"
                                                       class="w-full p-1 text-xs border rounded" />
                                            ` : `
                                                ${this.getNote(this.currentView, d.date) ? `
                                                    <div class="text-xs bg-yellow-50 border-l-4 border-yellow-400 p-2 rounded text-yellow-900">
                                                        üìù ${this.getNote(this.currentView, d.date)}
                                                    </div>
                                                ` : ''}
                                            `}
                                        </td>
                                        ${this.isAdmin && this.currentView !== 'weekly-tasks' ? `
                                            <td class="p-2 md:p-3 text-center">
                                                <input type="checkbox" 
                                                       ${this.isGiveawayEnabled(this.currentView, d.date) ? 'checked' : ''}
                                                       onchange="app.toggleGiveaway('${this.currentView}', '${d.date}')"
                                                       class="w-4 h-4" />
                                            </td>
                                        ` : ''}
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}).join('')}

                    </div>

${this.showModal ? `
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){app.showModal=false; app.render();}">
        <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-2xl">
            <h3 class="text-2xl font-bold mb-2">Sign Up for This Shift</h3>
            
            <div class="bg-blue-50 p-3 rounded mb-4 text-sm">
                <p><strong>Date:</strong> ${(() => {
                    const slot = this.selectedSlot;
                    if (!slot) return '';
                    const [y, m, d] = slot.dateStr.split('-').map(Number);
                    const date = new Date(y, m - 1, d);
                    return date.toLocaleDateString('en-NZ', { weekday: 'long', day: 'numeric', month: 'long' });
                })()}</p>
                <p><strong>Role:</strong> ${(() => {
                    const slot = this.selectedSlot;
                    if (!slot) return '';
                    const role = this.getVisibleRoles(slot.view).find(r => r.id === slot.roleId);
                    return role ? `${role.name} (${role.time})` : '';
                })()}</p>
            </div>
            
            <label class="block text-sm font-semibold mb-2">Your Name:</label>
            <input type="text" 
                   placeholder="Enter your full name" 
                   value="${this.volunteerName}"
                   oninput="app.volunteerName=this.value"
                   onkeypress="if(event.key==='Enter'){app.addSignup();}"
                   class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-lg focus:border-blue-500 focus:outline-none"
                   autofocus />
            
            <div class="flex gap-2">
                <button onclick="app.addSignup()" 
                        class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-green-700 transition-colors">
                    ‚úì Confirm Sign Up
                </button>
                <button onclick="app.showModal=false; app.volunteerName=''; app.render();" 
                        class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                    Cancel
                </button>
            </div>
        </div>
    </div>
` : ''}
                `;
            },

            renderAdminRoster(view) {
                const specialEvent = this.specialEvents.find(e => e.id === view);
                const isSpecialEvent = !!specialEvent;
                
                const currentPeriod = this.periods.find(p => p.id === this.selectedPeriod);
                const dates = this.getDatesForView(view);
                const roles = this.getVisibleRoles(view);
                const viewName = isSpecialEvent ? specialEvent.name :
                                view === 'thursday-hall' ? 'Thursday Hall' : 
                                view === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';

return `
    <div class="mb-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-xl font-bold">${viewName}</h3>
            <button onclick="app.adminView='dashboard'; app.render();" class="px-3 py-1 bg-gray-500 text-white text-sm rounded-lg hover:bg-gray-600">‚Üê Back to Dashboard</button>
        </div>
                        ${!isSpecialEvent ? `
                            <select onchange="app.selectedPeriod=this.value; localStorage.setItem('uts-selected-period', this.value); app.render();" class="w-full md:w-auto p-2 border rounded-lg mb-4">
                                ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                            </select>
                        ` : ''}
                    </div>
                    
                    <div class="overflow-x-auto -mx-6 px-6" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                        <table class="w-full border-collapse min-w-max">
                            <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                                <tr>
                                    <th class="p-2 text-left text-sm font-semibold border sticky left-0 bg-indigo-600 z-10" style="min-width: 100px;">Date</th>
                                    ${roles.map(role => `
                                        <th class="p-2 text-left text-sm font-semibold border" style="min-width: 160px;">
                                            <div class="font-bold">${role.name}</div>
                                            <div class="text-xs opacity-90">${role.time}</div>
                                        </th>
                                    `).join('')}
                                    <th class="p-2 text-left text-sm font-semibold border" style="min-width: 120px;">Notes</th>
                                    ${!isSpecialEvent && view !== 'weekly-tasks' ? '<th class="p-2 text-center text-sm font-semibold border" style="min-width: 80px;">Giveaway</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${dates.map((d, i) => {
                                    const dateClass = this.getDateClass(d.date);
                                    return `
                            <tr class="border ${dateClass}">
    <td class="p-2 text-sm font-semibold border sticky left-0 bg-gray-50" style="min-width: 100px;">${d.label}</td>
                                        ${roles.map(role => {
                                            if (role.id === 'giveaway' && !this.isGiveawayEnabled(view, d.date)) {
                                                return '';
                                            }
                                            
                                            const signups = this.getSignups(view, d.date, role.id);
                                            const slotsLeft = role.capacity - signups.length;
                                            return `
                                            <td class="p-2 text-sm border" style="min-width: 160px;">
                                                ${signups.map(signup => {
                                                    const isEditing = this.editingSignup && 
                                                                    this.editingSignup.view === view && 
                                                                    this.editingSignup.dateStr === d.date && 
                                                                    this.editingSignup.roleId === role.id && 
                                                                    this.editingSignup.signup === signup;
                                                    
                                                    return `
                                                        <div class="mb-1 flex items-center gap-1 volunteer-item">
                                                            ${isEditing ? `
                                                                <input 
                                                                    type="text" 
                                                                    value="${signup.name}" 
                                                                    id="editInput-${i}"
                                                                    class="flex-1 px-2 py-1 border-2 border-blue-500 rounded"
                                                                    onkeypress="if(event.key==='Enter'){app.saveEdit(this.value);}"
                                                                />
                                                                <button onclick="app.saveEdit(document.getElementById('editInput-${i}').value);" class="text-green-600 hover:text-green-800 text-lg">‚úì</button>
                                                                <button onclick="app.cancelEdit();" class="text-red-600 hover:text-red-800 text-lg">‚úï</button>
                                                            ` : `
                                                                <span class="flex-1">‚úì ${signup.name}</span>
                                                                <button onclick="app.startEdit('${view}', '${d.date}', '${role.id}', app.getSignups('${view}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="edit-icon text-sm">‚úèÔ∏è</button>
                                                                <button onclick="app.removeSignup('${view}', '${d.date}', '${role.id}', app.getSignups('${view}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="text-red-600 hover:text-red-800 text-sm ml-1">‚úï</button>
                                                            `}
                                                        </div>
                                                    `;
                                                }).join('')}
                                                ${slotsLeft > 0 && (!this.editingSignup || this.editingSignup.view !== view || this.editingSignup.dateStr !== d.date || this.editingSignup.roleId !== role.id) ? 
                                                    Array(slotsLeft).fill(0).map(() => `
                                                        <button onclick="app.selectedSlot={view:'${view}', dateStr:'${d.date}', roleId:'${role.id}'}; app.showModal=true; app.render();" 
                                                                class="w-full text-left px-2 py-1 mb-1 border-2 border-dashed border-gray-300 rounded hover:border-indigo-500 hover:bg-indigo-50 text-gray-500 text-xs">
                                                            + Add volunteer
                                                        </button>
                                                    `).join('') : ''
                                                }
                                            </td>
                                        `;
                                        }).join('')}
                                        <td class="p-2 border" style="min-width: 120px;">
                                            <input type="text" 
                                                   placeholder="Add note..." 
                                                   value="${this.getNote(view, d.date)}"
                                                   onchange="app.saveNote('${view}', '${d.date}', this.value)"
                                                   class="w-full p-1 text-xs border rounded" />
                                        </td>
                                        ${!isSpecialEvent && view !== 'weekly-tasks' ? `
                                            <td class="p-2 text-center border" style="min-width: 80px;">
                                                <input type="checkbox" 
                                                       ${this.isGiveawayEnabled(view, d.date) ? 'checked' : ''}
                                                       onchange="app.toggleGiveaway('${view}', '${d.date}')"
                                                       class="w-4 h-4" />
                                            </td>
                                        ` : ''}
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>

                    ${this.showModal ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){app.showModal=false; app.render();}">
                            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 class="text-xl font-bold mb-4">Sign Up</h3>
                                <input type="text" 
                                       placeholder="Enter volunteer name" 
                                       value="${this.volunteerName}"
                                       oninput="app.volunteerName=this.value"
                                       onkeypress="if(event.key==='Enter'){app.addSignup();}"
                                       class="w-full p-3 border rounded-lg mb-4"
                                       autofocus />
                                <div class="flex gap-2">
                                    <button onclick="app.addSignup()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                        Confirm
                                    </button>
                                    <button onclick="app.showModal=false; app.volunteerName=''; app.render();" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;
            },

            renderSpecialEventsManager() {
                const sortedEvents = [...this.specialEvents].sort((a, b) => {
                    const aDate = new Date(Math.min(...a.dates.map(d => new Date(d.split('-').map(Number)).getTime())));
                    const bDate = new Date(Math.min(...b.dates.map(d => new Date(d.split('-').map(Number)).getTime())));
                    return aDate - bDate;
                });

                return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold">Special Events</h3>
                            <button onclick="app.editingEvent='new'; app.render();" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                                ‚ûï Create New Event
                            </button>
                        </div>

                        ${this.editingEvent === 'new' ? this.renderEventForm() : ''}

                        ${sortedEvents.length === 0 ? `
                            <div class="text-center py-12 text-gray-500">
                                <p class="text-lg mb-2">No special events yet</p>
                                <p class="text-sm">Create your first event to get started!</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${sortedEvents.map(event => {
                                    const firstDate = event.dates[0];
                                    const [year, month, day] = firstDate.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    const isPast = date < new Date();
                                    
                                    return `
                                        <div class="border rounded-lg p-4 ${isPast ? 'bg-gray-50' : 'bg-white'} ${event.visible ? 'border-indigo-300' : 'border-gray-300'}">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex-1">
                                                    <h4 class="text-lg font-bold ${isPast ? 'text-gray-600' : 'text-gray-900'}">${event.name}</h4>
                                                    <p class="text-sm text-gray-600">${event.dates.length} date${event.dates.length > 1 ? 's' : ''} ‚Ä¢ ${event.roles.length} role${event.roles.length > 1 ? 's' : ''}</p>
                                                </div>
                                                <div class="flex gap-1">
                                                    <button onclick="app.toggleEventVisibility('${event.id}'); app.render();" 
                                                            class="p-2 ${event.visible ? 'text-green-600' : 'text-gray-400'} hover:bg-gray-100 rounded"
                                                            title="${event.visible ? 'Visible on welcome screen' : 'Hidden from welcome screen'}">
                                                        ${event.visible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                                                    </button>
                                                    <button onclick="app.adminView='event-${event.id}'; app.render();" 
                                                            class="p-2 text-blue-600 hover:bg-blue-50 rounded" title="Edit roster">
                                                        üìã
                                                    </button>
                                                    <button onclick="app.editingEvent='${event.id}'; app.render();" 
                                                            class="p-2 text-indigo-600 hover:bg-indigo-50 rounded" title="Edit event">
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button onclick="app.deleteSpecialEvent('${event.id}'); app.render();" 
                                                            class="p-2 text-red-600 hover:bg-red-50 rounded" title="Delete event">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3 space-y-1 text-sm">
                                                <div><strong>Dates:</strong> ${event.dates.slice(0, 3).join(', ')}${event.dates.length > 3 ? '...' : ''}</div>
                                                <div><strong>Roles:</strong> ${event.roles.map(r => r.name).join(', ')}</div>
                                            </div>

                                            ${this.editingEvent === event.id ? `
                                                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
                                                    ${this.renderEventForm(event)}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            },

            renderEventForm(event = null) {
                const isNew = !event;
                const formId = isNew ? 'new' : event.id;
                
                return `
                    <div class="bg-white border-2 border-indigo-200 rounded-lg p-6 mt-4" id="eventForm-${formId}">
                        <h4 class="text-lg font-bold mb-4">${isNew ? 'Create New Event' : 'Edit Event'}</h4>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Event Name *</label>
                                <input type="text" id="eventName-${formId}" value="${event?.name || ''}" 
                                       placeholder="e.g., Christmas Dinner" 
                                       class="w-full p-2 border rounded-lg" />
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-1">Event Date(s) *</label>
                                <div id="eventDates-${formId}" class="space-y-2">
                                  ${event?.dates.map((d, i) => 
    '<div class="flex gap-2">' +
        '<input type="date" value="' + d + '" class="flex-1 p-2 border rounded-lg event-date" />' +
        (event.dates.length > 1 ? '<button onclick="this.parentElement.remove();" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">‚úï</button>' : '') +
    '</div>'
).join('') || `
                                            ${event.dates.length > 1 ? `
                                                <button onclick="this.parentElement.remove();" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">‚úï</button>
                                            ` : ''}
                                        </div>
                                    `).join('') || `
                                        <div class="flex gap-2">
                                            <input type="date" class="flex-1 p-2 border rounded-lg event-date" />
                                        </div>
                                    `}
                                </div>
                                <button onclick="document.getElementById('eventDates-${formId}').insertAdjacentHTML('beforeend', '<div class=\\'flex gap-2\\'><input type=\\'date\\' class=\\'flex-1 p-2 border rounded-lg event-date\\' /><button onclick=\\'this.parentElement.remove();\\' class=\\'px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600\\'>‚úï</button></div>');" 
                                        class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">+ Add another date</button>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2">Roles *</label>
                                <div class="mb-2 flex gap-2">
                                    <button onclick="app.copyRolesTemplate('${formId}', 'thursday'); app.render();" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        Copy from Thursday
                                    </button>
                                    <button onclick="app.copyRolesTemplate('${formId}', 'saturday'); app.render();" class="px-3 py-1 text-sm bg-orange-100 text-orange-700 rounded hover:bg-orange-200">
                                        Copy from Saturday
                                    </button>
                                </div>
                                <div id="eventRoles-${formId}" class="space-y-2">
                                    ${event?.roles.map((r, i) => `
                                        <div class="flex gap-2 items-start p-2 bg-gray-50 rounded">
                                            <div class="flex-1 space-y-1">
                                                <input type="text" value="${r.name}" placeholder="Role name" 
                                                       class="w-full p-1 border rounded text-sm role-name" />
                                                <input type="text" value="${r.time}" placeholder="Time (e.g., 10:00am-2:00pm)" 
                                                       class="w-full p-1 border rounded text-sm role-time" />
                                                <input type="number" value="${r.capacity}" placeholder="Capacity" min="1" 
                                                       class="w-20 p-1 border rounded text-sm role-capacity" />
                                            </div>
                                            <button onclick="this.parentElement.remove();" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">‚úï</button>
                                        </div>
                                    `).join('') || ''}
                                </div>
                                <button onclick="document.getElementById('eventRoles-${formId}').insertAdjacentHTML('beforeend', '<div class=\\'flex gap-2 items-start p-2 bg-gray-50 rounded\\'><div class=\\'flex-1 space-y-1\\'><input type=\\'text\\' placeholder=\\'Role name\\' class=\\'w-full p-1 border rounded text-sm role-name\\' /><input type=\\'text\\' placeholder=\\'Time (e.g., 10:00am-2:00pm)\\' class=\\'w-full p-1 border rounded text-sm role-time\\' /><input type=\\'number\\' placeholder=\\'Capacity\\' min=\\'1\\' class=\\'w-20 p-1 border rounded text-sm role-capacity\\' /></div><button onclick=\\'this.parentElement.remove();\\' class=\\'px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm\\'>‚úï</button></div>');" 
                                        class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">+ Add role</button>
                            </div>

                            <div class="flex gap-2 pt-4">
                                <button onclick="app.saveEventForm('${formId}');" 
                                        class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700">
                                    ${isNew ? 'Create Event' : 'Save Changes'}
                                </button>
                                <button onclick="app.editingEvent=null; app.render();" 
                                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-400">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            copyRolesTemplate(formId, template) {
                const roles = template === 'thursday' ? this.roles['thursday-hall'] : this.roles['saturday-hall'];
                const rolesHtml = roles.filter(r => r.id !== 'giveaway').map(r => `
                    <div class="flex gap-2 items-start p-2 bg-gray-50 rounded">
                        <div class="flex-1 space-y-1">
                            <input type="text" value="${r.name}" placeholder="Role name" 
                                   class="w-full p-1 border rounded text-sm role-name" />
                            <input type="text" value="${r.time}" placeholder="Time" 
                                   class="w-full p-1 border rounded text-sm role-time" />
                            <input type="number" value="${r.capacity}" placeholder="Capacity" min="1" 
                                   class="w-20 p-1 border rounded text-sm role-capacity" />
                        </div>
                        <button onclick="this.parentElement.remove();" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">‚úï</button>
                    </div>
                `).join('');
                
                document.getElementById(`eventRoles-${formId}`).innerHTML = rolesHtml;
            },

            saveEventForm(formId) {
                const name = document.getElementById(`eventName-${formId}`).value.trim();
                if (!name) {
                    alert('Please enter an event name');
                    return;
                }

                const dateInputs = document.querySelectorAll(`#eventDates-${formId} .event-date`);
                const dates = Array.from(dateInputs).map(input => input.value).filter(d => d);
                if (dates.length === 0) {
                    alert('Please add at least one date');
                    return;
                }

                const roleElements = document.querySelectorAll(`#eventRoles-${formId} > div`);
                const roles = Array.from(roleElements).map((el, i) => {
                    const roleName = el.querySelector('.role-name').value.trim();
                    const roleTime = el.querySelector('.role-time').value.trim();
                    const roleCapacity = parseInt(el.querySelector('.role-capacity').value) || 1;
                    
                    if (!roleName) return null;
                    
                    return {
                        id: `role-${i}`,
                        name: roleName,
                        time: roleTime,
                        capacity: roleCapacity
                    };
                }).filter(r => r !== null);

                if (roles.length === 0) {
                    alert('Please add at least one role');
                    return;
                }

                if (formId === 'new') {
                    this.createSpecialEvent(name, dates, roles);
                } else {
                    this.updateSpecialEvent(formId, { name, dates, roles });
                }

                this.editingEvent = null;
                this.render();
            },

            getDatesForView(view) {
                const event = this.specialEvents.find(e => e.id === view);
                if (event) {
                    return event.dates.map(dateStr => {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const date = new Date(year, month - 1, day);
                        return {
                            date: dateStr,
                            label: date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })
                        };
                    });
                }
                
                const savedView = this.currentView;
                this.currentView = view;
                const dates = this.getDatesForPeriod();
                this.currentView = savedView;
                return dates;
            },

            renderAdmin() {
                const stats = this.generateReport();
                
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                             <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Admin Dashboard</h1>
    <div class="flex gap-2">
        <button onclick="event.preventDefault(); app.currentView='welcome'; app.render(); return false;" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">üëÅÔ∏è View as Volunteer</button>
        <button onclick="app.logoutAdmin()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</button>
    </div>
</div>

                                <div class="flex gap-2 mb-6 flex-wrap">
                                    <button onclick="app.adminView='dashboard'; app.render();" class="px-4 py-2 ${this.adminView === 'dashboard' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Dashboard</button>
                                    <button onclick="app.adminView='volunteers'; app.render();" class="px-4 py-2 ${this.adminView === 'volunteers' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Volunteers by Role</button>
                                    <button onclick="app.adminView='special-events'; app.render();" class="px-4 py-2 ${this.adminView === 'special-events' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Special Events</button>
                                    <button onclick="app.adminView='thursday-roster'; app.render();" class="px-4 py-2 ${this.adminView === 'thursday-roster' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Thursday Roster</button>
                                    <button onclick="app.adminView='saturday-roster'; app.render();" class="px-4 py-2 ${this.adminView === 'saturday-roster' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Saturday Roster</button>
                                    <button onclick="app.adminView='weekly-roster'; app.render();" class="px-4 py-2 ${this.adminView === 'weekly-roster' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Additional Tasks</button>
                                    <button onclick="app.adminView='settings'; app.render();" class="px-4 py-2 ${this.adminView === 'settings' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Settings</button>
                                </div>

                                ${this.adminView === 'dashboard' ? `
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        <div class="p-4 bg-blue-50 rounded-lg">
                                            <div class="text-3xl font-bold text-blue-600">${stats.totalSignups}</div>
                                            <div class="text-gray-600">Total Signups</div>
                                        </div>
                                        <div class="p-4 bg-green-50 rounded-lg">
                                            <div class="text-3xl font-bold text-green-600">${stats.volunteerList.size}</div>
                                            <div class="text-gray-600">Unique Volunteers</div>
                                        </div>
                                        <div class="p-4 bg-purple-50 rounded-lg">
                                            <div class="text-3xl font-bold text-purple-600">${stats.topVolunteers[0]?.[1] || 0}</div>
                                            <div class="text-gray-600">Most Signups</div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xl font-bold mb-3">Top Volunteers by Role</h3>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="p-4 bg-blue-50 rounded-lg">
                                                <h4 class="font-bold text-blue-900 mb-3">üëî Top Meal Managers</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.managers.length > 0 ? stats.topByRole.managers.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-blue-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-green-50 rounded-lg">
                                                <h4 class="font-bold text-green-900 mb-3">ü§ù Top Hall Help</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.hallHelp.length > 0 ? stats.topByRole.hallHelp.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-green-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-purple-50 rounded-lg">
                                                <h4 class="font-bold text-purple-900 mb-3">ü•§ Top Drinks Trolley</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.drinks.length > 0 ? stats.topByRole.drinks.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-purple-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-yellow-50 rounded-lg">
                                                <h4 class="font-bold text-yellow-900 mb-3">üçΩÔ∏è Top Dishes</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.dishes.length > 0 ? stats.topByRole.dishes.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-yellow-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-pink-50 rounded-lg">
                                                <h4 class="font-bold text-pink-900 mb-3">üß∫ Top Laundry</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.laundry.length > 0 ? stats.topByRole.laundry.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-pink-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xl font-bold mb-3">By Roster Type</h3>
                                        ${Object.entries(stats.byRoster).map(([type, data]) => `
                                            <div class="mb-3">
                                                <div class="font-bold mb-1">
                                                    ${type === 'thursday-hall' ? 'Thursday Hall' : type === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks'}
                                                    <span class="text-gray-600 font-normal text-sm">(${data.total} signups, ${data.volunteers.size} volunteers)</span>
                                                </div>
                                                <div class="text-sm text-gray-600">
                                                    ${Array.from(data.volunteers).slice(0, 10).join(', ')}${data.volunteers.size > 10 ? '...' : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : this.adminView === 'volunteers' ? `
                                    <div class="space-y-6">
                                    <div class="space-y-6">
                                        <div class="p-4 bg-blue-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-blue-900 mb-3">üëî Managers (${stats.volunteersByRole.managers.size})</h3>
                                            <div class="text-sm text-blue-800">
                                                ${Array.from(stats.volunteersByRole.managers).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-green-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-green-900 mb-3">ü§ù Hall Help (${stats.volunteersByRole.hallHelp.size})</h3>
                                            <div class="text-sm text-green-800">
                                                ${Array.from(stats.volunteersByRole.hallHelp).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-purple-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-purple-900 mb-3">ü•§ Drinks Trolley (${stats.volunteersByRole.drinks.size})</h3>
                                            <div class="text-sm text-purple-800">
                                                ${Array.from(stats.volunteersByRole.drinks).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-yellow-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-yellow-900 mb-3">üçΩÔ∏è Dishes (${stats.volunteersByRole.dishes.size})</h3>
                                            <div class="text-sm text-yellow-800">
                                                ${Array.from(stats.volunteersByRole.dishes).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-pink-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-pink-900 mb-3">üß∫ Laundry (${stats.volunteersByRole.laundry.size})</h3>
                                            <div class="text-sm text-pink-800">
                                                ${Array.from(stats.volunteersByRole.laundry).sort().join(', ') || 'None'}
                                            </div>
                                        </div>
                                    </div>
                                ` : this.adminView === 'special-events' ?
                                    this.renderSpecialEventsManager() :
                                  this.adminView.startsWith('event-') ?
                                    this.renderAdminRoster(this.adminView.replace('event-', '')) :
                                  this.adminView === 'thursday-roster' ? 
                                    this.renderAdminRoster('thursday-hall') :
                                  this.adminView === 'saturday-roster' ? 
                                    this.renderAdminRoster('saturday-hall') :
                                  this.adminView === 'weekly-roster' ? 
                                    this.renderAdminRoster('weekly-tasks') :
                                `
                                    <div class="space-y-4">
                                        <button onclick="app.exportToCSV()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                                            üìä Export to CSV
                                        </button>
                                        <button onclick="app.downloadBackup()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                                            üíæ Download Backup
                                        </button>
                                        <button onclick="app.uploadBackup()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">
                                            üìÇ Upload Backup
                                        </button>
                                        <button onclick="app.addNextQuarter()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                            ‚ûï Add Next Quarter
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        app.init();
    </script>
</body>
</html>

n">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under the Stars Volunteer Roter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .print-full-width { max-width: 100% !important; }
        }
.table-container {
    width: 100%;
    overflow-x: auto !important;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    position: relative;
}

/* Force scrolling on mobile */
@media (max-width: 768px) {
    .table-container {
        overflow-x: scroll !important;
        -webkit-overflow-scrolling: touch;
        display: block !important;
        width: 100vw;
        margin-left: -1rem;
        padding-left: 1rem;
        padding-right: 1rem;
    }
    
    .table-container table {
        width: auto !important;
        min-width: 900px !important;
        display: table !important;
    }
    
    .role-cell {
        min-width: 150px !important;
    }
    
    th, td {
        padding: 0.5rem !important;
        font-size: 0.75rem !important;
    }
}
 .giveaway-disabled {
    background-color: #f9fafb;
    color: #9ca3af;
    font-style: italic;
    text-align: center;
}       
        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .date-past { opacity: 0.4; background-color: #f3f4f6 !important; }
        .date-today { background-color: #fef3c7 !important; border-left: 4px solid #f59e0b; }
        .date-future { }
        .date-next-shift { 
            background: linear-gradient(135deg, #bfdbfe 0%, #dbeafe 100%) !important;
            border: 4px solid #2563eb !important;
            position: relative;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
 .next-shift-badge {
    display: inline-block;
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
    animation: pulse-glow 2s ease-in-out infinite;
    margin-right: 4px;
    white-space: nowrap;
}
        
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        .coverage-excellent { background-color: #dcfce7; }
        .coverage-good { background-color: #fef9c3; }
        .coverage-poor { background-color: #fee2e2; }
        
        .notification-enter {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .edit-mode input {
            width: 100%;
            padding: 2px 4px;
            border: 2px solid #3b82f6;
            border-radius: 4px;
        }
        
        .edit-icon {
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            color: #6b7280;
        }
        
        .volunteer-item:hover .edit-icon {
            opacity: 1;
        }
        
.edit-icon:hover {
            color: #3b82f6;
        }
        
        /* Collapsible month sections */
        .month-section {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .month-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        
        .month-header:hover {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
        }
        
        .month-header .chevron {
            transition: transform 0.3s;
            font-size: 1.5rem;
        }
        
        .month-header.collapsed .chevron {
            transform: rotate(-90deg);
        }
        
        .month-content {
            max-height: 10000px;
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
        
        .month-content.collapsed {
            max-height: 0;
        }

        /* Mobile scroll hint */
        .table-container::after {
            content: '‚Üê Scroll to see all roles ‚Üí';
            position: sticky;
            left: 0;
            bottom: 0;
            width: 100%;
            background: linear-gradient(to top, #4f46e5, transparent);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.75rem;
            font-weight: bold;
            pointer-events: none;
        }

        @media (min-width: 768px) {
            .table-container::after {
                display: none;/* Hide on desktop */
            }
        }
    </style>

       let initErrors = [];
        try {
            if (window.supabaseLoadFailed) {
                throw new Error('Supabase library failed to load');
            }
            if (!window.supabase) {
                throw new Error('Supabase not available');
            }
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('‚úì Supabase initialized successfully');
        } catch (e) {
            console.error('‚ùå Supabase initialization failed:', e);
            initErrors.push('Cloud sync unavailable - using local storage mode');
            useLocalStorage = true;
        }

        const app = {
            currentView: 'welcome',
            selectedPeriod: 'oct-dec-2025',
            showModal: false,
            selectedSlot: null,
            volunteerName: '',
            signups: {},
            specialEvents: [],
            editingEvent: null,
            connectionStatus: 'checking',
            lastSaveTime: null,
            backupCount: 5,
            isInitialized: false,
            isAdmin: false,
            adminView: 'dashboard',
            dateNotes: {},
            giveawayDates: {},
            showMySignups: false,
            searchName: '',
            isLoading: false,
            editingSignup: null,
            collapsedMonths: {},

            periods: [
                { id: 'oct-dec-2025', label: 'October - December 2025', months: [10,11,12], year: 2025 },
                { id: 'jan-mar-2026', label: 'January - March 2026', months: [1,2,3], year: 2026 },
                { id: 'apr-jun-2026', label: 'April - June 2026', months: [4,5,6], year: 2026 },
                { id: 'jul-sep-2026', label: 'July - September 2026', months: [7,8,9], year: 2026 },
                { id: 'oct-dec-2026', label: 'October - December 2026', months: [10,11,12], year: 2026 },
            ],

            roles: {
                'thursday-hall': [
                    { id: 'managers', name: 'Managers', time: '9:45am-1:30pm', capacity: 2 },
                    { id: 'hall-help', name: 'Hall Help', time: '10:00am-1:30pm', capacity: 4 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '11:15am-1:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '11:30am-1:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                    { id: 'giveaway', name: 'Giveaway Table', time: '10:45am-12:45pm', capacity: 2 },
                ],
                'saturday-hall': [
                    { id: 'managers', name: 'Managers', time: '2:45pm-6:30pm', capacity: 2 },
                    { id: 'hall-help-1', name: 'Hall Help - Shift 1', time: '3:15pm-6:30pm', capacity: 3 },
                    { id: 'hall-help-2', name: 'Hall Help - Shift 2', time: '4:30pm-6:30pm (can come earlier)', capacity: 2 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '4:00pm-6:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '4:30pm-6:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                    { id: 'giveaway', name: 'Giveaway Table', time: '3:45pm-5:45pm', capacity: 2 },
                ],
                'weekly-tasks': [
                    { id: 'wed-pickup', name: 'Wed Bakers Delight', time: '~3:45pm', capacity: 1 },
                    { id: 'thurs-pickup', name: 'Thurs Bakers Delight', time: '4:50pm', capacity: 1 },
                    { id: 'cheesecake', name: 'Cheesecake Shop', time: '3-6pm Fri', capacity: 1 },
                ]
            },

            toggleMonth(monthKey) {
                this.collapsedMonths[monthKey] = !this.collapsedMonths[monthKey];
                this.render();
            },

            getVisibleRoles(view) {
                // Check if it's a special event
                const event = this.specialEvents.find(e => e.id === view);
                if (event) {
                    return event.roles;
                }
                
                const allRoles = this.roles[view] || [];
                return allRoles.filter(role => {
                    if (role.id !== 'giveaway') return true;
                    return this.hasAnyGiveaway(view);
                });
            },

            hasAnyGiveaway(view) {
                const dates = this.getDatesForPeriod();
                return dates.some(d => this.isGiveawayEnabled(view, d.date));
            },

            isGiveawayEnabled(view, dateStr) {
                const key = `${view}-${dateStr}`;
                return this.giveawayDates[key] === true;
            },

async toggleGiveaway(view, dateStr) {
    const key = `${view}-${dateStr}`;
    const newValue = !this.giveawayDates[key];
    
    this.createBackup();
    
    this.giveawayDates[key] = newValue;
    
    if (!newValue) {
        if (this.signups[view] && this.signups[view][dateStr] && this.signups[view][dateStr]['giveaway']) {
            const giveawaySignups = this.signups[view][dateStr]['giveaway'];
            
            if (!useLocalStorage && supabase && giveawaySignups.length > 0) {
                for (let signup of giveawaySignups) {
                    if (signup.id) {
                        await supabase.from('volunteer_signups').delete().eq('id', signup.id);
                    }
                }
            }
            
            this.signups[view][dateStr]['giveaway'] = [];
        }
    }
    
    localStorage.setItem('uts-giveaway-dates', JSON.stringify(this.giveawayDates));
    
    if (!useLocalStorage && supabase) {
        try {
            await supabase.from('roster_settings').upsert({
                setting_type: 'giveaway',
                setting_key: key,
                setting_value: newValue ? 'true' : 'false',
                updated_at: new Date().toISOString()
            }, { onConflict: 'setting_type,setting_key' });
        } catch (e) {
            console.error('Error syncing giveaway toggle:', e);
        }
    }
    
    if (useLocalStorage) {
        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
    }
    
    this.showNotification(newValue ? 'Giveaway table enabled' : 'Giveaway table disabled');
    this.render();
},

getNextUpcomingDate(view = null) {
    const targetView = view || this.currentView;
    
    if (targetView === 'weekly-tasks') {
        return null;
    }
    
    const today = new Date();
    today.setHours(0,0,0,0);
    
    const period = this.periods.find(p => p.id === this.selectedPeriod);
    if (!period) {
        return null;
    }
    
    const targetDay = targetView === 'thursday-hall' ? 4 : 6;
    
  const dates = this.getDatesForPeriod();
    
    for (let d of dates) {
        const [year, month, day] = d.date.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        date.setHours(12,0,0,0);
        if (date >= today) {
            return d.date;
        }
    }
    return null;
},

            getDateClass(dateStr) {
    const today = new Date();
    today.setHours(0,0,0,0);
    const [year, month, day] = dateStr.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    date.setHours(0,0,0,0);
    const nextShift = this.getNextUpcomingDate(this.currentView);
    
    if (dateStr === nextShift) return 'date-next-shift';
    if (date < today) return 'date-past';
    if (date.getTime() === today.getTime()) return 'date-today';
    return 'date-future';
},

            getCoverageClass(filled, total) {
                const percentage = (filled / total) * 100;
                if (percentage >= 90) return 'coverage-excellent';
                if (percentage >= 60) return 'coverage-good';
                return 'coverage-poor';
            },

            getMySignups() {
                if (!this.searchName.trim()) {
                    alert('Please enter your name to find your signups');
                    return;
                }
                
                const name = this.searchName.trim().toLowerCase();
                const mySignups = [];
                
                for (let rosterType in this.signups) {
                    for (let dateStr in this.signups[rosterType]) {
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            volunteers.forEach(v => {
                                if (v.name.toLowerCase().includes(name)) {
                                    const role = this.roles[rosterType]?.find(r => r.id === roleId);
                                    const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                                      rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';
                                    const [year, month, day] = dateStr.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    mySignups.push({
                                        date: dateStr,
                                        dateLabel: date.toLocaleDateString('en-NZ', { 
                                            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
                                        }),
                                        roster: rosterName,
                                        role: role?.name || roleId,
                                        time: role?.time || ''
                                    });
                                }
                            });
                        }
                    }
                }
                
                mySignups.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (mySignups.length === 0) {
                    this.showNotification(`No signups found for "${this.searchName}"`, 'warning');
                } else {
                    this.showMySignups = true;
                    this.mySignupsList = mySignups;
                    this.render();
                }
            },

            startEdit(view, dateStr, roleId, signup) {
                this.editingSignup = { view, dateStr, roleId, signup, originalName: signup.name };
                this.render();
            },

            cancelEdit() {
                this.editingSignup = null;
                this.render();
            },

            async saveEdit(newName) {
                if (!newName.trim()) {
                    alert('Name cannot be empty');
                    return;
                }

                const { view, dateStr, roleId, signup } = this.editingSignup;
                
                if (useLocalStorage) {
                    const signupIndex = this.signups[view][dateStr][roleId].indexOf(signup);
                    if (signupIndex !== -1) {
                        this.signups[view][dateStr][roleId][signupIndex].name = newName.trim();
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        this.createBackup();
                        this.showNotification('Name updated successfully!');
                    }
                } else {
                    try {
                        const { error } = await supabase
                            .from('volunteer_signups')
                            .update({ volunteer_name: newName.trim() })
                            .eq('id', signup.id);
                        
                        if (error) throw error;
                        await this.loadSignups();
                        this.showNotification('Name updated successfully!');
                    } catch (e) {
                        this.showNotification('Error updating name', 'error');
                        console.error(e);
                    }
                }
                
                this.editingSignup = null;
                this.render();
            },

            validateData(data) {
                if (!data || typeof data !== 'object') return false;
                for (let rosterType in data) {
                    if (!['thursday-hall', 'saturday-hall', 'weekly-tasks'].includes(rosterType)) continue;
                    const dates = data[rosterType];
                    if (typeof dates !== 'object') return false;
                    for (let date in dates) {
                        const roles = dates[date];
                        if (typeof roles !== 'object') return false;
                        for (let roleId in roles) {
                            const signups = roles[roleId];
                            if (!Array.isArray(signups)) return false;
                            for (let signup of signups) {
                                if (!signup.name || typeof signup.name !== 'string') return false;
                            }
                        }
                    }
                }
                return true;
            },

          async createBackup() {
    try {
        const timestamp = new Date().toISOString();
        const backup = { 
            data: this.signups, 
            timestamp: timestamp, 
            version: '1.0' 
        };
        
        const backups = this.getBackups();
        backups.push(backup);
        if (backups.length > this.backupCount) backups.shift();
        localStorage.setItem('uts-roster-backups', JSON.stringify(backups));
        console.log('Backup created (localStorage):', timestamp);
        
        if (!useLocalStorage && supabase) {
            try {
                const { error } = await supabase.from('roster_backups').insert({
                    backup_data: this.signups,
                    backup_timestamp: timestamp,
                    backup_version: '1.0',
                    created_at: timestamp
                });
                
                if (error) throw error;
                console.log('‚úì Backup also saved to Supabase:', timestamp);
                
                const { data: allBackups } = await supabase
                    .from('roster_backups')
                    .select('id, created_at')
                    .order('created_at', { ascending: false });
                
                if (allBackups && allBackups.length > 20) {
                    const toDelete = allBackups.slice(20).map(b => b.id);
                    await supabase.from('roster_backups').delete().in('id', toDelete);
                    console.log(`üóëÔ∏è Cleaned up ${toDelete.length} old backups from Supabase`);
                }
            } catch (e) {
                console.error('Failed to backup to Supabase (localStorage backup still succeeded):', e);
            }
        }
    } catch (e) {
        console.error('Backup creation failed:', e);
    }
},

            getBackups() {
                try {
                    const stored = localStorage.getItem('uts-roster-backups');
                    if (!stored) return [];
                    const backups = JSON.parse(stored);
                    return Array.isArray(backups) ? backups : [];
                } catch (e) {
                    return [];
                }
            },

        async restoreFromBackup() {
    if (!useLocalStorage && supabase) {
        try {
            const { data, error } = await supabase
                .from('roster_backups')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);
            
            if (!error && data && data.length > 0) {
                for (let backup of data) {
                    if (backup.backup_data && this.validateData(backup.backup_data)) {
                        this.signups = backup.backup_data;
                        console.log('‚úì Restored from Supabase backup:', backup.backup_timestamp);
                        this.showNotification('Restored from cloud backup', 'success');
                        return true;
                    }
                }
            }
        } catch (e) {
            console.error('Failed to restore from Supabase:', e);
        }
    }
    
    const backups = this.getBackups();
    for (let i = backups.length - 1; i >= 0; i--) {
        const backup = backups[i];
        if (backup.data && this.validateData(backup.data)) {
            this.signups = backup.data;
            console.log('Restored from localStorage backup:', backup.timestamp);
            this.showNotification('Restored from local backup', 'warning');
            return true;
        }
    }
    
    console.log('No valid backups found. Starting fresh.');
    this.signups = {};
    return false;
},
      
            showNotification(message, type = 'success') {
                if (this.currentView === 'welcome' && !this.isInitialized) {
                    console.log('Notification suppressed on welcome:', message);
                    return;
                }
                const notif = document.createElement('div');
                notif.className = `notification-enter fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-red-600'
                } text-white font-semibold`;
                notif.textContent = message;
                document.body.appendChild(notif);
     const duration = type === 'success' ? 5000 : 3000;
                setTimeout(() => notif.remove(), duration);
            },

        async init() {
    this.isLoading = true;
    this.render();
    
    await this.checkConnection();
    await this.loadHistoricalData();
    await this.loadSignups();
    await this.loadSpecialEvents();
    await this.loadSettings();
    
    this.isLoading = false;
    this.isInitialized = true;
    this.render();

    if (!useLocalStorage && supabase) {
        supabase.channel('signups').on('postgres_changes', 
            { event: '*', schema: 'public', table: 'volunteer_signups' }, 
            () => this.loadSignups()
        ).subscribe();
        
        supabase.channel('special-events').on('postgres_changes',
            { event: '*', schema: 'public', table: 'special_events' },
            () => this.loadSpecialEvents()
        ).subscribe();
        
        supabase.channel('settings').on('postgres_changes',
            { event: '*', schema: 'public', table: 'roster_settings' },
            () => this.loadSettings()
        ).subscribe();
    }

    setInterval(() => this.autoBackup(), 300000);
    this.createBackup();
    
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.view) {
            this.currentView = event.state.view;
            this.selectedPeriod = event.state.period || this.selectedPeriod;
            this.showMySignups = event.state.showMySignups || false;
            this.isAdmin = event.state.isAdmin || false;
            this.adminView = event.state.adminView || 'dashboard';
            this.render();
        }
    });
    
    history.replaceState({
        view: this.currentView,
        period: this.selectedPeriod,
        isAdmin: this.isAdmin,
        adminView: this.adminView
    }, '', window.location.href);
},
            async checkConnection() {
                if (useLocalStorage) {
                    this.connectionStatus = 'offline';
                    return;
                }
                try {
                    const { error } = await supabase.from('volunteer_signups').select('id').limit(1);
                    this.connectionStatus = error ? 'error' : 'connected';
                } catch (e) {
                    this.connectionStatus = 'error';
                    console.error('Connection check failed:', e);
                }
            },

          async loadHistoricalData() {
    if (!useLocalStorage && supabase) {
        try {
            const { data, error } = await supabase.from('volunteer_signups').select('id').limit(1);
            if (!error && data && data.length > 0) {
                console.log('Historical data already exists in database');
                return;
            }
        } catch (e) {
            console.error('Error checking for existing data:', e);
        }
    }
    
    const hasHistoricalData = localStorage.getItem('uts-historical-loaded-to-supabase');
    if (hasHistoricalData === 'true') {
                    console.log('Historical data already loaded to database');
                    return;
                }

                console.log('Loading historical data to database...');

                if (useLocalStorage) {
                    this.signups = JSON.parse(JSON.stringify(HISTORICAL_DATA));
                    localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                    localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                    console.log('‚úì Historical data loaded to localStorage');
                } else {
                    try {
                        const insertions = [];
                        
                        for (let rosterType in HISTORICAL_DATA) {
                            for (let dateStr in HISTORICAL_DATA[rosterType]) {
                                for (let roleId in HISTORICAL_DATA[rosterType][dateStr]) {
                                    const volunteers = HISTORICAL_DATA[rosterType][dateStr][roleId];
                                    volunteers.forEach(v => {
                                        insertions.push({
                                            roster_type: rosterType,
                                            shift_date: dateStr,
                                            role_id: roleId,
                                            volunteer_name: v.name
                                        });
                                    });
                                }
                            }
                        }

                        console.log(`Inserting ${insertions.length} historical signups...`);
                        
                        const batchSize = 50;
                        for (let i = 0; i < insertions.length; i += batchSize) {
                            const batch = insertions.slice(i, i + batchSize);
                            const { error } = await supabase.from('volunteer_signups').insert(batch);
                            if (error) throw error;
                            console.log(`Inserted batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(insertions.length/batchSize)}`);
                        }

                        localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                        console.log('‚úì Historical data loaded to Supabase successfully!');
                        
                    } catch (e) {
                        console.error('Error loading historical data to Supabase:', e);
                        this.signups = JSON.parse(JSON.stringify(HISTORICAL_DATA));
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                        console.log('‚úì Historical data loaded to localStorage (fallback)');
                    }
                }

                this.createBackup();
            },

            autoBackup() {
                try {
                    if (!this.validateData(this.signups)) {
                        console.error('Data validation failed - backup skipped');
                        return;
                    }
                    this.createBackup();
                } catch (e) {
                    console.error('Auto-backup failed:', e);
                }
            },

getDayOfWeek(dateStr) {
    const [year, month, day] = dateStr.split('-').map(Number);
    
    let m = month;
    let y = year;
    
    if (m < 3) {
        m += 12;
        y--;
    }
    
    const q = day;
    const K = y % 100;
    const J = Math.floor(y / 100);
    
    const h = (q + Math.floor((13 * (m + 1)) / 5) + K + Math.floor(K / 4) + Math.floor(J / 4) - (2 * J)) % 7;
    
    return (h + 6) % 7;
},

getDatesForPeriod() {
    const period = this.periods.find(p => p.id === this.selectedPeriod);
    if (!period) return [];
    const dates = [];
    
    if (this.currentView === 'weekly-tasks') {
        const targetDay = 3;
        period.months.forEach(month => {
            for (let day = 1; day <= 31; day++) {
                const dateStr = `${period.year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const testDate = new Date(period.year, month - 1, day);
                if (testDate.getMonth() !== month - 1) break;
                
                if (this.getDayOfWeek(dateStr) === targetDay) {
                    const wed = new Date(period.year, month - 1, day);
                    const thurs = new Date(period.year, month - 1, day + 1);
                    
                    dates.push({
                        date: dateStr,
                        label: `${wed.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })} - ${thurs.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })}`
                    });
                }
            }
        });
    } else {
        const targetDay = this.currentView === 'thursday-hall' ? 4 : 6;
        period.months.forEach(month => {
            for (let day = 1; day <= 31; day++) {
                const dateStr = `${period.year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const testDate = new Date(period.year, month - 1, day);
                if (testDate.getMonth() !== month - 1) break;
                
                if (this.getDayOfWeek(dateStr) === targetDay) {
                    const date = new Date(period.year, month - 1, day);
                    dates.push({
                        date: dateStr,
                        label: date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })
                    });
                }
            }
        });
    }
    return dates;
},
        async loadSignups() {
    if (useLocalStorage) {
        const saved = localStorage.getItem('uts-roster');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                if (this.validateData(parsed)) {
                    this.signups = parsed;
                    this.createBackup();
                } else {
                    console.error('Loaded data is corrupted. Attempting recovery...');
                    this.restoreFromBackup();
                }
            } catch (e) {
                console.error('Error parsing data:', e);
                this.restoreFromBackup();
            }
        }
        const savedNotes = localStorage.getItem('uts-date-notes');
        if (savedNotes) {
            try {
                this.dateNotes = JSON.parse(savedNotes);
            } catch (e) {
                this.dateNotes = {};
            }
        }
        const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
        if (savedGiveaway) {
            try {
                this.giveawayDates = JSON.parse(savedGiveaway);
            } catch (e) {
                this.giveawayDates = {};
            }
        }
        const savedEvents = localStorage.getItem('uts-special-events');
        if (savedEvents) {
            try {
                this.specialEvents = JSON.parse(savedEvents);
            } catch (e) {
                this.specialEvents = [];
            }
        }
    } else {
        let retries = 3;
        while (retries > 0) {
            try {
                let allData = [];
                let from = 0;
                const pageSize = 1000;
                
                let maxPages = 100;
                
                while (maxPages > 0) {
                    maxPages--;
                    
                    const { data, error } = await supabase
                        .from('volunteer_signups')
                        .select('*')
                        .range(from, from + pageSize - 1);
                        
                    if (error) throw error;
                    if (!data || data.length === 0) break;
                    
                    allData = allData.concat(data);
                    if (data.length < pageSize) break;
                    from += pageSize;
                }
                
                if (maxPages === 0) {
                    console.warn('‚ö†Ô∏è Hit pagination safety limit! You may have incomplete data.');
                    this.showNotification('Warning: Large dataset detected', 'warning');
                }
                
                console.log('üì• Loaded from Supabase:', allData.length, 'signups (ALL data)');
                
                this.signups = {};
                allData.forEach(s => {
                    if (!this.signups[s.roster_type]) this.signups[s.roster_type] = {};
                    if (!this.signups[s.roster_type][s.shift_date]) this.signups[s.roster_type][s.shift_date] = {};
                    if (!this.signups[s.roster_type][s.shift_date][s.role_id]) this.signups[s.roster_type][s.shift_date][s.role_id] = [];
                    this.signups[s.roster_type][s.shift_date][s.role_id].push({
                        id: s.id,
                        name: s.volunteer_name
                    });
                });
                
                if (!this.validateData(this.signups)) {
                    throw new Error('Loaded data failed validation');
                }
                this.connectionStatus = 'connected';
                this.lastSaveTime = new Date();
                this.createBackup();
                break;
            } catch (e) {
                retries--;
                if (retries === 0) {
                    console.error('Load failed after retries:', e);
                    this.connectionStatus = 'error';
                    this.restoreFromBackup();
                } else {
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }
        const savedNotes = localStorage.getItem('uts-date-notes');
        if (savedNotes) {
            try {
                this.dateNotes = JSON.parse(savedNotes);
            } catch (e) {
                this.dateNotes = {};
            }
        }
        const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
        if (savedGiveaway) {
            try {
                this.giveawayDates = JSON.parse(savedGiveaway);
            } catch (e) {
                this.giveawayDates = {};
            }
        }
        const savedEvents = localStorage.getItem('uts-special-events');
        if (savedEvents) {
            try {
                this.specialEvents = JSON.parse(savedEvents);
            } catch (e) {
                this.specialEvents = [];
            }
        }
    }
    if (this.isInitialized) {
        this.render();
    }
},

            async loadSpecialEvents() {
                if (useLocalStorage) {
                    const savedEvents = localStorage.getItem('uts-special-events');
                    if (savedEvents) {
                        try {
                            this.specialEvents = JSON.parse(savedEvents);
                        } catch (e) {
                            console.error('Error parsing special events:', e);
                            this.specialEvents = [];
                        }
                    }
                } else {
                    try {
                        const { data, error } = await supabase.from('special_events').select('*');
                        if (error) throw error;
                        
                        this.specialEvents = (data || []).map(e => ({
                            id: e.id,
                            name: e.name,
                            dates: e.dates,
                            roles: e.roles,
                            visible: e.visible,
                            created: e.created_at
                        }));
                        
                        localStorage.setItem('uts-special-events', JSON.stringify(this.specialEvents));
                    } catch (e) {
                        console.error('Error loading special events from Supabase:', e);
                        const savedEvents = localStorage.getItem('uts-special-events');
                        if (savedEvents) {
                            try {
                                this.specialEvents = JSON.parse(savedEvents);
                            } catch (e2) {
                                this.specialEvents = [];
                            }
                        }
                    }
                }
                if (this.isInitialized) {
                    this.render();
                }
            },

            async loadSettings() {
                if (useLocalStorage) {
                    const savedNotes = localStorage.getItem('uts-date-notes');
                    if (savedNotes) {
                        try {
                            this.dateNotes = JSON.parse(savedNotes);
                        } catch (e) {
                            this.dateNotes = {};
                        }
                    }
                    const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
                    if (savedGiveaway) {
                        try {
                            this.giveawayDates = JSON.parse(savedGiveaway);
                        } catch (e) {
                            this.giveawayDates = {};
                        }
                    }
                } else {
                    try {
                        const { data, error } = await supabase.from('roster_settings').select('*');
                        if (error) throw error;
                        
                        this.dateNotes = {};
                        this.giveawayDates = {};
                        
                        data.forEach(setting => {
                            if (setting.setting_type === 'note') {
                                this.dateNotes[setting.setting_key] = setting.setting_value;
                            } else if (setting.setting_type === 'giveaway') {
                                this.giveawayDates[setting.setting_key] = setting.setting_value === 'true';
                            }
                        });
                        
                        localStorage.setItem('uts-date-notes', JSON.stringify(this.dateNotes));
                        localStorage.setItem('uts-giveaway-dates', JSON.stringify(this.giveawayDates));
                    } catch (e) {
                        console.error('Error loading settings from Supabase:', e);
                        const savedNotes = localStorage.getItem('uts-date-notes');
                        if (savedNotes) {
                            try {
                                this.dateNotes = JSON.parse(savedNotes);
                            } catch (e2) {
                                this.dateNotes = {};
                            }
                        }
                        const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
                        if (savedGiveaway) {
                            try {
                                this.giveawayDates = JSON.parse(savedGiveaway);
                            } catch (e2) {
                                this.giveawayDates = {};
                            }
                        }
                    }
                    
                    const savedPeriod = localStorage.getItem('uts-selected-period');
                    if (savedPeriod) {
                        this.selectedPeriod = savedPeriod;
                    }
                }
                if (this.isInitialized) {
                    this.render();
                }
            },

            async saveSpecialEvents() {
                localStorage.setItem('uts-special-events', JSON.stringify(this.specialEvents));
                
                if (!useLocalStorage && supabase) {
                    try {
                        await supabase.from('special_events').delete().neq('id', '');
                        
                        if (this.specialEvents.length > 0) {
                            const eventsToInsert = this.specialEvents.map(e => ({
                                id: e.id,
                                name: e.name,
                                dates: e.dates,
                                roles: e.roles,
                                visible: e.visible,
                                created_at: e.created,
                                updated_at: new Date().toISOString()
                            }));
                            
                            const { error } = await supabase.from('special_events').insert(eventsToInsert);
                            if (error) throw error;
                        }
                        console.log('‚úì Special events synced to Supabase');
                    } catch (e) {
                        console.error('Error syncing special events:', e);
                        this.showNotification('Saved locally (offline mode)', 'warning');
                    }
                }
                
       this.createBackup();
            },

            async createSpecialEvent(name, dates, roles, visible = true) {
                const event = {
                    id: Date.now().toString(),
                    name: name.trim(),
                    dates: dates,
                    roles: roles,
                    visible: visible,
                    created: new Date().toISOString()
                };
                this.specialEvents.push(event);
                
                this.signups[event.id] = {};
                dates.forEach(dateStr => {
                    this.signups[event.id][dateStr] = {};
                    roles.forEach(role => {
                        this.signups[event.id][dateStr][role.id] = [];
                    });
                });
                
                await this.saveSpecialEvents();
                localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                this.showNotification(`Event "${name}" created!`);
                return event.id;
            },

            async updateSpecialEvent(eventId, updates) {
                const eventIndex = this.specialEvents.findIndex(e => e.id === eventId);
                if (eventIndex === -1) return;
                
                this.specialEvents[eventIndex] = { ...this.specialEvents[eventIndex], ...updates };
                await this.saveSpecialEvents();
                this.showNotification('Event updated!');
            },

            async deleteSpecialEvent(eventId) {
                const event = this.specialEvents.find(e => e.id === eventId);
                if (!event) return;
                
                if (!confirm(`Delete event "${event.name}"? This will remove all volunteer signups for this event.`)) return;
                
                this.specialEvents = this.specialEvents.filter(e => e.id !== eventId);
                
                delete this.signups[eventId];
                
                await this.saveSpecialEvents();
                localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                this.showNotification('Event deleted');
            },

            async toggleEventVisibility(eventId) {
                const event = this.specialEvents.find(e => e.id === eventId);
                if (!event) return;
                
                event.visible = !event.visible;
                await this.saveSpecialEvents();
                this.showNotification(event.visible ? 'Event visible on welcome screen' : 'Event hidden from welcome screen');
            },

            async saveNote(view, dateStr, note) {
                const key = `${view}-${dateStr}`;
                if (note.trim()) {
                    this.dateNotes[key] = note.trim();
                } else {
                    delete this.dateNotes[key];
                }
                
                localStorage.setItem('uts-date-notes', JSON.stringify(this.dateNotes));
                
                if (!useLocalStorage && supabase) {
                    try {
                        if (note.trim()) {
                            await supabase.from('roster_settings').upsert({
                                setting_type: 'note',
                                setting_key: key,
                                setting_value: note.trim(),
                                updated_at: new Date().toISOString()
                            }, { onConflict: 'setting_type,setting_key' });
                        } else {
                            await supabase.from('roster_settings').delete()
                                .eq('setting_type', 'note')
                                .eq('setting_key', key);
                        }
                    } catch (e) {
                        console.error('Error syncing note:', e);
                    }
                }
                
                this.showNotification('Note saved');
            },

            getNote(view, dateStr) {
                const key = `${view}-${dateStr}`;
                return this.dateNotes[key] || '';
            },
async addSignup() {
    if (!this.volunteerName.trim()) return alert('Please enter your name');
    const { view, dateStr, roleId } = this.selectedSlot;
    
    const role = this.getVisibleRoles(view).find(r => r.id === roleId);
    const currentSignups = this.getSignups(view, dateStr, roleId);
    
    if (currentSignups.length >= role.capacity) {
        const override = confirm(`‚ö†Ô∏è This role is at full capacity (${role.capacity}/${role.capacity}).\n\nDo you want to add an extra volunteer anyway?`);
        if (!override) {
            return;
        }
    }
    
    const originalSignups = JSON.parse(JSON.stringify(this.signups));

    if (useLocalStorage) {
        try {
            if (!this.signups[view]) this.signups[view] = {};
            if (!this.signups[view][dateStr]) this.signups[view][dateStr] = {};
            if (!this.signups[view][dateStr][roleId]) this.signups[view][dateStr][roleId] = [];
            this.signups[view][dateStr][roleId].push({ name: this.volunteerName.trim() });
            if (!this.validateData(this.signups)) {
                throw new Error('Data validation failed');
            }
            localStorage.setItem('uts-roster', JSON.stringify(this.signups));
            this.createBackup();
            this.showNotification('‚úì Signed up successfully!');
        } catch (e) {
            console.error('Error during signup:', e);
            this.signups = originalSignups;
            this.showNotification('Error signing up: ' + e.message, 'error');
            return;
        }
    } else {
        let retries = 3;
        while (retries > 0) {
            try {
                const { data, error } = await supabase.from('volunteer_signups').insert({
                    roster_type: view,
                    shift_date: dateStr,
                    role_id: roleId,
                    volunteer_name: this.volunteerName.trim()
                }).select();
                if (error) throw error;
                await this.loadSignups();
                this.showNotification('‚úì Signed up successfully!');
                break;
            } catch (e) {
                retries--;
                if (retries === 0) {
                    this.showNotification('Error signing up. Please try again.', 'error');
                    return;
                }
                await new Promise(r => setTimeout(r, 1000));
            }
        }
    }
    this.showModal = false;
    this.volunteerName = '';
    this.render();
},

async removeSignup(view, dateStr, roleId, signup) {
    if (!confirm(`Remove ${signup.name}?`)) return;
    const originalSignups = JSON.parse(JSON.stringify(this.signups));
    
    this.createBackup();

    if (useLocalStorage) {
        try {
            this.signups[view][dateStr][roleId] = this.signups[view][dateStr][roleId].filter(s => {
                if (signup.id) {
                    return s.id !== signup.id;
                } else {
                    return s.name !== signup.name;
                }
            });
            
            if (!this.validateData(this.signups)) {
                throw new Error('Data validation failed');
            }
            localStorage.setItem('uts-roster', JSON.stringify(this.signups));
            this.createBackup();
            this.showNotification('‚úì Removed successfully');
        } catch (e) {
            this.signups = originalSignups;
            this.showNotification('Error removing: ' + e.message, 'error');
            return;
        }
    } else {
        let retries = 3;
        while (retries > 0) {
            try {
                const { error } = await supabase.from('volunteer_signups').delete().eq('id', signup.id);
                if (error) throw error;
                await this.loadSignups();
                this.showNotification('‚úì Removed successfully');
                break;
            } catch (e) {
                retries--;
                if (retries === 0) {
                    this.showNotification('Error removing. Please try again.', 'error');
                    return;
                }
                await new Promise(r => setTimeout(r, 1000));
            }
        }
    }
    this.render();
},

            getSignups(view, dateStr, roleId) {
                return this.signups[view]?.[dateStr]?.[roleId] || [];
            },

            getNextShiftStats() {
    // Don't show next shift for weekly tasks or special events
    if (this.currentView === 'weekly-tasks') return null;
    
    // Check if it's a special event (not thursday-hall or saturday-hall)
    if (this.currentView !== 'thursday-hall' && this.currentView !== 'saturday-hall') {
        return null;
    }
    
    const nextDate = this.getNextUpcomingDate(this.currentView);
    if (!nextDate) return null;
    
    const roles = this.getVisibleRoles(this.currentView);
    let totalSlots = 0;
    let filledSlots = 0;
roles.forEach(role => {
    if (role.id === 'giveaway' && !this.isGiveawayEnabled(this.currentView, nextDate)) {
        return;
    }
    
    const signups = this.getSignups(this.currentView, nextDate, role.id);
    totalSlots += role.capacity;
    filledSlots += Math.min(signups.length, role.capacity);
});

const [year, month, day] = nextDate.split('-').map(Number);
const date = new Date(year, month - 1, day);
const dateLabel = date.toLocaleDateString('en-NZ', { 
    weekday: 'long', day: 'numeric', month: 'long'
});

return { 
    totalSlots, 
    filledSlots, 
    coverage: Math.round((filledSlots / totalSlots) * 100),
    dateLabel,
    needsHelp: totalSlots - filledSlots
};
},

            getRosterStats() {
                const dates = this.getDatesForPeriod();
                const roles = this.getVisibleRoles(this.currentView);
                let totalSlots = 0;
                let filledSlots = 0;
                let needsHelp = 0;
                
                dates.forEach(d => {
                    roles.forEach(role => {
                        const signups = this.getSignups(this.currentView, d.date, role.id);
                        totalSlots += role.capacity;
                        filledSlots += Math.min(signups.length, role.capacity);
                        if (signups.length < role.capacity) needsHelp++;
                    });
                });
                
                return { totalSlots, filledSlots, needsHelp, coverage: Math.round((filledSlots / totalSlots) * 100) };
            },

         loginAdmin() {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    this.isAdmin = true;
                    this.currentView = 'admin';
                    this.pushState();
                    this.render();
                } else if (password !== null) {
                    alert('Incorrect password');
                }
            },

       logoutAdmin() {
                this.isAdmin = false;
                this.currentView = 'welcome';
                this.pushState();
                this.render();
            },

            addNextQuarter() {
                const lastPeriod = this.periods[this.periods.length - 1];
                const lastYear = lastPeriod.year;
                const lastMonths = lastPeriod.months;
                const lastMonth = lastMonths[lastMonths.length - 1];
                
                let newYear = lastYear;
                let newMonths = [];
                let startMonth = lastMonth + 1;
                
                if (startMonth > 12) {
                    startMonth = 1;
                    newYear++;
                }
                
                for (let i = 0; i < 3; i++) {
                    let month = startMonth + i;
                    if (month > 12) {
                        month = month - 12;
                        newYear = lastYear + 1;
                    }
                    newMonths.push(month);
                }
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const label = `${monthNames[newMonths[0]-1]} - ${monthNames[newMonths[2]-1]} ${newYear}`;
                const id = `${monthNames[newMonths[0]-1].toLowerCase()}-${monthNames[newMonths[2]-1].toLowerCase()}-${newYear}`;
                
                this.periods.push({
                    id: id,
                    label: label,
                    months: newMonths,
                    year: newYear
                });
                
                this.showNotification(`Added quarter: ${label}`, 'success');
                this.render();
            },

            exportToCSV() {
                const rows = [['Date', 'Day', 'Roster Type', 'Role', 'Time', 'Volunteer', 'Capacity']];
                
                for (let rosterType in this.signups) {
                    const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                      rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';
                    
                    for (let dateStr in this.signups[rosterType]) {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const date = new Date(year, month - 1, day);
                        const dayName = date.toLocaleDateString('en-NZ', { weekday: 'long' });
                        const dateLabel = date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short', year: 'numeric' });
                        
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const role = this.roles[rosterType]?.find(r => r.id === roleId);
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            
                            if (volunteers.length === 0) {
                                rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', '(empty)', role?.capacity || '']);
                            } else {
                                volunteers.forEach(v => {
                                    rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', v.name, role?.capacity || '']);
                                });
                            }
                        }
                    }
                }
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-roster-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('CSV exported successfully!');
            },

            generateReport() {
                const stats = {
                    totalSignups: 0,
                    volunteerList: new Set(),
                    byRoster: {},
                    coverageByDate: {},
                    volunteerCounts: {},
                    volunteersByRole: {
                        managers: new Set(),
                        hallHelp: new Set(),
                        drinks: new Set(),
                        dishes: new Set(),
                        laundry: new Set()
                    },
                    volunteerCountsByRole: {
                        managers: {},
                        hallHelp: {},
                        drinks: {},
                        dishes: {},
                        laundry: {}
                    }
                };
                
                for (let rosterType in this.signups) {
                    stats.byRoster[rosterType] = { total: 0, volunteers: new Set() };
                    
                    for (let dateStr in this.signups[rosterType]) {
                        if (!stats.coverageByDate[dateStr]) {
                            stats.coverageByDate[dateStr] = { filled: 0, total: 0 };
                        }
                        
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const role = this.roles[rosterType]?.find(r => r.id === roleId);
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            
                            stats.totalSignups += volunteers.length;
                            stats.byRoster[rosterType].total += volunteers.length;
                            stats.coverageByDate[dateStr].filled += volunteers.length;
                            stats.coverageByDate[dateStr].total += role?.capacity || 1;
                            
                            volunteers.forEach(v => {
                                const fullName = v.name.trim();
                                stats.volunteerList.add(fullName);
                                stats.byRoster[rosterType].volunteers.add(fullName);
                                
                                if (!stats.volunteerCounts[fullName]) {
                                    stats.volunteerCounts[fullName] = 0;
                                }
                                stats.volunteerCounts[fullName]++;
                                
                                if (roleId === 'managers') {
                                    stats.volunteersByRole.managers.add(fullName);
                                    if (!stats.volunteerCountsByRole.managers[fullName]) {
                                        stats.volunteerCountsByRole.managers[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.managers[fullName]++;
                                } else if (roleId.includes('hall-help')) {
                                    stats.volunteersByRole.hallHelp.add(fullName);
                                    if (!stats.volunteerCountsByRole.hallHelp[fullName]) {
                                        stats.volunteerCountsByRole.hallHelp[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.hallHelp[fullName]++;
                                } else if (roleId === 'drinks') {
                                    stats.volunteersByRole.drinks.add(fullName);
                                    if (!stats.volunteerCountsByRole.drinks[fullName]) {
                                        stats.volunteerCountsByRole.drinks[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.drinks[fullName]++;
                                } else if (roleId === 'dishes') {
                                    stats.volunteersByRole.dishes.add(fullName);
                                    if (!stats.volunteerCountsByRole.dishes[fullName]) {
                                        stats.volunteerCountsByRole.dishes[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.dishes[fullName]++;
                                } else if (roleId === 'laundry') {
                                    stats.volunteersByRole.laundry.add(fullName);
                                    if (!stats.volunteerCountsByRole.laundry[fullName]) {
                                        stats.volunteerCountsByRole.laundry[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.laundry[fullName]++;
                                }
                            });
                        }
                    }
                }
                
                stats.topVolunteers = Object.entries(stats.volunteerCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                stats.topByRole = {
                    managers: Object.entries(stats.volunteerCountsByRole.managers)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    hallHelp: Object.entries(stats.volunteerCountsByRole.hallHelp)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    drinks: Object.entries(stats.volunteerCountsByRole.drinks)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    dishes: Object.entries(stats.volunteerCountsByRole.dishes)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    laundry: Object.entries(stats.volunteerCountsByRole.laundry)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10)
                };
                
                return stats;
            },

            downloadBackup() {
                const backup = {
                    data: this.signups,
                    periods: this.periods,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Backup downloaded!');
            },

            uploadBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            if (backup.data && this.validateData(backup.data)) {
                                this.signups = backup.data;
                                if (backup.periods && Array.isArray(backup.periods)) {
                                    this.periods = backup.periods;
                                }
                                this.createBackup();
                                this.showNotification('Backup restored successfully!');
                                this.render();
                            } else {
                                throw new Error('Invalid backup file');
                            }
                        } catch (e) {
                            this.showNotification('Error loading backup: ' + e.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

navigateTo(view, extraState = {}) {
    this.currentView = view;
    Object.assign(this, extraState);
    this.pushState();
    this.render();
},

pushState() {
    const state = {
        view: this.currentView,
        period: this.selectedPeriod,
        showMySignups: this.showMySignups,
        isAdmin: this.isAdmin,
        adminView: this.adminView
    };
    
    const title = this.currentView === 'welcome' ? 'Under the Stars - Home' :
                 this.currentView === 'admin' ? 'Under the Stars - Admin' :
                 this.currentView === 'thursday-hall' ? 'Thursday Hall Help' :
                 this.currentView === 'saturday-hall' ? 'Saturday Hall Help' :
                 'Under the Stars';
    
    history.pushState(state, title, window.location.pathname);
},
            render() {
                const appEl = document.getElementById('app');
                
                if (this.isLoading) {
                    appEl.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center">
                            <div class="text-center">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-600">Loading roster...</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                if (this.showMySignups) {
                    appEl.innerHTML = this.renderMySignups();
                } else if (this.currentView === 'welcome') {
                    appEl.innerHTML = this.renderWelcome();
                } else if (this.currentView === 'admin') {
                    appEl.innerHTML = this.renderAdmin();
                } else {
                    appEl.innerHTML = this.renderRoster();
                }
            },

            renderMySignups() {
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-bold">My Signups: ${this.searchName}</h2>
                                    <button onclick="app.showMySignups=false; app.render();" class="text-gray-600 hover:text-gray-800">‚úï Close</button>
                                </div>
                                
                                ${this.mySignupsList.length === 0 ? `
                                    <p class="text-gray-600">No signups found.</p>
                                ` : `
                                    <div class="space-y-3">
                                        ${this.mySignupsList.map(s => `
                                            <div class="p-4 border rounded-lg ${this.getDateClass(s.date)}">
                                                <div class="font-bold text-lg mb-1">${s.dateLabel}</div>
                                                <div class="text-sm text-gray-700">
                                                    <span class="font-semibold">${s.roster}</span> - ${s.role}
                                                    ${s.time ? `<span class="text-gray-500"> (${s.time})</span>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                                
                                <button onclick="app.showMySignups=false; app.render();" class="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                    Back to Roster
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderWelcome() {
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-8">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-12 h-12 text-pink-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                        <div>
                                            <h1 class="text-4xl font-bold">Under the Stars</h1>
                                            <p class="text-xl text-gray-600">Meal Rosters</p>
                                        </div>
                                    </div>
                                    <button onclick="app.loginAdmin()" class="text-gray-400 hover:text-gray-600 text-sm">Admin</button>
                                </div>

                                <div class="mb-8 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                                    <h3 class="font-bold text-indigo-900 mb-2">üìÖ Choose your time period:</h3>
                                    <select onchange="app.selectedPeriod=this.value; localStorage.setItem('uts-selected-period', this.value); app.render();" 
                                            class="w-full p-3 border-2 border-indigo-300 rounded-lg text-lg font-semibold bg-white">
                                        ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                                    </select>
                                </div>

                                <div class="mb-8 text-gray-700 space-y-4">
                                    <p class="text-lg">Welcome! üòä</p>
                                    <p>Thanks for volunteering! We ask volunteers give their time once a month. Don't burn yourself out - we want you around for the long haul! üôÇ</p>
                                    
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h3 class="font-bold text-blue-900 mb-2">To sign up:</h3>
                                        <ol class="list-decimal list-inside space-y-1 text-blue-800">
                                            <li>Choose your preferred day and task below</li>
                                            <li>Find an available date and enter your name</li>
                                            <li><strong>If anything changes, please notify the operations coordinator at <a href="mailto:operations@underthestars.org.nz" class="underline">operations@underthestars.org.nz</a> as soon as possible</strong></li>
                                        </ol>
                                    </div>
                                    
                                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                                        <h3 class="font-bold text-green-900 mb-2">Find Your Signups:</h3>
                                        <div class="flex gap-2">
                                            <input 
                                                type="text" 
                                                placeholder="Enter your name" 
                                                id="searchNameInput"
                                                class="flex-1 px-4 py-2 border rounded-lg"
                                                onkeypress="if(event.key==='Enter'){app.searchName=this.value; app.getMySignups();}"
                                            />
                                            <button onclick="app.searchName=document.getElementById('searchNameInput').value; app.getMySignups();" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700">
                                                Search
                                            </button>
                                        </div>
                                    </div>

                                    <p><strong>Meal Managers:</strong> Ani Stace, Carol Machaj, Keiran Stuart, Carl Fenton, Rose Kent-Wilson, Adrian De Souza</p>
                                    <p><strong>Venue:</strong> Cliff Rd community hall, 45 Cliff Rd</p>
                                    <p class="text-sm">*Long hair tied back. Closed toe shoes required.</p>
                                </div>

                             <div class="space-y-3">
    <button onclick="app.navigateTo('thursday-hall');" 
            class="w-full bg-blue-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-blue-700 transition-colors">
        Thursday Hall Help ‚Üí
    </button>
    
    <button onclick="app.navigateTo('saturday-hall');" 
            class="w-full bg-orange-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-orange-700 transition-colors">
        Saturday Hall Help ‚Üí
    </button>
    
    <button onclick="app.navigateTo('weekly-tasks');" 
            class="w-full bg-pink-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-pink-700 transition-colors">
        Additional Weekly Tasks ‚Üí
    </button>
    
    ${this.specialEvents.filter(e => e.visible).map(event => `
        <button onclick="app.navigateTo('${event.id}');"
                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-lg font-bold text-xl hover:from-purple-700 hover:to-pink-700 transition-colors">
            ${event.name} ‚Üí
        </button>
    `).join('')}
</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderRoster() {
                const specialEvent = this.specialEvents.find(e => e.id === this.currentView);
                const isSpecialEvent = !!specialEvent;
                
                const currentPeriod = this.periods.find(p => p.id === this.selectedPeriod);
                const dates = isSpecialEvent ? this.getDatesForView(this.currentView) : this.getDatesForPeriod();
                const roles = this.getVisibleRoles(this.currentView);
                const stats = this.getRosterStats();
                const nextShiftStats = this.getNextShiftStats();
                const nextShiftDate = this.getNextUpcomingDate();

                const viewTitle = isSpecialEvent ? specialEvent.name :
                                 this.currentView === 'thursday-hall' ? 'Thursday Hall Help' : 
                                 this.currentView === 'saturday-hall' ? 'Saturday Hall Help' : 'Additional Weekly Tasks';

                // Group dates by month
                const datesByMonth = {};
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let currentMonthKey = null;

                dates.forEach(d => {
                    const [year, month, day] = d.date.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    date.setHours(0, 0, 0, 0);
                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                    const monthName = date.toLocaleDateString('en-NZ', { month: 'long', year: 'numeric' });
                    
                    if (!datesByMonth[monthKey]) {
                        datesByMonth[monthKey] = {
                            name: monthName,
                            dates: [],
                            containsToday: false
                        };
                    }
                    
                    datesByMonth[monthKey].dates.push(d);
                    
                    if (date.getTime() === today.getTime()) {
                        datesByMonth[monthKey].containsToday = true;
                        currentMonthKey = monthKey;
                    }
                });

                // If no current month found, find the next upcoming month
                if (!currentMonthKey) {
                    for (let monthKey in datesByMonth) {
                        const firstDateStr = datesByMonth[monthKey].dates[0].date;
                        const [y, m, d] = firstDateStr.split('-').map(Number);
                        const firstDate = new Date(y, m - 1, d);
                        if (firstDate >= today) {
                            currentMonthKey = monthKey;
                            break;
                        }
                    }
                }

                // Set collapsed state for months
                if (!this.collapsedMonths) this.collapsedMonths = {};
                for (let monthKey in datesByMonth) {
                    if (this.collapsedMonths[monthKey] === undefined) {
                        this.collapsedMonths[monthKey] = (monthKey !== currentMonthKey);
                    }
                }

                return `
                    <div class="min-h-screen p-2 md:p-4 print-full-width">
                        <div class="max-w-7xl mx-auto">
                            ${this.connectionStatus === 'connected' ? `
                                <div class="mb-4 p-3 bg-green-100 text-green-800 rounded-lg text-sm">
                                    ‚úì Connected - Changes sync across all devices
                                </div>
                            ` : this.connectionStatus === 'error' ? `
                                <div class="mb-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg text-sm">
                                    ‚ö†Ô∏è Working offline - Using local storage
                                </div>
                            ` : ''}

                            <div class="bg-white rounded-lg shadow-xl p-4 md:p-6 mb-6 no-print">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                    <div>
                                        <h1 class="text-2xl md:text-3xl font-bold mb-1">${viewTitle}</h1>
                                        ${!isSpecialEvent ? `<p class="text-gray-600">${currentPeriod.label}</p>` : `<p class="text-gray-600">Special Event</p>`}
                                    </div>
                                    <div class="flex gap-2">
                                <button onclick="app.isAdmin && app.currentView.startsWith('event-') ? app.navigateTo('admin', {adminView: 'special-events'}) : app.navigateTo('welcome');" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">‚Üê Back</button>
                                        <button onclick="window.print()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Print</button>
                                    </div>
                                </div>

                                ${nextShiftStats ? `
                                    <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border-2 border-blue-300">
                                        <div class="flex justify-between items-center mb-2">
                                            <div>
                                                <h3 class="font-bold text-blue-900">Next Shift: ${nextShiftStats.dateLabel}</h3>
                                                <p class="text-sm text-blue-700">${nextShiftStats.filledSlots} of ${nextShiftStats.totalSlots} positions filled</p>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-3xl font-bold ${nextShiftStats.coverage >= 90 ? 'text-green-600' : nextShiftStats.coverage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                                    ${nextShiftStats.coverage}%
                                                </div>
                                                ${nextShiftStats.needsHelp > 0 ? `
                                                    <div class="text-xs text-red-600 font-semibold">
                                                        Need ${nextShiftStats.needsHelp} more!
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill ${nextShiftStats.coverage >= 90 ? 'bg-green-500' : nextShiftStats.coverage >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                                 style="width: ${nextShiftStats.coverage}%"></div>
                                        </div>
                                    </div>
                                ` : ''}

                                ${!isSpecialEvent ? `
                                    <div class="flex flex-col md:flex-row gap-2 mb-4">
                                        <select onchange="app.selectedPeriod=this.value; localStorage.setItem('uts-selected-period', this.value); app.render();" class="flex-1 p-2 border rounded-lg">
                                            ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                                        </select>
                                        ${this.currentView !== 'weekly-tasks' ? `
                                            <button onclick="app.currentView='${this.currentView === 'thursday-hall' ? 'saturday-hall' : 'thursday-hall'}'; app.render();" 
                                                    class="px-4 py-2 ${this.currentView === 'thursday-hall' ? 'bg-orange-600' : 'bg-blue-600'} text-white rounded-lg hover:opacity-90">
                                                Switch to ${this.currentView === 'thursday-hall' ? 'Saturday' : 'Thursday'}
                                            </button>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>

<div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-4 no-print">
    <h3 class="font-bold text-blue-900 mb-2">üìù How to Sign Up:</h3>
    <ol class="list-decimal list-inside space-y-1 text-blue-800 text-sm">
        <li>Expand the month you want to volunteer</li>
        <li>Find a date that works for you</li>
        <li>Click the green "‚úã Sign me up!" button for your preferred role</li>
        <li>Type your name and click Confirm</li>
    </ol>
    <p class="text-xs text-blue-700 mt-2">üí° Tip: Click month headers to expand/collapse. Scroll right to see all roles.</p>
</div>

<!-- MONTHLY SECTIONS -->
${Object.entries(datesByMonth).map(([monthKey, monthData]) => {
    const isCollapsed = this.collapsedMonths[monthKey];
    
    return `
        <div class="month-section mb-4">
            <div class="month-header ${isCollapsed ? 'collapsed' : ''}" onclick="app.toggleMonth('${monthKey}'); app.render();">
                <span>${monthData.name}</span>
                <span class="chevron">‚ñº</span>
            </div>
            
            <div class="month-content ${isCollapsed ? 'collapsed' : ''}">
                <div class="bg-white overflow-hidden">
                    <div class="overflow-auto max-h-[600px]">
                        <table class="w-full">
                            <thead class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white z-20">
                                <tr>
                                    <th class="p-2 md:p-3 text-left text-xs md:text-sm font-semibold sticky left-0 bg-indigo-600 z-30">Date</th>
                                    ${roles.map(role => `
                                        <th class="p-2 md:p-3 text-left text-xs md:text-sm font-semibold role-cell">
                                            <div class="font-bold">${role.name}</div>
                                            <div class="text-xs opacity-90">${role.time}</div>
                                        </th>
                                    `).join('')}
                                    <th class="p-2 md:p-3 text-left text-xs md:text-sm font-semibold">
                                        <div class="font-bold">Notes</div>
                                        <div class="text-xs opacity-90">${this.isAdmin ? 'Admin only' : 'If any'}</div>
                                    </th>
                                    ${this.isAdmin && this.currentView !== 'weekly-tasks' ? '<th class="p-2 md:p-3 text-center text-xs md:text-sm font-semibold">Giveaway</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${monthData.dates.map((d, i) => {
                                    const dateClass = this.getDateClass(d.date);
                                    const isNextShift = d.date === nextShiftDate;
                                    return `
                                    <tr class="border-b hover:bg-gray-50 ${dateClass}">
                                        <td class="p-2 md:p-3 font-semibold text-xs md:text-sm sticky left-0 bg-white z-10 border-r">
                                            <div class="flex flex-col gap-1">
                                                ${isNextShift ? '<div class="next-shift-badge">NEXT</div>' : ''}
                                                <span>${d.label}</span>
                                            </div>
                                        </td>
                                        ${roles.map(role => {
                                            const isGiveawayRole = role.id === 'giveaway';
                                            const giveawayEnabled = this.isGiveawayEnabled(this.currentView, d.date);
                                            
                                            if (isGiveawayRole && !giveawayEnabled) {
                                                return `
                                                    <td class="p-2 md:p-3 text-xs md:text-sm role-cell giveaway-disabled">
                                                        Not available
                                                    </td>
                                                `;
                                            }
                                            
                                            const signups = this.getSignups(this.currentView, d.date, role.id);
                                            const slotsLeft = role.capacity - signups.length;
                                            return `
                                            <td class="p-2 md:p-3 text-xs md:text-sm role-cell">
                                                ${signups.map(signup => {
                                                    const isEditing = this.editingSignup && 
                                                                    this.editingSignup.view === this.currentView && 
                                                                    this.editingSignup.dateStr === d.date && 
                                                                    this.editingSignup.roleId === role.id && 
                                                                    this.editingSignup.signup === signup;
                                                    
                                                    return `
                                                        <div class="mb-1 flex items-center gap-1 volunteer-item">
                                                            ${isEditing ? `
                                                                <input 
                                                                    type="text" 
                                                                    value="${signup.name}" 
                                                                    id="editInput-${monthKey}-${i}"
                                                                    class="flex-1 px-2 py-1 border-2 border-blue-500 rounded"
                                                                    onkeypress="if(event.key==='Enter'){app.saveEdit(this.value);}"
                                                                />
                                                                <button onclick="app.saveEdit(document.getElementById('editInput-${monthKey}-${i}').value);" class="text-green-600 hover:text-green-800 text-lg">‚úì</button>
                                                                <button onclick="app.cancelEdit();" class="text-red-600 hover:text-red-800 text-lg">‚úï</button>
                                                            ` : `
                                                                <span class="flex-1">‚úì ${signup.name}</span>
                                                                <button onclick="app.startEdit('${this.currentView}', '${d.date}', '${role.id}', app.getSignups('${this.currentView}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="edit-icon text-sm">‚úèÔ∏è</button>
                                                                <button onclick="app.removeSignup('${this.currentView}', '${d.date}', '${role.id}', app.getSignups('${this.currentView}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="text-red-600 hover:text-red-800 text-sm ml-1">‚úï</button>
                                                            `}
                                                        </div>
                                                    `;
                                                }).join('')}
                                                ${!this.editingSignup || this.editingSignup.view !== this.currentView || this.editingSignup.dateStr !== d.date || this.editingSignup.roleId !== role.id ? `
                                                    <button onclick="app.selectedSlot={view:'${this.currentView}', dateStr:'${d.date}', roleId:'${role.id}'}; app.showModal=true; app.render();" 
                                                            class="w-full text-left px-2 py-1 mb-1 text-xs font-semibold rounded transition-all
                                                                   ${slotsLeft > 0 
                                                                     ? 'bg-green-50 border-2 border-green-400 text-green-700 hover:bg-green-100 hover:border-green-600' 
                                                                     : 'bg-orange-50 border-2 border-orange-400 text-orange-700 hover:bg-orange-100'}">
                                                        ${slotsLeft > 0 
                                                          ? `‚úã Sign me up! (${slotsLeft} ${slotsLeft === 1 ? 'spot' : 'spots'} left)` 
                                                          : '‚ö†Ô∏è FULL - Add anyway?'}
                                                    </button>
                                                ` : ''}
                                            </td>
                                        `;
                                        }).join('')}
                                        <td class="p-2 md:p-3">
                                            ${this.isAdmin ? `
                                                <input type="text" 
                                                       placeholder="Add note..." 
                                                       value="${this.getNote(this.currentView, d.date)}"
                                                       onchange="app.saveNote('${this.currentView}', '${d.date}', this.value)"
                                                       class="w-full p-1 text-xs border rounded" />
                                            ` : `
                                                ${this.getNote(this.currentView, d.date) ? `
                                                    <div class="text-xs bg-yellow-50 border-l-4 border-yellow-400 p-2 rounded text-yellow-900">
                                                        üìù ${this.getNote(this.currentView, d.date)}
                                                    </div>
                                                ` : ''}
                                            `}
                                        </td>
                                        ${this.isAdmin && this.currentView !== 'weekly-tasks' ? `
                                            <td class="p-2 md:p-3 text-center">
                                                <input type="checkbox" 
                                                       ${this.isGiveawayEnabled(this.currentView, d.date) ? 'checked' : ''}
                                                       onchange="app.toggleGiveaway('${this.currentView}', '${d.date}')"
                                                       class="w-4 h-4" />
                                            </td>
                                        ` : ''}
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}).join('')}

                    </div>

${this.showModal ? `
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){app.showModal=false; app.render();}">
        <div class="bg-white rounded-lg p-6 max-w-md w-full shadow-2xl">
            <h3 class="text-2xl font-bold mb-2">Sign Up for This Shift</h3>
            
            <div class="bg-blue-50 p-3 rounded mb-4 text-sm">
                <p><strong>Date:</strong> ${(() => {
                    const slot = this.selectedSlot;
                    if (!slot) return '';
                    const [y, m, d] = slot.dateStr.split('-').map(Number);
                    const date = new Date(y, m - 1, d);
                    return date.toLocaleDateString('en-NZ', { weekday: 'long', day: 'numeric', month: 'long' });
                })()}</p>
                <p><strong>Role:</strong> ${(() => {
                    const slot = this.selectedSlot;
                    if (!slot) return '';
                    const role = this.getVisibleRoles(slot.view).find(r => r.id === slot.roleId);
                    return role ? `${role.name} (${role.time})` : '';
                })()}</p>
            </div>
            
            <label class="block text-sm font-semibold mb-2">Your Name:</label>
            <input type="text" 
                   placeholder="Enter your full name" 
                   value="${this.volunteerName}"
                   oninput="app.volunteerName=this.value"
                   onkeypress="if(event.key==='Enter'){app.addSignup();}"
                   class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-lg focus:border-blue-500 focus:outline-none"
                   autofocus />
            
            <div class="flex gap-2">
                <button onclick="app.addSignup()" 
                        class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-green-700 transition-colors">
                    ‚úì Confirm Sign Up
                </button>
                <button onclick="app.showModal=false; app.volunteerName=''; app.render();" 
                        class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                    Cancel
                </button>
            </div>
        </div>
    </div>
` : ''}
                `;
            },

            renderAdminRoster(view) {
                const specialEvent = this.specialEvents.find(e => e.id === view);
                const isSpecialEvent = !!specialEvent;
                
                const currentPeriod = this.periods.find(p => p.id === this.selectedPeriod);
                const dates = this.getDatesForView(view);
                const roles = this.getVisibleRoles(view);
                const viewName = isSpecialEvent ? specialEvent.name :
                                view === 'thursday-hall' ? 'Thursday Hall' : 
                                view === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';

return `
    <div class="mb-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-xl font-bold">${viewName}</h3>
            <button onclick="app.adminView='dashboard'; app.render();" class="px-3 py-1 bg-gray-500 text-white text-sm rounded-lg hover:bg-gray-600">‚Üê Back to Dashboard</button>
        </div>
                        ${!isSpecialEvent ? `
                            <select onchange="app.selectedPeriod=this.value; localStorage.setItem('uts-selected-period', this.value); app.render();" class="w-full md:w-auto p-2 border rounded-lg mb-4">
                                ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                            </select>
                        ` : ''}
                    </div>
                    
                    <div class="overflow-x-auto -mx-6 px-6" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                        <table class="w-full border-collapse min-w-max">
                            <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                                <tr>
                                    <th class="p-2 text-left text-sm font-semibold border sticky left-0 bg-indigo-600 z-10" style="min-width: 100px;">Date</th>
                                    ${roles.map(role => `
                                        <th class="p-2 text-left text-sm font-semibold border" style="min-width: 160px;">
                                            <div class="font-bold">${role.name}</div>
                                            <div class="text-xs opacity-90">${role.time}</div>
                                        </th>
                                    `).join('')}
                                    <th class="p-2 text-left text-sm font-semibold border" style="min-width: 120px;">Notes</th>
                                    ${!isSpecialEvent && view !== 'weekly-tasks' ? '<th class="p-2 text-center text-sm font-semibold border" style="min-width: 80px;">Giveaway</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${dates.map((d, i) => {
                                    const dateClass = this.getDateClass(d.date);
                                    return `
                            <tr class="border ${dateClass}">
    <td class="p-2 text-sm font-semibold border sticky left-0 bg-gray-50" style="min-width: 100px;">${d.label}</td>
                                        ${roles.map(role => {
                                            if (role.id === 'giveaway' && !this.isGiveawayEnabled(view, d.date)) {
                                                return '';
                                            }
                                            
                                            const signups = this.getSignups(view, d.date, role.id);
                                            const slotsLeft = role.capacity - signups.length;
                                            return `
                                            <td class="p-2 text-sm border" style="min-width: 160px;">
                                                ${signups.map(signup => {
                                                    const isEditing = this.editingSignup && 
                                                                    this.editingSignup.view === view && 
                                                                    this.editingSignup.dateStr === d.date && 
                                                                    this.editingSignup.roleId === role.id && 
                                                                    this.editingSignup.signup === signup;
                                                    
                                                    return `
                                                        <div class="mb-1 flex items-center gap-1 volunteer-item">
                                                            ${isEditing ? `
                                                                <input 
                                                                    type="text" 
                                                                    value="${signup.name}" 
                                                                    id="editInput-${i}"
                                                                    class="flex-1 px-2 py-1 border-2 border-blue-500 rounded"
                                                                    onkeypress="if(event.key==='Enter'){app.saveEdit(this.value);}"
                                                                />
                                                                <button onclick="app.saveEdit(document.getElementById('editInput-${i}').value);" class="text-green-600 hover:text-green-800 text-lg">‚úì</button>
                                                                <button onclick="app.cancelEdit();" class="text-red-600 hover:text-red-800 text-lg">‚úï</button>
                                                            ` : `
                                                                <span class="flex-1">‚úì ${signup.name}</span>
                                                                <button onclick="app.startEdit('${view}', '${d.date}', '${role.id}', app.getSignups('${view}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="edit-icon text-sm">‚úèÔ∏è</button>
                                                                <button onclick="app.removeSignup('${view}', '${d.date}', '${role.id}', app.getSignups('${view}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="text-red-600 hover:text-red-800 text-sm ml-1">‚úï</button>
                                                            `}
                                                        </div>
                                                    `;
                                                }).join('')}
                                                ${slotsLeft > 0 && (!this.editingSignup || this.editingSignup.view !== view || this.editingSignup.dateStr !== d.date || this.editingSignup.roleId !== role.id) ? 
                                                    Array(slotsLeft).fill(0).map(() => `
                                                        <button onclick="app.selectedSlot={view:'${view}', dateStr:'${d.date}', roleId:'${role.id}'}; app.showModal=true; app.render();" 
                                                                class="w-full text-left px-2 py-1 mb-1 border-2 border-dashed border-gray-300 rounded hover:border-indigo-500 hover:bg-indigo-50 text-gray-500 text-xs">
                                                            + Add volunteer
                                                        </button>
                                                    `).join('') : ''
                                                }
                                            </td>
                                        `;
                                        }).join('')}
                                        <td class="p-2 border" style="min-width: 120px;">
                                            <input type="text" 
                                                   placeholder="Add note..." 
                                                   value="${this.getNote(view, d.date)}"
                                                   onchange="app.saveNote('${view}', '${d.date}', this.value)"
                                                   class="w-full p-1 text-xs border rounded" />
                                        </td>
                                        ${!isSpecialEvent && view !== 'weekly-tasks' ? `
                                            <td class="p-2 text-center border" style="min-width: 80px;">
                                                <input type="checkbox" 
                                                       ${this.isGiveawayEnabled(view, d.date) ? 'checked' : ''}
                                                       onchange="app.toggleGiveaway('${view}', '${d.date}')"
                                                       class="w-4 h-4" />
                                            </td>
                                        ` : ''}
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>

                    ${this.showModal ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){app.showModal=false; app.render();}">
                            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 class="text-xl font-bold mb-4">Sign Up</h3>
                                <input type="text" 
                                       placeholder="Enter volunteer name" 
                                       value="${this.volunteerName}"
                                       oninput="app.volunteerName=this.value"
                                       onkeypress="if(event.key==='Enter'){app.addSignup();}"
                                       class="w-full p-3 border rounded-lg mb-4"
                                       autofocus />
                                <div class="flex gap-2">
                                    <button onclick="app.addSignup()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                        Confirm
                                    </button>
                                    <button onclick="app.showModal=false; app.volunteerName=''; app.render();" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;
            },

            renderSpecialEventsManager() {
                const sortedEvents = [...this.specialEvents].sort((a, b) => {
                    const aDate = new Date(Math.min(...a.dates.map(d => new Date(d.split('-').map(Number)).getTime())));
                    const bDate = new Date(Math.min(...b.dates.map(d => new Date(d.split('-').map(Number)).getTime())));
                    return aDate - bDate;
                });

                return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold">Special Events</h3>
                            <button onclick="app.editingEvent='new'; app.render();" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                                ‚ûï Create New Event
                            </button>
                        </div>

                        ${this.editingEvent === 'new' ? this.renderEventForm() : ''}

                        ${sortedEvents.length === 0 ? `
                            <div class="text-center py-12 text-gray-500">
                                <p class="text-lg mb-2">No special events yet</p>
                                <p class="text-sm">Create your first event to get started!</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${sortedEvents.map(event => {
                                    const firstDate = event.dates[0];
                                    const [year, month, day] = firstDate.split('-').map(Number);
                                    const date = new Date(year, month - 1, day);
                                    const isPast = date < new Date();
                                    
                                    return `
                                        <div class="border rounded-lg p-4 ${isPast ? 'bg-gray-50' : 'bg-white'} ${event.visible ? 'border-indigo-300' : 'border-gray-300'}">
                                            <div class="flex justify-between items-start mb-2">
                                                <div class="flex-1">
                                                    <h4 class="text-lg font-bold ${isPast ? 'text-gray-600' : 'text-gray-900'}">${event.name}</h4>
                                                    <p class="text-sm text-gray-600">${event.dates.length} date${event.dates.length > 1 ? 's' : ''} ‚Ä¢ ${event.roles.length} role${event.roles.length > 1 ? 's' : ''}</p>
                                                </div>
                                                <div class="flex gap-1">
                                                    <button onclick="app.toggleEventVisibility('${event.id}'); app.render();" 
                                                            class="p-2 ${event.visible ? 'text-green-600' : 'text-gray-400'} hover:bg-gray-100 rounded"
                                                            title="${event.visible ? 'Visible on welcome screen' : 'Hidden from welcome screen'}">
                                                        ${event.visible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                                                    </button>
                                                    <button onclick="app.adminView='event-${event.id}'; app.render();" 
                                                            class="p-2 text-blue-600 hover:bg-blue-50 rounded" title="Edit roster">
                                                        üìã
                                                    </button>
                                                    <button onclick="app.editingEvent='${event.id}'; app.render();" 
                                                            class="p-2 text-indigo-600 hover:bg-indigo-50 rounded" title="Edit event">
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button onclick="app.deleteSpecialEvent('${event.id}'); app.render();" 
                                                            class="p-2 text-red-600 hover:bg-red-50 rounded" title="Delete event">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3 space-y-1 text-sm">
                                                <div><strong>Dates:</strong> ${event.dates.slice(0, 3).join(', ')}${event.dates.length > 3 ? '...' : ''}</div>
                                                <div><strong>Roles:</strong> ${event.roles.map(r => r.name).join(', ')}</div>
                                            </div>

                                            ${this.editingEvent === event.id ? `
                                                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
                                                    ${this.renderEventForm(event)}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            },

            renderEventForm(event = null) {
                const isNew = !event;
                const formId = isNew ? 'new' : event.id;
                
                return `
                    <div class="bg-white border-2 border-indigo-200 rounded-lg p-6 mt-4" id="eventForm-${formId}">
                        <h4 class="text-lg font-bold mb-4">${isNew ? 'Create New Event' : 'Edit Event'}</h4>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Event Name *</label>
                                <input type="text" id="eventName-${formId}" value="${event?.name || ''}" 
                                       placeholder="e.g., Christmas Dinner" 
                                       class="w-full p-2 border rounded-lg" />
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-1">Event Date(s) *</label>
                                <div id="eventDates-${formId}" class="space-y-2">
                                    ${event?.dates.map((d, i) => `
                                        <div class="flex gap-2">
                                            <input type="date" value="${d}" class="flex-1 p-2 border rounded-lg event-date" />
                                            ${event.dates.length > 1 ? `
                                                <button onclick="this.parentElement.remove();" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">‚úï</button>
                                            ` : ''}
                                        </div>
                                    `).join('') || `
                                        <div class="flex gap-2">
                                            <input type="date" class="flex-1 p-2 border rounded-lg event-date" />
                                        </div>
                                    `}
                                </div>
                                <button onclick="document.getElementById('eventDates-${formId}').insertAdjacentHTML('beforeend', '<div class=\\'flex gap-2\\'><input type=\\'date\\' class=\\'flex-1 p-2 border rounded-lg event-date\\' /><button onclick=\\'this.parentElement.remove();\\' class=\\'px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600\\'>‚úï</button></div>');" 
                                        class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">+ Add another date</button>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold mb-2">Roles *</label>
                                <div class="mb-2 flex gap-2">
                                    <button onclick="app.copyRolesTemplate('${formId}', 'thursday'); app.render();" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        Copy from Thursday
                                    </button>
                                    <button onclick="app.copyRolesTemplate('${formId}', 'saturday'); app.render();" class="px-3 py-1 text-sm bg-orange-100 text-orange-700 rounded hover:bg-orange-200">
                                        Copy from Saturday
                                    </button>
                                </div>
                                <div id="eventRoles-${formId}" class="space-y-2">
                                    ${event?.roles.map((r, i) => `
                                        <div class="flex gap-2 items-start p-2 bg-gray-50 rounded">
                                            <div class="flex-1 space-y-1">
                                                <input type="text" value="${r.name}" placeholder="Role name" 
                                                       class="w-full p-1 border rounded text-sm role-name" />
                                                <input type="text" value="${r.time}" placeholder="Time (e.g., 10:00am-2:00pm)" 
                                                       class="w-full p-1 border rounded text-sm role-time" />
                                                <input type="number" value="${r.capacity}" placeholder="Capacity" min="1" 
                                                       class="w-20 p-1 border rounded text-sm role-capacity" />
                                            </div>
                                            <button onclick="this.parentElement.remove();" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">‚úï</button>
                                        </div>
                                    `).join('') || ''}
                                </div>
                                <button onclick="document.getElementById('eventRoles-${formId}').insertAdjacentHTML('beforeend', '<div class=\\'flex gap-2 items-start p-2 bg-gray-50 rounded\\'><div class=\\'flex-1 space-y-1\\'><input type=\\'text\\' placeholder=\\'Role name\\' class=\\'w-full p-1 border rounded text-sm role-name\\' /><input type=\\'text\\' placeholder=\\'Time (e.g., 10:00am-2:00pm)\\' class=\\'w-full p-1 border rounded text-sm role-time\\' /><input type=\\'number\\' placeholder=\\'Capacity\\' min=\\'1\\' class=\\'w-20 p-1 border rounded text-sm role-capacity\\' /></div><button onclick=\\'this.parentElement.remove();\\' class=\\'px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm\\'>‚úï</button></div>');" 
                                        class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">+ Add role</button>
                            </div>

                            <div class="flex gap-2 pt-4">
                                <button onclick="app.saveEventForm('${formId}');" 
                                        class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700">
                                    ${isNew ? 'Create Event' : 'Save Changes'}
                                </button>
                                <button onclick="app.editingEvent=null; app.render();" 
                                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-400">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            copyRolesTemplate(formId, template) {
                const roles = template === 'thursday' ? this.roles['thursday-hall'] : this.roles['saturday-hall'];
                const rolesHtml = roles.filter(r => r.id !== 'giveaway').map(r => `
                    <div class="flex gap-2 items-start p-2 bg-gray-50 rounded">
                        <div class="flex-1 space-y-1">
                            <input type="text" value="${r.name}" placeholder="Role name" 
                                   class="w-full p-1 border rounded text-sm role-name" />
                            <input type="text" value="${r.time}" placeholder="Time" 
                                   class="w-full p-1 border rounded text-sm role-time" />
                            <input type="number" value="${r.capacity}" placeholder="Capacity" min="1" 
                                   class="w-20 p-1 border rounded text-sm role-capacity" />
                        </div>
                        <button onclick="this.parentElement.remove();" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">‚úï</button>
                    </div>
                `).join('');
                
                document.getElementById(`eventRoles-${formId}`).innerHTML = rolesHtml;
            },

            saveEventForm(formId) {
                const name = document.getElementById(`eventName-${formId}`).value.trim();
                if (!name) {
                    alert('Please enter an event name');
                    return;
                }

                const dateInputs = document.querySelectorAll(`#eventDates-${formId} .event-date`);
                const dates = Array.from(dateInputs).map(input => input.value).filter(d => d);
                if (dates.length === 0) {
                    alert('Please add at least one date');
                    return;
                }

                const roleElements = document.querySelectorAll(`#eventRoles-${formId} > div`);
                const roles = Array.from(roleElements).map((el, i) => {
                    const roleName = el.querySelector('.role-name').value.trim();
                    const roleTime = el.querySelector('.role-time').value.trim();
                    const roleCapacity = parseInt(el.querySelector('.role-capacity').value) || 1;
                    
                    if (!roleName) return null;
                    
                    return {
                        id: `role-${i}`,
                        name: roleName,
                        time: roleTime,
                        capacity: roleCapacity
                    };
                }).filter(r => r !== null);

                if (roles.length === 0) {
                    alert('Please add at least one role');
                    return;
                }

                if (formId === 'new') {
                    this.createSpecialEvent(name, dates, roles);
                } else {
                    this.updateSpecialEvent(formId, { name, dates, roles });
                }

                this.editingEvent = null;
                this.render();
            },

            getDatesForView(view) {
                const event = this.specialEvents.find(e => e.id === view);
                if (event) {
                    return event.dates.map(dateStr => {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        const date = new Date(year, month - 1, day);
                        return {
                            date: dateStr,
                            label: date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })
                        };
                    });
                }
                
                const savedView = this.currentView;
                this.currentView = view;
                const dates = this.getDatesForPeriod();
                this.currentView = savedView;
                return dates;
            },

            renderAdmin() {
                const stats = this.generateReport();
                
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                             <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Admin Dashboard</h1>
    <div class="flex gap-2">
        <button onclick="event.preventDefault(); app.currentView='welcome'; app.render(); return false;" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">üëÅÔ∏è View as Volunteer</button>
        <button onclick="app.logoutAdmin()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</button>
    </div>
</div>

                                <div class="flex gap-2 mb-6 flex-wrap">
                                    <button onclick="app.adminView='dashboard'; app.render();" class="px-4 py-2 ${this.adminView === 'dashboard' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Dashboard</button>
                                    <button onclick="app.adminView='volunteers'; app.render();" class="px-4 py-2 ${this.adminView === 'volunteers' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Volunteers by Role</button>
                                    <button onclick="app.adminView='special-events'; app.render();" class="px-4 py-2 ${this.adminView === 'special-events' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Special Events</button>
                                    <button onclick="app.adminView='thursday-roster'; app.render();" class="px-4 py-2 ${this.adminView === 'thursday-roster' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Thursday Roster</button>
                                    <button onclick="app.adminView='saturday-roster'; app.render();" class="px-4 py-2 ${this.adminView === 'saturday-roster' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Saturday Roster</button>
                                    <button onclick="app.adminView='weekly-roster'; app.render();" class="px-4 py-2 ${this.adminView === 'weekly-roster' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Additional Tasks</button>
                                    <button onclick="app.adminView='settings'; app.render();" class="px-4 py-2 ${this.adminView === 'settings' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Settings</button>
                                </div>

                                ${this.adminView === 'dashboard' ? `
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        <div class="p-4 bg-blue-50 rounded-lg">
                                            <div class="text-3xl font-bold text-blue-600">${stats.totalSignups}</div>
                                            <div class="text-gray-600">Total Signups</div>
                                        </div>
                                        <div class="p-4 bg-green-50 rounded-lg">
                                            <div class="text-3xl font-bold text-green-600">${stats.volunteerList.size}</div>
                                            <div class="text-gray-600">Unique Volunteers</div>
                                        </div>
                                        <div class="p-4 bg-purple-50 rounded-lg">
                                            <div class="text-3xl font-bold text-purple-600">${stats.topVolunteers[0]?.[1] || 0}</div>
                                            <div class="text-gray-600">Most Signups</div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xl font-bold mb-3">Top Volunteers by Role</h3>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="p-4 bg-blue-50 rounded-lg">
                                                <h4 class="font-bold text-blue-900 mb-3">üëî Top Meal Managers</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.managers.length > 0 ? stats.topByRole.managers.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-blue-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-green-50 rounded-lg">
                                                <h4 class="font-bold text-green-900 mb-3">ü§ù Top Hall Help</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.hallHelp.length > 0 ? stats.topByRole.hallHelp.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-green-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-purple-50 rounded-lg">
                                                <h4 class="font-bold text-purple-900 mb-3">ü•§ Top Drinks Trolley</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.drinks.length > 0 ? stats.topByRole.drinks.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-purple-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-yellow-50 rounded-lg">
                                                <h4 class="font-bold text-yellow-900 mb-3">üçΩÔ∏è Top Dishes</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.dishes.length > 0 ? stats.topByRole.dishes.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-yellow-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-pink-50 rounded-lg">
                                                <h4 class="font-bold text-pink-900 mb-3">üß∫ Top Laundry</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.laundry.length > 0 ? stats.topByRole.laundry.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-pink-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xl font-bold mb-3">By Roster Type</h3>
                                        ${Object.entries(stats.byRoster).map(([type, data]) => `
                                            <div class="mb-3">
                                                <div class="font-bold mb-1">
                                                    ${type === 'thursday-hall' ? 'Thursday Hall' : type === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks'}
                                                    <span class="text-gray-600 font-normal text-sm">(${data.total} signups, ${data.volunteers.size} volunteers)</span>
                                                </div>
                                                <div class="text-sm text-gray-600">
                                                    ${Array.from(data.volunteers).slice(0, 10).join(', ')}${data.volunteers.size > 10 ? '...' : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : this.adminView === 'volunteers' ? `
                                    <div class="space-y-6">
                                    <div class="space-y-6">
                                        <div class="p-4 bg-blue-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-blue-900 mb-3">üëî Managers (${stats.volunteersByRole.managers.size})</h3>
                                            <div class="text-sm text-blue-800">
                                                ${Array.from(stats.volunteersByRole.managers).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-green-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-green-900 mb-3">ü§ù Hall Help (${stats.volunteersByRole.hallHelp.size})</h3>
                                            <div class="text-sm text-green-800">
                                                ${Array.from(stats.volunteersByRole.hallHelp).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-purple-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-purple-900 mb-3">ü•§ Drinks Trolley (${stats.volunteersByRole.drinks.size})</h3>
                                            <div class="text-sm text-purple-800">
                                                ${Array.from(stats.volunteersByRole.drinks).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-yellow-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-yellow-900 mb-3">üçΩÔ∏è Dishes (${stats.volunteersByRole.dishes.size})</h3>
                                            <div class="text-sm text-yellow-800">
                                                ${Array.from(stats.volunteersByRole.dishes).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-pink-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-pink-900 mb-3">üß∫ Laundry (${stats.volunteersByRole.laundry.size})</h3>
                                            <div class="text-sm text-pink-800">
                                                ${Array.from(stats.volunteersByRole.laundry).sort().join(', ') || 'None'}
                                            </div>
                                        </div>
                                    </div>
                                ` : this.adminView === 'special-events' ?
                                    this.renderSpecialEventsManager() :
                                  this.adminView.startsWith('event-') ?
                                    this.renderAdminRoster(this.adminView.replace('event-', '')) :
                                  this.adminView === 'thursday-roster' ? 
                                    this.renderAdminRoster('thursday-hall') :
                                  this.adminView === 'saturday-roster' ? 
                                    this.renderAdminRoster('saturday-hall') :
                                  this.adminView === 'weekly-roster' ? 
                                    this.renderAdminRoster('weekly-tasks') :
                                `
                                    <div class="space-y-4">
                                        <button onclick="app.exportToCSV()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                                            üìä Export to CSV
                                        </button>
                                        <button onclick="app.downloadBackup()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                                            üíæ Download Backup
                                        </button>
                                        <button onclick="app.uploadBackup()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">
                                            üìÇ Upload Backup
                                        </button>
                                        <button onclick="app.addNextQuarter()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                            ‚ûï Add Next Quarter
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        app.init();
    </script>
</body>
</html>


