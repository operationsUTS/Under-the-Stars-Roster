<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under the Stars Volunteer Roster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .print-full-width { max-width: 100% !important; }
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            .role-cell {
                min-width: 140px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://evhjncobivtsxeeqvlue.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aGpuY29iaXZ0c3hlZXF2bHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDAyMTUsImV4cCI6MjA3NzM3NjIxNX0.NZKMBV8WKbef8ADsWAYlgtWlTJsiLqo9T8tjruuy7_k';
        const ADMIN_PASSWORD = 'UTS2025Admin';

        // HISTORICAL DATA - Pre-loaded for Oct-Dec 2025
        const HISTORICAL_DATA = {"thursday-hall":{"2025-10-02":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Alixandra Villis (new CIP)"},{name:"Anil (New, CIP)"}],"drinks":[{name:"Ali or Lesley"}],"laundry":[{name:"Catherine"}]},"2025-10-09":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Janet"},{name:"Sara"},{name:"Tina"}],"drinks":[{name:"Lesley"}],"dishes":[{name:"Catherine (coming early)"}],"laundry":[{name:"Catherine"}]},"2025-10-16":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Lesley"},{name:"Catherine"},{name:"Viv Clark (new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-10-23":{"managers":[{name:"Carl"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Paul"},{name:"Sarah Cornish (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley (hall help)"}],"laundry":[{name:"Adrian"}]},"2025-10-30":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Kerry (2 hours)"},{name:"Sara"},{name:"Lesley"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-11-06":{"managers":[{name:"Ani"},{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Maria and Maca (until 115)"},{name:"Tina"},{name:"Deb"},{name:"Richard (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}],"laundry":[{name:"Adrian"}]},"2025-11-13":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Sarah Cornish"},{name:"Harina (FCU, new)"},{name:"Lesley"},{name:"Larissa (FCU)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-11-20":{"managers":[{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Matthew Poland (one lineage, new)"},{name:"Nikita (one lineage)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}]},"2025-11-27":{"managers":[{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Ali"},{name:"Sara"},{name:"Rachel K"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-04":{"managers":[{name:"Ani"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"MJ (one lineage)"},{name:"Nick (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Catherine"}],"laundry":[{name:"Catherine"}]},"2025-12-11":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Elaine (one lineage, new)"},{name:"Matthew (one lineage, new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-18":{"managers":[{name:"Ani"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Josh (one lineage, new)"},{name:"Lesley"}],"drinks":[{name:"Sue"}]},"2025-12-25":{"hall-help":[{name:"Carol"},{name:"Lesley"},{name:"Steve (Lesley husband)"},{name:"Harley"},{name:"Elle"}]}},"saturday-hall":{"2025-10-04":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey (new)"},{name:"Sarah (new)"},{name:"Morgan"}],"hall-help-2":[{name:"Aimi"},{name:"Steve"}],"drinks":[{name:"Christine"}],"dishes":[{name:"Uatesoni"}],"laundry":[{name:"Morgan"}]},"2025-10-11":{"managers":[{name:"Carl"},{name:"Keiran"}],"hall-help-1":[{name:"Harriet Campbell (new)"},{name:"Jolene"},{name:"Cathleen"}],"hall-help-2":[{name:"Uatesoni"},{name:"Elle"}],"drinks":[{name:"Catherine"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-10-18":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Paul"},{name:"Cecilia (new)"},{name:"Michelle"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Sara"}],"laundry":[{name:"Sue"}]},"2025-10-25":{"managers":[{name:"Rose"}],"hall-help-1":[{name:"Paul"},{name:"Joanne (new)"},{name:"Harley"}],"hall-help-2":[{name:"Jaylah (16,new)"},{name:"Jaylah's mum (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Maria Moran"}],"laundry":[{name:"Liz"}]},"2025-11-01":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey"},{name:"Kaaren"},{name:"Harley"}],"hall-help-2":[{name:"Cecilia"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jimmy"}],"laundry":[{name:"Sue"}]},"2025-11-08":{"managers":[{name:"Keiran 4 - 6"},{name:"Carl"}],"hall-help-1":[{name:"Harriet Campbell"},{name:"Elle"}],"hall-help-2":[{name:"Cathleen Meichtry"},{name:"Karen P"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-11-15":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Sara"},{name:"Morgan"},{name:"Elle"}],"hall-help-2":[{name:"Maryanne"},{name:"Lisa"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jolene"}],"laundry":[{name:"Sue"}]},"2025-11-22":{"managers":[{name:"Carl"},{name:"Ani 4 - 6"}],"hall-help-1":[{name:"Jaylah"},{name:"Jaylahs mum"},{name:"Cecilia"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-11-29":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help-1":[{name:"Rachelt"},{name:"Steve"},{name:"Arshy (new)"}],"drinks":[{name:"Sue"}]},"2025-12-06":{"hall-help-1":[{name:"Abbey"},{name:"Cathleen Meichtry"}],"hall-help-2":[{name:"Harley"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-12-13":{"managers":[{name:"Keiran"}],"hall-help-2":[{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-20":{"hall-help-1":[{name:"Paul"},{name:"Harriet"},{name:"Elle"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-27":{"managers":[{name:"Rose"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]}},"weekly-tasks":{"2025-10-01":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-08":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-15":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}],"cheesecake":[{name:"Rose"}]},"2025-10-22":{"wed-pickup":[{name:"Greg"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-29":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-05":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-12":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Catherine"}]}}};

        let supabase = null;
        let useLocalStorage = false;

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error('Supabase failed, using localStorage');
            useLocalStorage = true;
        }

        const app = {
            currentView: 'welcome',
            selectedPeriod: 'oct-dec-2025',
            showModal: false,
            selectedSlot: null,
            volunteerName: '',
            signups: {},
            connectionStatus: 'checking',
            lastSaveTime: null,
            backupCount: 5,
            isInitialized: false,
            isAdmin: false,
            adminView: 'dashboard',

            periods: [
                { id: 'oct-dec-2025', label: 'October - December 2025', months: [10,11,12], year: 2025 },
                { id: 'jan-mar-2026', label: 'January - March 2026', months: [1,2,3], year: 2026 },
                { id: 'apr-jun-2026', label: 'April - June 2026', months: [4,5,6], year: 2026 },
                { id: 'jul-sep-2026', label: 'July - September 2026', months: [7,8,9], year: 2026 },
                { id: 'oct-dec-2026', label: 'October - December 2026', months: [10,11,12], year: 2026 },
            ],

            roles: {
                'thursday-hall': [
                    { id: 'managers', name: 'Managers', time: '9:45am-1:30pm', capacity: 2 },
                    { id: 'hall-help', name: 'Hall Help', time: '10:00am-1:30pm', capacity: 4 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '11:15am-1:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '11:30am-1:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                    { id: 'giveaway', name: 'Giveaway Table', time: '10:45am-12:45pm', capacity: 2 },
                ],
                'saturday-hall': [
                    { id: 'managers', name: 'Managers', time: '2:45pm-6:30pm', capacity: 2 },
                    { id: 'hall-help-1', name: 'Hall Help - Shift 1', time: '3:15pm-6:30pm', capacity: 3 },
                    { id: 'hall-help-2', name: 'Hall Help - Shift 2', time: '4:30pm-6:30pm (can come earlier)', capacity: 2 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '4:00pm-6:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '4:30pm-6:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                    { id: 'giveaway', name: 'Giveaway Table', time: '3:45pm-5:45pm', capacity: 2 },
                ],
                'weekly-tasks': [
                    { id: 'wed-pickup', name: 'Wed Bakers Delight', time: '~3:45pm', capacity: 1 },
                    { id: 'thurs-pickup', name: 'Thurs Bakers Delight', time: '4:50pm', capacity: 1 },
                    { id: 'cheesecake', name: 'Cheesecake Shop', time: '3-6pm Fri', capacity: 1 },
                ]
            },

            dateNotes: {},

            validateData(data) {
                if (!data || typeof data !== 'object') return false;
                for (let rosterType in data) {
                    if (!['thursday-hall', 'saturday-hall', 'weekly-tasks'].includes(rosterType)) continue;
                    const dates = data[rosterType];
                    if (typeof dates !== 'object') return false;
                    for (let date in dates) {
                        const roles = dates[date];
                        if (typeof roles !== 'object') return false;
                        for (let roleId in roles) {
                            const signups = roles[roleId];
                            if (!Array.isArray(signups)) return false;
                            for (let signup of signups) {
                                if (!signup.name || typeof signup.name !== 'string') return false;
                            }
                        }
                    }
                }
                return true;
            },

            createBackup() {
                try {
                    const timestamp = new Date().toISOString();
                    const backup = { data: this.signups, timestamp: timestamp, version: '1.0' };
                    const backups = this.getBackups();
                    backups.push(backup);
                    if (backups.length > this.backupCount) backups.shift();
                    localStorage.setItem('uts-roster-backups', JSON.stringify(backups));
                    console.log('Backup created:', timestamp);
                } catch (e) {
                    console.error('Backup creation failed:', e);
                }
            },

            getBackups() {
                try {
                    const stored = localStorage.getItem('uts-roster-backups');
                    if (!stored) return [];
                    const backups = JSON.parse(stored);
                    return Array.isArray(backups) ? backups : [];
                } catch (e) {
                    return [];
                }
            },

            restoreFromBackup() {
                const backups = this.getBackups();
                for (let i = backups.length - 1; i >= 0; i--) {
                    const backup = backups[i];
                    if (backup.data && this.validateData(backup.data)) {
                        this.signups = backup.data;
                        console.log('Restored from backup:', backup.timestamp);
                        return true;
                    }
                }
                console.log('No valid backups found. Starting fresh.');
                this.signups = {};
                return false;
            },

            showNotification(message, type = 'success') {
                if (this.currentView === 'welcome' && !this.isInitialized) {
                    console.log('Notification suppressed on welcome:', message);
                    return;
                }
                const notif = document.createElement('div');
                notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-red-600'
                } text-white font-semibold`;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            },

            async init() {
                await this.checkConnection();
                await this.loadHistoricalData(); // Load historical data into Supabase FIRST
                await this.loadSignups();
                this.isInitialized = true;
                this.render();

                if (!useLocalStorage && supabase) {
                    supabase.channel('signups').on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'volunteer_signups' }, 
                        () => this.loadSignups()
                    ).subscribe();
                }

                setInterval(() => this.autoBackup(), 300000);
                this.createBackup();
            },

            async checkConnection() {
                if (useLocalStorage) {
                    this.connectionStatus = 'offline';
                    return;
                }
                try {
                    const { error } = await supabase.from('volunteer_signups').select('id').limit(1);
                    this.connectionStatus = error ? 'error' : 'connected';
                } catch (e) {
                    this.connectionStatus = 'error';
                    console.error('Connection check failed:', e);
                }
            },

            async loadHistoricalData() {
                // Check if historical data has already been loaded to Supabase
                const hasHistoricalData = localStorage.getItem('uts-historical-loaded-to-supabase');
                if (hasHistoricalData) {
                    console.log('Historical data already loaded to database');
                    return;
                }

                console.log('Loading historical data to database...');

                if (useLocalStorage) {
                    // If using localStorage, just load it locally
                    this.signups = JSON.parse(JSON.stringify(HISTORICAL_DATA));
                    localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                    localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                    console.log('âœ“ Historical data loaded to localStorage');
                } else {
                    // Load to Supabase
                    try {
                        const insertions = [];
                        
                        // Convert historical data to Supabase format
                        for (let rosterType in HISTORICAL_DATA) {
                            for (let dateStr in HISTORICAL_DATA[rosterType]) {
                                for (let roleId in HISTORICAL_DATA[rosterType][dateStr]) {
                                    const volunteers = HISTORICAL_DATA[rosterType][dateStr][roleId];
                                    volunteers.forEach(v => {
                                        insertions.push({
                                            roster_type: rosterType,
                                            shift_date: dateStr,
                                            role_id: roleId,
                                            volunteer_name: v.name
                                        });
                                    });
                                }
                            }
                        }

                        console.log(`Inserting ${insertions.length} historical signups...`);
                        
                        // Insert in batches to avoid timeout
                        const batchSize = 50;
                        for (let i = 0; i < insertions.length; i += batchSize) {
                            const batch = insertions.slice(i, i + batchSize);
                            const { error } = await supabase.from('volunteer_signups').insert(batch);
                            if (error) throw error;
                            console.log(`Inserted batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(insertions.length/batchSize)}`);
                        }

                        localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                        console.log('âœ“ Historical data loaded to Supabase successfully!');
                        
                    } catch (e) {
                        console.error('Error loading historical data to Supabase:', e);
                        // Fall back to localStorage
                        this.signups = JSON.parse(JSON.stringify(HISTORICAL_DATA));
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                        console.log('âœ“ Historical data loaded to localStorage (fallback)');
                    }
                }

                this.createBackup();
            },

            autoBackup() {
                try {
                    if (!this.validateData(this.signups)) {
                        console.error('Data validation failed - backup skipped');
                        return;
                    }
                    this.createBackup();
                } catch (e) {
                    console.error('Auto-backup failed:', e);
                }
            },

            getDatesForPeriod() {
                const period = this.periods.find(p => p.id === this.selectedPeriod);
                if (!period) return [];
                const dates = [];
                
                if (this.currentView === 'weekly-tasks') {
                    // For weekly tasks, show Wed-Thurs pairs
                    period.months.forEach(month => {
                        const date = new Date(period.year, month - 1, 1);
                        while (date.getMonth() === month - 1) {
                            if (date.getDay() === 3) { // Wednesday
                                const wed = new Date(date);
                                const thurs = new Date(date);
                                thurs.setDate(thurs.getDate() + 1);
                                dates.push({
                                    date: wed.toISOString().split('T')[0],
                                    label: `${wed.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })} - ${thurs.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })}`
                                });
                            }
                            date.setDate(date.getDate() + 1);
                        }
                    });
                } else {
                    const targetDay = this.currentView === 'thursday-hall' ? 4 : 6;
                    period.months.forEach(month => {
                        const date = new Date(period.year, month - 1, 1);
                        while (date.getMonth() === month - 1) {
                            if (date.getDay() === targetDay) {
                                dates.push({
                                    date: date.toISOString().split('T')[0],
                                    label: date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })
                                });
                            }
                            date.setDate(date.getDate() + 1);
                        }
                    });
                }
                return dates;
            },

            async loadSignups() {
                if (useLocalStorage) {
                    const saved = localStorage.getItem('uts-roster');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            if (this.validateData(parsed)) {
                                this.signups = parsed;
                                this.createBackup();
                            } else {
                                console.error('Loaded data is corrupted. Attempting recovery...');
                                this.restoreFromBackup();
                            }
                        } catch (e) {
                            console.error('Error parsing data:', e);
                            this.restoreFromBackup();
                        }
                    }
                    // Load notes from localStorage
                    const savedNotes = localStorage.getItem('uts-date-notes');
                    if (savedNotes) {
                        try {
                            this.dateNotes = JSON.parse(savedNotes);
                        } catch (e) {
                            this.dateNotes = {};
                        }
                    }
                } else {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { data, error } = await supabase.from('volunteer_signups').select('*');
                            if (error) throw error;
                            this.signups = {};
                            data.forEach(s => {
                                if (!this.signups[s.roster_type]) this.signups[s.roster_type] = {};
                                if (!this.signups[s.roster_type][s.shift_date]) this.signups[s.roster_type][s.shift_date] = {};
                                if (!this.signups[s.roster_type][s.shift_date][s.role_id]) this.signups[s.roster_type][s.shift_date][s.role_id] = [];
                                this.signups[s.roster_type][s.shift_date][s.role_id].push({
                                    id: s.id,
                                    name: s.volunteer_name
                                });
                            });
                            if (!this.validateData(this.signups)) {
                                throw new Error('Loaded data failed validation');
                            }
                            this.connectionStatus = 'connected';
                            this.lastSaveTime = new Date();
                            this.createBackup();
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                console.error('Load failed after retries:', e);
                                this.connectionStatus = 'error';
                                this.restoreFromBackup();
                            } else {
                                await new Promise(r => setTimeout(r, 1000));
                            }
                        }
                    }
                    // Load notes from localStorage (notes are always stored locally for simplicity)
                    const savedNotes = localStorage.getItem('uts-date-notes');
                    if (savedNotes) {
                        try {
                            this.dateNotes = JSON.parse(savedNotes);
                        } catch (e) {
                            this.dateNotes = {};
                        }
                    }
                }
                if (this.isInitialized) {
                    this.render();
                }
            },

            saveNote(view, dateStr, note) {
                const key = `${view}-${dateStr}`;
                if (note.trim()) {
                    this.dateNotes[key] = note.trim();
                } else {
                    delete this.dateNotes[key];
                }
                localStorage.setItem('uts-date-notes', JSON.stringify(this.dateNotes));
                this.showNotification('Note saved');
            },

            getNote(view, dateStr) {
                const key = `${view}-${dateStr}`;
                return this.dateNotes[key] || '';
            },

            async addSignup() {
                if (!this.volunteerName.trim()) return alert('Please enter your name');
                const { view, dateStr, roleId } = this.selectedSlot;
                const originalSignups = JSON.parse(JSON.stringify(this.signups));

                if (useLocalStorage) {
                    try {
                        if (!this.signups[view]) this.signups[view] = {};
                        if (!this.signups[view][dateStr]) this.signups[view][dateStr] = {};
                        if (!this.signups[view][dateStr][roleId]) this.signups[view][dateStr][roleId] = [];
                        this.signups[view][dateStr][roleId].push({ name: this.volunteerName.trim() });
                        if (!this.validateData(this.signups)) {
                            throw new Error('Data validation failed');
                        }
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        this.createBackup();
                        this.showNotification('Signed up successfully!');
                    } catch (e) {
                        this.signups = originalSignups;
                        this.showNotification('Error signing up: ' + e.message, 'error');
                        return;
                    }
                } else {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { data, error } = await supabase.from('volunteer_signups').insert({
                                roster_type: view,
                                shift_date: dateStr,
                                role_id: roleId,
                                volunteer_name: this.volunteerName.trim()
                            }).select();
                            if (error) throw error;
                            await this.loadSignups();
                            this.showNotification('Signed up successfully!');
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                this.showNotification('Error signing up. Please try again.', 'error');
                                return;
                            }
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                }
                this.showModal = false;
                this.volunteerName = '';
                this.render();
            },

            async removeSignup(view, dateStr, roleId, signup) {
                if (!confirm(`Remove ${signup.name}?`)) return;
                const originalSignups = JSON.parse(JSON.stringify(this.signups));

                if (useLocalStorage) {
                    try {
                        this.signups[view][dateStr][roleId] = this.signups[view][dateStr][roleId].filter(s => s !== signup);
                        if (!this.validateData(this.signups)) {
                            throw new Error('Data validation failed');
                        }
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        this.createBackup();
                        this.showNotification('Removed successfully');
                    } catch (e) {
                        this.signups = originalSignups;
                        this.showNotification('Error removing: ' + e.message, 'error');
                        return;
                    }
                } else {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { error } = await supabase.from('volunteer_signups').delete().eq('id', signup.id);
                            if (error) throw error;
                            await this.loadSignups();
                            this.showNotification('Removed successfully');
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                this.showNotification('Error removing. Please try again.', 'error');
                                return;
                            }
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                }
                this.render();
            },

            getSignups(view, dateStr, roleId) {
                return this.signups[view]?.[dateStr]?.[roleId] || [];
            },

            // ADMIN FUNCTIONS
            
            loginAdmin() {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    this.isAdmin = true;
                    this.currentView = 'admin';
                    this.render();
                } else if (password !== null) {
                    alert('Incorrect password');
                }
            },

            logoutAdmin() {
                this.isAdmin = false;
                this.currentView = 'welcome';
                this.render();
            },

            addNextQuarter() {
                const lastPeriod = this.periods[this.periods.length - 1];
                const lastYear = lastPeriod.year;
                const lastMonths = lastPeriod.months;
                const lastMonth = lastMonths[lastMonths.length - 1];
                
                let newYear = lastYear;
                let newMonths = [];
                let startMonth = lastMonth + 1;
                
                if (startMonth > 12) {
                    startMonth = 1;
                    newYear++;
                }
                
                for (let i = 0; i < 3; i++) {
                    let month = startMonth + i;
                    if (month > 12) {
                        month = month - 12;
                        newYear = lastYear + 1;
                    }
                    newMonths.push(month);
                }
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const label = `${monthNames[newMonths[0]-1]} - ${monthNames[newMonths[2]-1]} ${newYear}`;
                const id = `${monthNames[newMonths[0]-1].toLowerCase()}-${monthNames[newMonths[2]-1].toLowerCase()}-${newYear}`;
                
                this.periods.push({
                    id: id,
                    label: label,
                    months: newMonths,
                    year: newYear
                });
                
                this.showNotification(`Added quarter: ${label}`, 'success');
                this.render();
            },

            exportToCSV() {
                const rows = [['Date', 'Day', 'Roster Type', 'Role', 'Time', 'Volunteer', 'Capacity']];
                
                for (let rosterType in this.signups) {
                    const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                      rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Weekly Tasks';
                    
                    for (let dateStr in this.signups[rosterType]) {
                        const date = new Date(dateStr);
                        const dayName = date.toLocaleDateString('en-NZ', { weekday: 'long' });
                        const dateLabel = date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short', year: 'numeric' });
                        
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const role = this.roles[rosterType]?.find(r => r.id === roleId);
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            
                            if (volunteers.length === 0) {
                                rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', '(empty)', role?.capacity || '']);
                            } else {
                                volunteers.forEach(v => {
                                    rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', v.name, role?.capacity || '']);
                                });
                            }
                        }
                    }
                }
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-roster-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('CSV exported successfully!');
            },

            generateReport() {
                const stats = {
                    totalSignups: 0,
                    volunteerList: new Set(),
                    byRoster: {},
                    coverageByDate: {}
                };
                
                for (let rosterType in this.signups) {
                    stats.byRoster[rosterType] = { total: 0, volunteers: new Set() };
                    
                    for (let dateStr in this.signups[rosterType]) {
                        if (!stats.coverageByDate[dateStr]) {
                            stats.coverageByDate[dateStr] = { filled: 0, total: 0 };
                        }
                        
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const role = this.roles[rosterType]?.find(r => r.id === roleId);
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            
                            stats.totalSignups += volunteers.length;
                            stats.byRoster[rosterType].total += volunteers.length;
                            stats.coverageByDate[dateStr].filled += volunteers.length;
                            stats.coverageByDate[dateStr].total += role?.capacity || 1;
                            
                            volunteers.forEach(v => {
                                stats.volunteerList.add(v.name);
                                stats.byRoster[rosterType].volunteers.add(v.name);
                            });
                        }
                    }
                }
                
                return stats;
            },

            downloadBackup() {
                const backup = {
                    data: this.signups,
                    periods: this.periods,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Backup downloaded!');
            },

            uploadBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            if (backup.data && this.validateData(backup.data)) {
                                this.signups = backup.data;
                                if (backup.periods && Array.isArray(backup.periods)) {
                                    this.periods = backup.periods;
                                }
                                this.createBackup();
                                this.showNotification('Backup restored successfully!');
                                this.render();
                            } else {
                                throw new Error('Invalid backup file');
                            }
                        } catch (e) {
                            this.showNotification('Error loading backup: ' + e.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            render() {
                const appEl = document.getElementById('app');
                if (this.currentView === 'welcome') {
                    appEl.innerHTML = this.renderWelcome();
                } else if (this.currentView === 'admin') {
                    appEl.innerHTML = this.renderAdmin();
                } else {
                    appEl.innerHTML = this.renderRoster();
                }
            },

            renderWelcome() {
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-8">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-12 h-12 text-pink-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                        <div>
                                            <h1 class="text-4xl font-bold">Under the Stars</h1>
                                            <p class="text-xl text-gray-600">Meal Rosters</p>
                                        </div>
                                    </div>
                                    <button onclick="app.loginAdmin()" class="text-gray-400 hover:text-gray-600 text-sm">Admin</button>
                                </div>

                                <div class="mb-8 text-gray-700 space-y-4">
                                    <p class="text-lg">Welcome! ðŸ˜Š</p>
                                    <p>Thanks for volunteering! We ask volunteers give their time once a month. Don't burn yourself out - we want you around for the long haul! ðŸ™‚</p>
                                    
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h3 class="font-bold text-blue-900 mb-2">To sign up:</h3>
                                        <ol class="list-decimal list-inside space-y-1 text-blue-800">
                                            <li>Choose your preferred day and task</li>
                                            <li>Find an available date and enter your name</li>
                                            <li><strong>If anything changes, please notify the operations coordinator at <a href="mailto:operations@underthestars.org.nz" class="underline">operations@underthestars.org.nz</a> as soon as possible</strong></li>
                                        </ol>
                                    </div>

                                    <p><strong>Meal Managers:</strong> Ani Stace, Carol Machaj, Keiran Stuart, Carl Fenton, Rose Kent-Wilson, Adrian De Souza</p>
                                    <p><strong>Venue:</strong> Cliff Rd community hall, 45 Cliff Rd</p>
                                    <p class="text-sm">*Long hair tied back. Closed toe shoes required.</p>
                                </div>

                                <div class="space-y-3">
                                    <button onclick="app.currentView='thursday-hall'; app.render();" class="w-full bg-blue-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-blue-700 transition-colors">Thursday Hall Help â†’</button>
                                    <button onclick="app.currentView='saturday-hall'; app.render();" class="w-full bg-orange-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-orange-700 transition-colors">Saturday Hall Help â†’</button>
                                    <button onclick="app.currentView='weekly-tasks'; app.render();" class="w-full bg-pink-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-pink-700 transition-colors">Weekly Tasks â†’</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderAdmin() {
                const stats = this.generateReport();
                
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-8">
                                <div class="flex justify-between items-center mb-6">
                                    <h1 class="text-3xl font-bold">Admin Dashboard</h1>
                                    <button onclick="app.logoutAdmin()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Logout</button>
                                </div>

                                <!-- Stats Overview -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                    <div class="bg-blue-50 p-6 rounded-lg">
                                        <h3 class="text-lg font-bold text-blue-900">Total Signups</h3>
                                        <p class="text-4xl font-bold text-blue-600">${stats.totalSignups}</p>
                                    </div>
                                    <div class="bg-green-50 p-6 rounded-lg">
                                        <h3 class="text-lg font-bold text-green-900">Active Volunteers</h3>
                                        <p class="text-4xl font-bold text-green-600">${stats.volunteerList.size}</p>
                                    </div>
                                    <div class="bg-purple-50 p-6 rounded-lg">
                                        <h3 class="text-lg font-bold text-purple-900">Total Periods</h3>
                                        <p class="text-4xl font-bold text-purple-600">${this.periods.length}</p>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                    <button onclick="app.addNextQuarter()" class="bg-indigo-600 text-white p-4 rounded-lg font-bold hover:bg-indigo-700 transition-colors">
                                        âž• Add Next Quarter
                                    </button>
                                    <button onclick="app.exportToCSV()" class="bg-green-600 text-white p-4 rounded-lg font-bold hover:bg-green-700 transition-colors">
                                        ðŸ“Š Export to CSV
                                    </button>
                                    <button onclick="app.downloadBackup()" class="bg-blue-600 text-white p-4 rounded-lg font-bold hover:bg-blue-700 transition-colors">
                                        ðŸ’¾ Download Backup
                                    </button>
                                    <button onclick="app.uploadBackup()" class="bg-orange-600 text-white p-4 rounded-lg font-bold hover:bg-orange-700 transition-colors">
                                        ðŸ“¤ Restore Backup
                                    </button>
                                </div>

                                <!-- Current Periods -->
                                <div class="mb-8">
                                    <h2 class="text-2xl font-bold mb-4">Current Periods</h2>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        ${this.periods.map(p => `
                                            <div class="flex justify-between items-center py-2 border-b last:border-b-0">
                                                <span class="font-semibold">${p.label}</span>
                                                <span class="text-gray-600">${p.months.join(', ')} / ${p.year}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Coverage Report -->
                                <div class="mb-8">
                                    <h2 class="text-2xl font-bold mb-4">Coverage by Roster Type</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        ${Object.keys(stats.byRoster).map(rosterType => {
                                            const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                                              rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Weekly Tasks';
                                            const data = stats.byRoster[rosterType];
                                            return `
                                                <div class="bg-gray-50 p-4 rounded-lg">
                                                    <h3 class="font-bold text-lg mb-2">${rosterName}</h3>
                                                    <p class="text-gray-700">Signups: <strong>${data.total}</strong></p>
                                                    <p class="text-gray-700">Volunteers: <strong>${data.volunteers.size}</strong></p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>

                                <!-- Active Volunteers List -->
                                <div class="mb-8">
                                    <h2 class="text-2xl font-bold mb-4">All Active Volunteers</h2>
                                    <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto">
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                            ${Array.from(stats.volunteerList).sort().map(name => `
                                                <div class="bg-white p-2 rounded border text-sm">${name}</div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Navigation -->
                                <div class="border-t pt-6">
                                    <h2 class="text-2xl font-bold mb-4">Quick Access to Rosters</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <button onclick="app.currentView='thursday-hall'; app.render();" class="bg-blue-600 text-white p-4 rounded-lg font-bold hover:bg-blue-700 transition-colors">Thursday Hall â†’</button>
                                        <button onclick="app.currentView='saturday-hall'; app.render();" class="bg-orange-600 text-white p-4 rounded-lg font-bold hover:bg-orange-700 transition-colors">Saturday Hall â†’</button>
                                        <button onclick="app.currentView='weekly-tasks'; app.render();" class="bg-pink-600 text-white p-4 rounded-lg font-bold hover:bg-pink-700 transition-colors">Weekly Tasks â†’</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderRoster() {
                const dates = this.getDatesForPeriod();
                const roles = this.roles[this.currentView] || [];
                const title = this.currentView === 'thursday-hall' ? 'Thursday Hall Help' : 
                             this.currentView === 'saturday-hall' ? 'Saturday Hall Help' : 
                             'Weekly Tasks';

                const statusColor = this.connectionStatus === 'connected' ? 'green' : 
                                   this.connectionStatus === 'error' ? 'red' : 'yellow';
                const statusText = this.connectionStatus === 'connected' ? 'â— Online' : 
                                  this.connectionStatus === 'error' ? 'â— Offline' : 'â— Connecting...';

                return `
                    <div class="min-h-screen p-2 md:p-4">
                        <div class="max-w-full mx-auto">
                            <div class="bg-white rounded-lg shadow-lg p-4 md:p-6 mb-4">
                                <div class="flex gap-2 mb-4">
                                    <button onclick="app.currentView='welcome'; app.render();" class="text-gray-600 hover:text-gray-800 font-semibold">â† Back</button>
                                    ${this.isAdmin ? `<button onclick="app.currentView='admin'; app.render();" class="text-indigo-600 hover:text-indigo-800 font-semibold ml-auto">Admin Panel</button>` : ''}
                                </div>
                                
                                <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-4">
                                    <div class="flex-1">
                                        <h1 class="text-2xl md:text-3xl font-bold mb-2">${title}</h1>
                                        <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                            <p class="text-sm text-blue-900">
                                                <strong>Questions?</strong> Contact: <a href="mailto:operations@underthestars.org.nz" class="underline">operations@underthestars.org.nz</a>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-left md:text-right w-full md:w-auto">
                                        <div class="text-${statusColor}-600 text-sm font-semibold mb-2">${statusText}</div>
                                        <select onchange="app.selectedPeriod=this.value; app.render();" class="w-full md:w-auto px-4 py-2 border rounded-lg">
                                            ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-lg table-container">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-800 text-white">
                                            <th class="p-2 md:p-3 text-left sticky left-0 bg-gray-800 z-20 min-w-[80px]">Date</th>
                                            ${roles.map(role => `
                                                <th class="p-2 md:p-3 text-center role-cell">
                                                    <div class="font-bold text-sm md:text-base">${role.name}</div>
                                                    <div class="text-xs font-normal">${role.time}</div>
                                                    <div class="text-xs font-normal">(${role.capacity} needed)</div>
                                                </th>
                                            `).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dates.map((d, idx) => `
                                            <tr class="${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                                                <td class="p-2 md:p-3 font-semibold sticky left-0 bg-inherit border-r z-10 text-sm md:text-base">${d.label}</td>
                                                ${roles.map(role => {
                                                    const signups = this.getSignups(this.currentView, d.date, role.id);
                                                    const isFull = signups.length >= role.capacity;
                                                    const isOverCapacity = signups.length > role.capacity;
                                                    return `
                                                        <td class="p-2 border role-cell ${isOverCapacity ? 'bg-yellow-50' : ''}">
                                                            <div class="space-y-1">
                                                                ${signups.map(s => `
                                                                    <div class="bg-green-100 rounded px-2 py-1 text-xs md:text-sm flex justify-between items-center gap-2">
                                                                        <span class="truncate">${s.name}</span>
                                                                        <button onclick='app.removeSignup("${this.currentView}", "${d.date}", "${role.id}", ${JSON.stringify(s).replace(/'/g, "&#39;")})' class="text-red-600 hover:text-red-800 flex-shrink-0">âœ•</button>
                                                                    </div>
                                                                `).join('')}
                                                                ${isOverCapacity ? '<div class="text-xs text-orange-600 font-semibold text-center">âš ï¸ Over capacity</div>' : ''}
                                                                <button onclick='app.selectedSlot={view:"${this.currentView}",dateStr:"${d.date}",roleId:"${role.id}",dateLabel:"${d.label}",roleName:"${role.name}"}; app.showModal=true; app.render();' class="w-full bg-indigo-50 border-2 border-dashed border-indigo-300 rounded px-2 py-1 text-xs md:text-sm text-indigo-600 hover:bg-indigo-100 transition-colors">
                                                                    ${isFull ? '+ Add Extra' : '+ Sign Up'}
                                                                </button>
                                                            </div>
                                                        </td>
                                                    `;
                                                }).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        ${this.showModal ? `
                            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                    <h3 class="text-xl font-bold mb-4">Sign Up for Shift</h3>
                                    <div class="mb-4 p-3 bg-gray-50 rounded text-sm">
                                        <div><strong>Date:</strong> ${this.selectedSlot.dateLabel}</div>
                                        <div><strong>Role:</strong> ${this.selectedSlot.roleName}</div>
                                    </div>
                                    <input type="text" id="volName" placeholder="Enter your name" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" value="${this.volunteerName}" onkeypress="if(event.key==='Enter'){app.volunteerName=this.value; app.addSignup();}">
                                    <div class="flex gap-3">
                                        <button onclick="app.showModal=false; app.volunteerName=''; app.render();" class="flex-1 bg-gray-200 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Cancel</button>
                                        <button onclick="app.volunteerName=document.getElementById('volName').value; app.addSignup();" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Sign Up</button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
