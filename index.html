<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UTS Volunteer Roster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui; background: #f8fafc; }
        .active-view { background: #1e293b !important; color: white !important; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="app" class="max-w-6xl mx-auto">
        <div class="text-center p-20 font-bold text-slate-400">PULLING DATA...</div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwuVlgfsP_98f5Aafo1ghZyVYhSfEwk5uLejtQx-PdOfPDhq3G1A2YDxp3l0UfVcBqG/exec';

        const state = { view: 'thursday-hall', data: [] };

        const roles = {
            'thursday-hall': ['managers', 'hall-help', 'drinks', 'dishes', 'laundry'],
            'saturday-hall': ['managers', 'hall-help-1', 'hall-help-2', 'drinks']
        };

        async function init() {
            try {
                const r = await fetch(SCRIPT_URL + '?action=getSignups');
                const j = await r.json();
                // Map the data to ensure we handle any column name weirdness
                state.data = (j.data || []).map(row => ({
                    date: String(row.shift_date || '').split('T')[0],
                    role: String(row.role_id || '').toLowerCase().trim(),
                    type: String(row.roster_type || '').toLowerCase().trim(),
                    name: row.volunteer_name || row.Name || 'Unknown'
                }));
                render();
            } catch (e) { document.getElementById('app').innerHTML = "Check Script Connection."; }
        }

        function render() {
            const root = document.getElementById('app');
            const activeRoles = roles[state.view];
            const months = [10, 11, 12]; // Oct, Nov, Dec 2025

            let html = `
                <div class="flex gap-2 mb-8">
                    <button onclick="state.view='thursday-hall';render()" class="p-4 border rounded-xl font-bold bg-white ${state.view==='thursday-hall'?'active-view':''}">THURSDAY</button>
                    <button onclick="state.view='saturday-hall';render()" class="p-4 border rounded-xl font-bold bg-white ${state.view==='saturday-hall'?'active-view':''}">SATURDAY</button>
                </div>
            `;

            months.forEach(m => {
                const monthLabel = new Date(2025, m-1, 1).toLocaleString('default', { month: 'long' });
                html += `
                    <div class="bg-white rounded-2xl shadow-sm border mb-10 overflow-hidden">
                        <div class="bg-slate-800 text-white p-4 font-bold uppercase text-[10px] tracking-widest">${monthLabel} 2025</div>
                        <table class="w-full text-left border-collapse text-sm">
                            <thead>
                                <tr class="bg-slate-50 border-b text-[10px] text-slate-400 font-bold uppercase">
                                    <th class="p-4 w-28">Date</th>
                                    ${activeRoles.map(r => `<th class="p-4 border-l">${r}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (let d = 1; d <= 31; d++) {
                    const dObj = new Date(2025, m-1, d);
                    if (dObj.getMonth() !== m-1) break;
                    
                    const targetDay = state.view === 'thursday-hall' ? 4 : 6;
                    if (dObj.getDay() === targetDay) {
                        const dateStr = dObj.toISOString().split('T')[0];
                        html += `<tr class="border-b last:border-0">
                            <td class="p-4 font-bold border-r bg-slate-50/30">${dateStr}</td>`;

                        activeRoles.forEach(role => {
                            // FLEXIBLE MATCHING
                            const matches = state.data.filter(row => 
                                row.date === dateStr && 
                                row.role.includes(role.split('-')[0]) && 
                                row.type.includes(state.view.split('-')[0])
                            );

                            html += `<td class="p-2 border-l align-top min-w-[120px]">
                                ${matches.map(m => `<div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-[10px] mb-1">${m.name}</div>`).join('')}
                                ${matches.length === 0 ? '<div class="text-[10px] text-slate-300 p-2">+ OPEN</div>' : ''}
                            </td>`;
                        });
                        html += `</tr>`;
                    }
                }
                html += `</tbody></table></div>`;
            });
            root.innerHTML = html;
        }

        init();
    </script>
</body>
</html>
