<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Under the Stars Volunteer Roster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .print-full-width { max-width: 100% !important; }
        }
        .table-container {
            width: 100%;
            overflow-x: auto !important;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        @media (max-width: 768px) {
            .table-container {
                overflow-x: scroll !important;
                -webkit-overflow-scrolling: touch;
                display: block !important;
                width: 100vw;
                margin-left: -1rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .table-container table {
                width: auto !important;
                min-width: 900px !important;
                display: table !important;
            }
            
            .role-cell {
                min-width: 150px !important;
            }
            
            th, td {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
            }
        }
        .giveaway-disabled {
            background-color: #f9fafb;
            color: #9ca3af;
            font-style: italic;
            text-align: center;
        }       
        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .date-past { opacity: 0.4; background-color: #f3f4f6 !important; }
        .date-today { background-color: #fef3c7 !important; border-left: 4px solid #f59e0b; }
        .date-future { }
        .date-next-shift { 
            background: linear-gradient(135deg, #bfdbfe 0%, #dbeafe 100%) !important;
            border: 4px solid #2563eb !important;
            position: relative;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
        .next-shift-badge {
            display: inline-block;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
            animation: pulse-glow 2s ease-in-out infinite;
            margin-right: 4px;
            white-space: nowrap;
        }
        
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        .coverage-excellent { background-color: #dcfce7; }
        .coverage-good { background-color: #fef9c3; }
        .coverage-poor { background-color: #fee2e2; }
        
        .notification-enter {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .edit-mode input {
            width: 100%;
            padding: 2px 4px;
            border: 2px solid #3b82f6;
            border-radius: 4px;
        }
        
        .edit-icon {
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            color: #6b7280;
        }
        
        .volunteer-item:hover .edit-icon {
            opacity: 1;
        }
        
        .edit-icon:hover {
            color: #3b82f6;
        }
        
        @media (min-width: 768px) {
            .table-container::after {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4" style="width: 48px; height: 48px;"></div>
                <p class="text-gray-600 text-lg font-semibold">Loading Under the Stars roster...</p>
                <p class="text-gray-500 text-sm mt-2">Please wait a moment</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            'use strict';
            
            const SUPABASE_URL = 'https://evhjncobivtsxeeqvlue.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aGpuY29iaXZ0c3hlZXF2bHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDAyMTUsImV4cCI6MjA3NzM3NjIxNX0.NZKMBV8WKbef8ADsWAYlgtWlTJsiLqo9T8tjruuy7_k';
            const ADMIN_PASSWORD = 'UTS2025Admin';
            const CONNECTION_TIMEOUT = 15000;
            const INIT_TIMEOUT = 45000;

            const HISTORICAL_DATA = {"thursday-hall":{"2025-10-02":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Alixandra Villis (new CIP)"},{name:"Anil (New, CIP)"}],"drinks":[{name:"Ali or Lesley"}],"laundry":[{name:"Catherine"}]},"2025-10-09":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Janet"},{name:"Sara"},{name:"Tina"}],"drinks":[{name:"Lesley"}],"dishes":[{name:"Catherine (coming early)"}],"laundry":[{name:"Catherine"}]},"2025-10-16":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Lesley"},{name:"Catherine"},{name:"Viv Clark (new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-10-23":{"managers":[{name:"Carl"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Paul"},{name:"Sarah Cornish (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley (hall help)"}],"laundry":[{name:"Adrian"}]},"2025-10-30":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Kerry (2 hours)"},{name:"Sara"},{name:"Lesley"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-11-06":{"managers":[{name:"Ani"},{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Maria and Maca (until 115)"},{name:"Tina"},{name:"Deb"},{name:"Richard (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}],"laundry":[{name:"Adrian"}]},"2025-11-13":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Sarah Cornish"},{name:"Harina (FCU, new)"},{name:"Lesley"},{name:"Larissa (FCU)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-11-20":{"managers":[{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Matthew Poland (one lineage, new)"},{name:"Nikita (one lineage)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}]},"2025-11-27":{"managers":[{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Ali"},{name:"Sara"},{name:"Rachel K"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-04":{"managers":[{name:"Ani"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"MJ (one lineage)"},{name:"Nick (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Catherine"}],"laundry":[{name:"Catherine"}]},"2025-12-11":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Elaine (one lineage, new)"},{name:"Matthew (one lineage, new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-18":{"managers":[{name:"Ani"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Josh (one lineage, new)"},{name:"Lesley"}],"drinks":[{name:"Sue"}]},"2025-12-25":{"hall-help":[{name:"Carol"},{name:"Lesley"},{name:"Steve (Lesley husband)"},{name:"Harley"},{name:"Elle"}]}},"saturday-hall":{"2025-10-04":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey (new)"},{name:"Sarah (new)"},{name:"Morgan"}],"hall-help-2":[{name:"Aimi"},{name:"Steve"}],"drinks":[{name:"Christine"}],"dishes":[{name:"Uatesoni"}],"laundry":[{name:"Morgan"}]},"2025-10-11":{"managers":[{name:"Carl"},{name:"Keiran"}],"hall-help-1":[{name:"Harriet Campbell (new)"},{name:"Jolene"},{name:"Cathleen"}],"hall-help-2":[{name:"Uatesoni"},{name:"Elle"}],"drinks":[{name:"Catherine"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-10-18":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Paul"},{name:"Cecilia (new)"},{name:"Michelle"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Sara"}],"laundry":[{name:"Sue"}]},"2025-10-25":{"managers":[{name:"Rose"}],"hall-help-1":[{name:"Paul"},{name:"Joanne (new)"},{name:"Harley"}],"hall-help-2":[{name:"Jaylah (16,new)"},{name:"Jaylah's mum (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Maria Moran"}],"laundry":[{name:"Liz"}]},"2025-11-01":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey"},{name:"Kaaren"},{name:"Harley"}],"hall-help-2":[{name:"Cecilia"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jimmy"}],"laundry":[{name:"Sue"}]},"2025-11-08":{"managers":[{name:"Keiran 4 - 6"},{name:"Carl"}],"hall-help-1":[{name:"Harriet Campbell"},{name:"Elle"}],"hall-help-2":[{name:"Cathleen Meichtry"},{name:"Karen P"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-11-15":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Sara"},{name:"Morgan"},{name:"Elle"}],"hall-help-2":[{name:"Maryanne"},{name:"Lisa"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jolene"}],"laundry":[{name:"Sue"}]},"2025-11-22":{"managers":[{name:"Carl"},{name:"Ani 4 - 6"}],"hall-help-1":[{name:"Jaylah"},{name:"Jaylahs mum"},{name:"Cecilia"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-11-29":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help-1":[{name:"Rachelt"},{name:"Steve"},{name:"Arshy (new)"}],"drinks":[{name:"Sue"}]},"2025-12-06":{"hall-help-1":[{name:"Abbey"},{name:"Cathleen Meichtry"}],"hall-help-2":[{name:"Harley"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-12-13":{"managers":[{name:"Keiran"}],"hall-help-2":[{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-20":{"hall-help-1":[{name:"Paul"},{name:"Harriet"},{name:"Elle"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-27":{"managers":[{name:"Rose"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]}},"weekly-tasks":{"2025-10-01":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-08":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-15":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}],"cheesecake":[{name:"Rose"}]},"2025-10-22":{"wed-pickup":[{name:"Greg"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-29":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-05":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-12":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Catherine"}]}}};

            let supabase = null;
            let initTimer = null;

            function showError(title, message, showRetry = true) {
                const retryButton = showRetry ? `
                    <button onclick="location.reload()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 mb-3">
                        üîÑ Try Again
                    </button>
                ` : '';
                
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="max-w-lg bg-red-50 border-2 border-red-300 rounded-lg p-6 shadow-xl">
                            <h2 class="text-2xl font-bold text-red-800 mb-3">‚ö†Ô∏è ${title}</h2>
                            <p class="text-red-700 mb-4">${message}</p>
                            
                            <div class="bg-white p-4 rounded-lg border border-red-200 mb-4">
                                <p class="font-bold text-gray-800 mb-2">Quick fixes:</p>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-700">
                                    <li>Check your internet connection</li>
                                    <li>Try refreshing the page (F5)</li>
                                    <li>Try a different browser (Chrome works best)</li>
                                    <li>Disable ad blockers for this page</li>
                                </ol>
                            </div>
                            
                            ${retryButton}
                            
                            <p class="text-sm text-center text-gray-600">
                                Need help? Email <a href="mailto:operations@underthestars.org.nz" class="text-blue-600 underline font-semibold">operations@underthestars.org.nz</a>
                            </p>
                        </div>
                    </div>
                `;
            }

            async function initSupabase() {
                try {
                    if (!window.supabase || !window.supabase.createClient) {
                        throw new Error('Supabase library failed to load');
                    }
                    
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('‚úÖ Supabase initialized');
                    
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Connection timeout')), CONNECTION_TIMEOUT)
                    );
                    
                    const testPromise = supabase.from('volunteer_signups').select('id').limit(1);
                    const { error } = await Promise.race([testPromise, timeoutPromise]);
                    
                    if (error) {
                        throw error;
                    }
                    
                    console.log('‚úÖ Supabase connection verified');
                    return true;
                    
                } catch (e) {
                    console.error('‚ùå Supabase initialization failed:', e);
                    showError(
                        'Cannot Connect to Database',
                        'Unable to connect to the volunteer database. Please check your internet connection and try again.',
                        true
                    );
                    return false;
                }
            }

            window.addEventListener('error', function(e) {
                console.error('‚ùå Global error:', e.error);
                if (!window.app || !window.app.isInitialized) {
                    clearTimeout(initTimer);
                    showError(
                        'Loading Error',
                        'An error occurred while loading the roster: ' + (e.error?.message || 'Unknown error'),
                        true
                    );
                }
            });

            window.addEventListener('unhandledrejection', function(e) {
                console.error('‚ùå Unhandled promise rejection:', e.reason);
            });

            initTimer = setTimeout(function() {
                if (!window.app || !window.app.isInitialized) {
                    console.error('‚ùå Initialization timeout');
                    showError(
                        'Loading Timeout',
                        'The roster is taking too long to load. This usually means a slow internet connection. Please try again.',
                        true
                    );
                }
            }, INIT_TIMEOUT);window.app = {
                currentView: 'welcome',
                selectedPeriod: 'oct-dec-2025',
                showModal: false,
                selectedSlot: null,
                volunteerName: '',
                signups: {},
                specialEvents: [],
                editingEvent: null,
                connectionStatus: 'checking',
                lastSaveTime: null,
                backupCount: 5,
                isInitialized: false,
                isAdmin: false,
                adminView: 'dashboard',
                dateNotes: {},
                giveawayDates: {},
                showMySignups: false,
                searchName: '',
                isLoading: false,
                editingSignup: null,

                periods: [
                    { id: 'oct-dec-2025', label: 'October - December 2025', months: [10,11,12], year: 2025 },
                    { id: 'jan-mar-2026', label: 'January - March 2026', months: [1,2,3], year: 2026 },
                    { id: 'apr-jun-2026', label: 'April - June 2026', months: [4,5,6], year: 2026 },
                    { id: 'jul-sep-2026', label: 'July - September 2026', months: [7,8,9], year: 2026 },
                    { id: 'oct-dec-2026', label: 'October - December 2026', months: [10,11,12], year: 2026 },
                ],

                roles: {
                    'thursday-hall': [
                        { id: 'managers', name: 'Managers', time: '9:45am-1:30pm', capacity: 2 },
                        { id: 'hall-help', name: 'Hall Help', time: '10:00am-1:30pm', capacity: 4 },
                        { id: 'drinks', name: 'Drinks Trolley', time: '11:15am-1:30pm', capacity: 1 },
                        { id: 'dishes', name: 'Dishes', time: '11:30am-1:30pm', capacity: 1 },
                        { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                        { id: 'giveaway', name: 'Giveaway Table', time: '10:45am-12:45pm', capacity: 2 },
                    ],
                    'saturday-hall': [
                        { id: 'managers', name: 'Managers', time: '2:45pm-6:30pm', capacity: 2 },
                        { id: 'hall-help-1', name: 'Hall Help - Shift 1', time: '3:15pm-6:30pm', capacity: 3 },
                        { id: 'hall-help-2', name: 'Hall Help - Shift 2', time: '4:30pm-6:30pm (can come earlier)', capacity: 2 },
                        { id: 'drinks', name: 'Drinks Trolley', time: '4:00pm-6:30pm', capacity: 1 },
                        { id: 'dishes', name: 'Dishes', time: '4:30pm-6:30pm', capacity: 1 },
                        { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                        { id: 'giveaway', name: 'Giveaway Table', time: '3:45pm-5:45pm', capacity: 2 },
                    ],
                    'weekly-tasks': [
                        { id: 'wed-pickup', name: 'Wed Bakers Delight', time: '~3:45pm', capacity: 1 },
                        { id: 'thurs-pickup', name: 'Thurs Bakers Delight', time: '4:50pm', capacity: 1 },
                        { id: 'cheesecake', name: 'Cheesecake Shop', time: '3-6pm Fri', capacity: 1 },
                    ]
                },

                getVisibleRoles(view) {
                    const event = this.specialEvents.find(e => e.id === view);
                    if (event) {
                        return event.roles;
                    }
                    
                    const allRoles = this.roles[view] || [];
                    return allRoles.filter(role => {
                        if (role.id !== 'giveaway') return true;
                        return this.hasAnyGiveaway(view);
                    });
                },

                hasAnyGiveaway(view) {
                    const dates = this.getDatesForPeriod();
                    return dates.some(d => this.isGiveawayEnabled(view, d.date));
                },

                isGiveawayEnabled(view, dateStr) {
                    const key = `${view}-${dateStr}`;
                    return this.giveawayDates[key] === true;
                },

                async toggleGiveaway(view, dateStr) {
                    const key = `${view}-${dateStr}`;
                    const newValue = !this.giveawayDates[key];
                    
                    this.createBackup();
                    this.giveawayDates[key] = newValue;
                    
                    if (!newValue) {
                        if (this.signups[view] && this.signups[view][dateStr] && this.signups[view][dateStr]['giveaway']) {
                            const giveawaySignups = this.signups[view][dateStr]['giveaway'];
                            
                            if (supabase && giveawaySignups.length > 0) {
                                for (let signup of giveawaySignups) {
                                    if (signup.id) {
                                        await supabase.from('volunteer_signups').delete().eq('id', signup.id);
                                    }
                                }
                            }
                            
                            this.signups[view][dateStr]['giveaway'] = [];
                        }
                    }
                    
                    localStorage.setItem('uts-giveaway-dates', JSON.stringify(this.giveawayDates));
                    
                    if (supabase) {
                        try {
                            await supabase.from('roster_settings').upsert({
                                setting_type: 'giveaway',
                                setting_key: key,
                                setting_value: newValue ? 'true' : 'false',
                                updated_at: new Date().toISOString()
                            }, { onConflict: 'setting_type,setting_key' });
                        } catch (e) {
                            console.error('Error syncing giveaway toggle:', e);
                        }
                    }
                    
                    this.showNotification(newValue ? 'Giveaway table enabled' : 'Giveaway table disabled');
                    this.render();
                },

                getNextUpcomingDate(view = null) {
                    const targetView = view || this.currentView;
                    
                    if (targetView === 'weekly-tasks') {
                        return null;
                    }
                    
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    
                    const period = this.periods.find(p => p.id === this.selectedPeriod);
                    if (!period) {
                        return null;
                    }
                    
                    const dates = this.getDatesForPeriod();
                    
                    for (let d of dates) {
                        const [year, month, day] = d.date.split('-').map(Number);
                        const date = new Date(year, month - 1, day);
                        date.setHours(12,0,0,0);
                        if (date >= today) {
                            return d.date;
                        }
                    }
                    return null;
                },

                getDateClass(dateStr) {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const [year, month, day] = dateStr.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    date.setHours(0,0,0,0);
                    const nextShift = this.getNextUpcomingDate(this.currentView);
                    
                    if (dateStr === nextShift) return 'date-next-shift';
                    if (date < today) return 'date-past';
                    if (date.getTime() === today.getTime()) return 'date-today';
                    return 'date-future';
                },

                getCoverageClass(filled, total) {
                    const percentage = (filled / total) * 100;
                    if (percentage >= 90) return 'coverage-excellent';
                    if (percentage >= 60) return 'coverage-good';
                    return 'coverage-poor';
                },

                getMySignups() {
                    if (!this.searchName.trim()) {
                        alert('Please enter your name to find your signups');
                        return;
                    }
                    
                    const name = this.searchName.trim().toLowerCase();
                    const mySignups = [];
                    
                    for (let rosterType in this.signups) {
                        for (let dateStr in this.signups[rosterType]) {
                            for (let roleId in this.signups[rosterType][dateStr]) {
                                const volunteers = this.signups[rosterType][dateStr][roleId];
                                volunteers.forEach(v => {
                                    if (v.name.toLowerCase().includes(name)) {
                                        const role = this.roles[rosterType]?.find(r => r.id === roleId);
                                        const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                                          rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';
                                        const [year, month, day] = dateStr.split('-').map(Number);
                                        const date = new Date(year, month - 1, day);
                                        mySignups.push({
                                            date: dateStr,
                                            dateLabel: date.toLocaleDateString('en-NZ', { 
                                                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
                                            }),
                                            roster: rosterName,
                                            role: role?.name || roleId,
                                            time: role?.time || ''
                                        });
                                    }
                                });
                            }
                        }
                    }
                    
                    mySignups.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    if (mySignups.length === 0) {
                        this.showNotification(`No signups found for "${this.searchName}"`, 'warning');
                    } else {
                        this.showMySignups = true;
                        this.mySignupsList = mySignups;
                        this.render();
                    }
                },

                startEdit(view, dateStr, roleId, signup) {
                    this.editingSignup = { view, dateStr, roleId, signup, originalName: signup.name };
                    this.render();
                },

                cancelEdit() {
                    this.editingSignup = null;
                    this.render();
                },

                async saveEdit(newName) {
                    if (!newName.trim()) {
                        alert('Name cannot be empty');
                        return;
                    }

                    const { view, dateStr, roleId, signup } = this.editingSignup;
                    
                    try {
                        const { error } = await supabase
                            .from('volunteer_signups')
                            .update({ volunteer_name: newName.trim() })
                            .eq('id', signup.id);
                        
                        if (error) throw error;
                        await this.loadSignups();
                        this.showNotification('Name updated successfully!');
                    } catch (e) {
                        this.showNotification('Error updating name', 'error');
                        console.error(e);
                    }
                    
                    this.editingSignup = null;
                    this.render();
                },

                validateData(data) {
                    if (!data || typeof data !== 'object') return false;
                    for (let rosterType in data) {
                        if (!['thursday-hall', 'saturday-hall', 'weekly-tasks'].includes(rosterType)) continue;
                        const dates = data[rosterType];
                        if (typeof dates !== 'object') return false;
                        for (let date in dates) {
                            const roles = dates[date];
                            if (typeof roles !== 'object') return false;
                            for (let roleId in roles) {
                                const signups = roles[roleId];
                                if (!Array.isArray(signups)) return false;
                                for (let signup of signups) {
                                    if (!signup.name || typeof signup.name !== 'string') return false;
                                }
                            }
                        }
                    }
                    return true;
                },

                async createBackup() {
                    try {
                        const timestamp = new Date().toISOString();
                        const backup = { 
                            data: this.signups, 
                            timestamp: timestamp, 
                            version: '1.0' 
                        };
                        
                        const backups = this.getBackups();
                        backups.push(backup);
                        if (backups.length > this.backupCount) backups.shift();
                        localStorage.setItem('uts-roster-backups', JSON.stringify(backups));
                        
                        if (supabase) {
                            try {
                                const { error } = await supabase.from('roster_backups').insert({
                                    backup_data: this.signups,
                                    backup_timestamp: timestamp,
                                    backup_version: '1.0',
                                    created_at: timestamp
                                });
                                
                                if (error) throw error;
                                
                                const { data: allBackups } = await supabase
                                    .from('roster_backups')
                                    .select('id, created_at')
                                    .order('created_at', { ascending: false });
                                
                                if (allBackups && allBackups.length > 20) {
                                    const toDelete = allBackups.slice(20).map(b => b.id);
                                    await supabase.from('roster_backups').delete().in('id', toDelete);
                                }
                            } catch (e) {
                                console.error('Failed to backup to Supabase:', e);
                            }
                        }
                    } catch (e) {
                        console.error('Backup creation failed:', e);
                    }
                },

                getBackups() {
                    try {
                        const stored = localStorage.getItem('uts-roster-backups');
                        if (!stored) return [];
                        const backups = JSON.parse(stored);
                        return Array.isArray(backups) ? backups : [];
                    } catch (e) {
                        return [];
                    }
                },

                async restoreFromBackup() {
                    if (supabase) {
                        try {
                            const { data, error } = await supabase
                                .from('roster_backups')
                                .select('*')
                                .order('created_at', { ascending: false })
                                .limit(10);
                            
                            if (!error && data && data.length > 0) {
                                for (let backup of data) {
                                    if (backup.backup_data && this.validateData(backup.backup_data)) {
                                        this.signups = backup.backup_data;
                                        this.showNotification('Restored from cloud backup', 'success');
                                        return true;
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Failed to restore from Supabase:', e);
                        }
                    }
                    
                    const backups = this.getBackups();
                    for (let i = backups.length - 1; i >= 0; i--) {
                        const backup = backups[i];
                        if (backup.data && this.validateData(backup.data)) {
                            this.signups = backup.data;
                            this.showNotification('Restored from local backup', 'warning');
                            return true;
                        }
                    }
                    
                    this.signups = {};
                    return false;
                },
          
                showNotification(message, type = 'success') {
                    if (this.currentView === 'welcome' && !this.isInitialized) {
                        return;
                    }
                    const notif = document.createElement('div');
                    notif.className = `notification-enter fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                        type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-red-600'
                    } text-white font-semibold`;
                    notif.textContent = message;
                    document.body.appendChild(notif);
                    const duration = type === 'success' ? 5000 : 3000;
                    setTimeout(() => notif.remove(), duration);
                },

                async init() {
                    console.log('üöÄ Initializing Under the Stars roster...');
                    this.isLoading = true;
                    this.render();
                    
                    try {
                        const connected = await initSupabase();
                        if (!connected) return;
                        
                        await this.checkConnection();
                        await this.loadHistoricalData();
                        await this.loadSignups();
                        await this.loadSpecialEvents();
                        await this.loadSettings();
                        
                        this.isLoading = false;
                        this.isInitialized = true;
                        
                        clearTimeout(initTimer);
                        console.log('‚úÖ App initialized successfully');
                        this.render();

                        if (supabase) {
                            supabase.channel('signups').on('postgres_changes', 
                                { event: '*', schema: 'public', table: 'volunteer_signups' }, 
                                () => this.loadSignups()
                            ).subscribe();
                            
                            supabase.channel('special-events').on('postgres_changes',
                                { event: '*', schema: 'public', table: 'special_events' },
                                () => this.loadSpecialEvents()
                            ).subscribe();
                            
                            supabase.channel('settings').on('postgres_changes',
                                { event: '*', schema: 'public', table: 'roster_settings' },
                                () => this.loadSettings()
                            ).subscribe();
                        }

                        setInterval(() => this.autoBackup(), 300000);
                        this.createBackup();
                        
                        window.addEventListener('popstate', (event) => {
                            if (event.state && event.state.view) {
                                this.currentView = event.state.view;
                                this.selectedPeriod = event.state.period || this.selectedPeriod;
                                this.showMySignups = event.state.showMySignups || false;
                                this.isAdmin = event.state.isAdmin || false;
                                this.adminView = event.state.adminView || 'dashboard';
                                this.render();
                            }
                        });
                        
                        history.replaceState({
                            view: this.currentView,
                            period: this.selectedPeriod,
                            isAdmin: this.isAdmin,
                            adminView: this.adminView
                        }, '', window.location.href);
                        
                    } catch (error) {
                        console.error('‚ùå Fatal initialization error:', error);
                        clearTimeout(initTimer);
                        showError('Initialization Failed', 'Failed to load the roster: ' + error.message);
                    }
                },

                async checkConnection() {
                    if (!supabase) {
                        this.connectionStatus = 'error';
                        return;
                    }
                    
                    try {
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Connection timeout')), CONNECTION_TIMEOUT)
                        );
                        
                        const checkPromise = supabase.from('volunteer_signups').select('id').limit(1);
                        const { error } = await Promise.race([checkPromise, timeoutPromise]);
                        
                        if (error) throw error;
                        
                        this.connectionStatus = 'connected';
                        console.log('‚úÖ Database connection verified');
                        
                    } catch (e) {
                        console.error('‚ùå Connection failed:', e);
                        throw new Error('Cannot connect to database. Please check your internet connection.');
                    }
                },

                async loadHistoricalData() {
                    if (supabase) {
                        try {
                            const { data, error } = await supabase.from('volunteer_signups').select('id').limit(1);
                            if (!error && data && data.length > 0) {
                                console.log('‚úì Historical data already exists');
                                return;
                            }
                        } catch (e) {
                            console.error('Error checking for existing data:', e);
                        }
                    }
                    
                    const hasHistoricalData = localStorage.getItem('uts-historical-loaded-to-supabase');
                    if (hasHistoricalData === 'true') {
                        console.log('‚úì Historical data already loaded');
                        return;
                    }

                    console.log('üì• Loading historical data...');

                    if (supabase) {
                        try {
                            const insertions = [];
                            
                            for (let rosterType in HISTORICAL_DATA) {
                                for (let dateStr in HISTORICAL_DATA[rosterType]) {
                                    for (let roleId in HISTORICAL_DATA[rosterType][dateStr]) {
                                        const volunteers = HISTORICAL_DATA[rosterType][dateStr][roleId];
                                        volunteers.forEach(v => {
                                            insertions.push({
                                                roster_type: rosterType,
                                                shift_date: dateStr,
                                                role_id: roleId,
                                                volunteer_name: v.name
                                            });
                                        });
                                    }
                                }
                            }

                            const batchSize = 50;
                            for (let i = 0; i < insertions.length; i += batchSize) {
                                const batch = insertions.slice(i, i + batchSize);
                                const { error } = await supabase.from('volunteer_signups').insert(batch);
                                if (error) throw error;
                            }

                            localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                            console.log('‚úÖ Historical data loaded successfully');
                            
                        } catch (e) {
                            console.error('Error loading historical data:', e);
                            throw new Error('Failed to load historical volunteer data');
                        }
                    }

                    this.createBackup();
                },

                autoBackup() {
                    try {
                        if (!this.validateData(this.signups)) {
                            console.error('Data validation failed - backup skipped');
                            return;
                        }
                        this.createBackup();
                    } catch (e) {
                        console.error('Auto-backup failed:', e);
                    }
                },

                getDayOfWeek(dateStr) {
                    const [year, month, day] = dateStr.split('-').map(Number);
                    
                    let m = month;
                    let y = year;
                    
                    if (m < 3) {
                        m += 12;
                        y--;
                    }
                    
                    const q = day;
                    const K = y % 100;
                    const J = Math.floor(y / 100);
                    
                    const h = (q + Math.floor((13 * (m + 1)) / 5) + K + Math.floor(K / 4) + Math.floor(J / 4) - (2 * J)) % 7;
                    
                    return (h + 6) % 7;
                },

                getDatesForPeriod() {
                    const period = this.periods.find(p => p.id === this.selectedPeriod);
                    if (!period) return [];
                    const dates = [];
                    
                    if (this.currentView === 'weekly-tasks') {
                        const targetDay = 3;
                        period.months.forEach(month => {
                            for (let day = 1; day <= 31; day++) {
                                const dateStr = `${period.year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                
                                const testDate = new Date(period.year, month - 1, day);
                                if (testDate.getMonth() !== month - 1) break;
                                
                                if (this.getDayOfWeek(dateStr) === targetDay) {
                                    const wed = new Date(period.year, month - 1, day);
                                    const thurs = new Date(period.year, month - 1, day + 1);
                                    
                                    dates.push({
                                        date: dateStr,
                                        label: `${wed.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })} - ${thurs.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })}`
                                    });
                                }
                            }
                        });
                    } else {
                        const targetDay = this.currentView === 'thursday-hall' ? 4 : 6;
                        period.months.forEach(month => {
                            for (let day = 1; day <= 31; day++) {
                                const dateStr = `${period.year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                
                                const testDate = new Date(period.year, month - 1, day);
                                if (testDate.getMonth() !== month - 1) break;
                                
                                if (this.getDayOfWeek(dateStr) === targetDay) {
                                    const date = new Date(period.year, month - 1, day);
                                    dates.push({
                                        date: dateStr,
                                        label: date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })
                                    });
                                }
                            }
                        });
                    }
                    return dates;
                },

                async loadSignups() {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            let allData = [];
                            let from = 0;
                            const pageSize = 1000;
                            let maxPages = 100;
                            
                            while (maxPages > 0) {
                                maxPages--;
                                
                                const { data, error } = await supabase
                                    .from('volunteer_signups')
                                    .select('*')
                                    .range(from, from + pageSize - 1);
                                    
                                if (error) throw error;
                                if (!data || data.length === 0) break;
                                
                                allData = allData.concat(data);
                                if (data.length < pageSize) break;
                                from += pageSize;
                            }
                            
                            console.log('üì• Loaded', allData.length, 'signups from database');
                            
                            this.signups = {};
                            allData.forEach(s => {
                                if (!this.signups[s.roster_type]) this.signups[s.roster_type] = {};
                                if (!this.signups[s.roster_type][s.shift_date]) this.signups[s.roster_type][s.shift_date] = {};
                                if (!this.signups[s.roster_type][s.shift_date][s.role_id]) this.signups[s.roster_type][s.shift_date][s.role_id] = [];
                                this.signups[s.roster_type][s.shift_date][s.role_id].push({
                                    id: s.id,
                                    name: s.volunteer_name
                                });
                            });
                            
                            if (!this.validateData(this.signups)) {
                                throw new Error('Loaded data failed validation');
                            }
                            this.connectionStatus = 'connected';
                            this.lastSaveTime = new Date();
                            this.createBackup();
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                console.error('Load failed after retries:', e);
                                this.connectionStatus = 'error';
                                throw new Error('Failed to load volunteer signups from database');
                            } else {
                                await new Promise(r => setTimeout(r, 1000));
                            }
                        }
                    }
                    
                    const savedNotes = localStorage.getItem('uts-date-notes');
                    if (savedNotes) {
                        try {
                            this.dateNotes = JSON.parse(savedNotes);
                        } catch (e) {
                            this.dateNotes = {};
                        }
                    }
                    const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
                    if (savedGiveaway) {
                        try {
                            this.giveawayDates = JSON.parse(savedGiveaway);
                        } catch (e) {
                            this.giveawayDates = {};
                        }
                    }
                    
                    if (this.isInitialized) {
                        this.render();
                    }
                },

                async loadSpecialEvents() {
                    try {
                        const { data, error } = await supabase.from('special_events').select('*');
                        if (error) throw error;
                        
                        this.specialEvents = (data || []).map(e => ({
                            id: e.id,
                            name: e.name,
                            dates: e.dates,
                            roles: e.roles,
                            visible: e.visible,
                            created: e.created_at
                        }));
                        
                        localStorage.setItem('uts-special-events', JSON.stringify(this.specialEvents));
                    } catch (e) {
                        console.error('Error loading special events:', e);
                        const savedEvents = localStorage.getItem('uts-special-events');
                        if (savedEvents) {
                            try {
                                this.specialEvents = JSON.parse(savedEvents);
                            } catch (e2) {
                                this.specialEvents = [];
                            }
                        }
                    }
                    
                    if (this.isInitialized) {
                        this.render();
                    }
                },

                async loadSettings() {
                    try {
                        const { data, error } = await supabase.from('roster_settings').select('*');
                        if (error) throw error;
                        
                        this.dateNotes = {};
                        this.giveawayDates = {};
                        
                        data.forEach(setting => {
                            if (setting.setting_type === 'note') {
                                this.dateNotes[setting.setting_key] = setting.setting_value;
                            } else if (setting.setting_type === 'giveaway') {
                                this.giveawayDates[setting.setting_key] = setting.setting_value === 'true';
                            }
                        });
                        
                        localStorage.setItem('uts-date-notes', JSON.stringify(this.dateNotes));
                        localStorage.setItem('uts-giveaway-dates', JSON.stringify(this.giveawayDates));
                    } catch (e) {
                        console.error('Error loading settings:', e);
                        const savedNotes = localStorage.getItem('uts-date-notes');
                        if (savedNotes) {
                            try {
                                this.dateNotes = JSON.parse(savedNotes);
                            } catch (e2) {
                                this.dateNotes = {};
                            }
                        }
                        const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
                        if (savedGiveaway) {
                            try {
                                this.giveawayDates = JSON.parse(savedGiveaway);
                            } catch (e2) {
                                this.giveawayDates = {};
                            }
                        }
                    }
                    
                    const savedPeriod = localStorage.getItem('uts-selected-period');
                    if (savedPeriod) {
                        this.selectedPeriod = savedPeriod;
                    }
                    
                    if (this.isInitialized) {
                        this.render();
                    }
                },

                async saveSpecialEvents() {
                    localStorage.setItem('uts-special-events', JSON.stringify(this.specialEvents));
                    
                    if (supabase) {
                        try {
                            await supabase.from('special_events').delete().neq('id', '');
                            
                            if (this.specialEvents.length > 0) {
                                const eventsToInsert = this.specialEvents.map(e => ({
                                    id: e.id,
                                    name: e.name,
                                    dates: e.dates,
                                    roles: e.roles,
                                    visible: e.visible,
                                    created_at: e.created,
                                    updated_at: new Date().toISOString()
                                }));
                                
                                const { error } = await supabase.from('special_events').insert(eventsToInsert);
                                if (error) throw error;
                            }
                        } catch (e) {
                            console.error('Error syncing special events:', e);
                            this.showNotification('Saved locally (offline mode)', 'warning');
                        }
                    }
                    
                    this.createBackup();
                },

                async createSpecialEvent(name, dates, roles, visible = true) {
                    const event = {
                        id: Date.now().toString(),
                        name: name.trim(),
                        dates: dates,
                        roles: roles,
                        visible: visible,
                        created: new Date().toISOString()
                    };
                    this.specialEvents.push(event);
                    
                    this.signups[event.id] = {};
                    dates.forEach(dateStr => {
                        this.signups[event.id][dateStr] = {};
                        roles.forEach(role => {
                            this.signups[event.id][dateStr][role.id] = [];
                        });
                    });
                    
                    await this.saveSpecialEvents();
                    localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                    this.showNotification(`Event "${name}" created!`);
                    return event.id;
                },

                async updateSpecialEvent(eventId, updates) {
                    const eventIndex = this.specialEvents.findIndex(e => e.id === eventId);
                    if (eventIndex === -1) return;
                    
                    this.specialEvents[eventIndex] = { ...this.specialEvents[eventIndex], ...updates };
                    await this.saveSpecialEvents();
                    this.showNotification('Event updated!');
                },

                async deleteSpecialEvent(eventId) {
                    const event = this.specialEvents.find(e => e.id === eventId);
                    if (!event) return;
                    
                    if (!confirm(`Delete event "${event.name}"? This will remove all volunteer signups for this event.`)) return;
                    
                    this.specialEvents = this.specialEvents.filter(e => e.id !== eventId);
                    delete this.signups[eventId];
                    
                    await this.saveSpecialEvents();
                    localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                    this.showNotification('Event deleted');
                },

                async toggleEventVisibility(eventId) {
                    const event = this.specialEvents.find(e => e.id === eventId);
                    if (!event) return;
                    
                    event.visible = !event.visible;
                    await this.saveSpecialEvents();
                    this.showNotification(event.visible ? 'Event visible on welcome screen' : 'Event hidden from welcome screen');
                },

                async saveNote(view, dateStr, note) {
                    const key = `${view}-${dateStr}`;
                    if (note.trim()) {
                        this.dateNotes[key] = note.trim();
                    } else {
                        delete this.dateNotes[key];
                    }
                    
                    localStorage.setItem('uts-date-notes', JSON.stringify(this.dateNotes));
                    
                    if (supabase) {
                        try {
                            if (note.trim()) {
                                await supabase.from('roster_settings').upsert({
                                    setting_type: 'note',
                                    setting_key: key,
                                    setting_value: note.trim(),
                                    updated_at: new Date().toISOString()
                                }, { onConflict: 'setting_type,setting_key' });
                            } else {
                                await supabase.from('roster_settings').delete()
                                    .eq('setting_type', 'note')
                                    .eq('setting_key', key);
                            }
                        } catch (e) {
                            console.error('Error syncing note:', e);
                        }
                    }
                    
                    this.showNotification('Note saved');
                },

                getNote(view, dateStr) {
                    const key = `${view}-${dateStr}`;
                    return this.dateNotes[key] || '';
                },

                async addSignup() {
                    if (!this.volunteerName.trim()) return alert('Please enter your name');
                    const { view, dateStr, roleId } = this.selectedSlot;
                    
                    const role = this.getVisibleRoles(view).find(r => r.id === roleId);
                    const currentSignups = this.getSignups(view, dateStr, roleId);
                    
                    if (currentSignups.length >= role.capacity) {
                        const override = confirm(`‚ö†Ô∏è This role is at full capacity (${role.capacity}/${role.capacity}).\n\nDo you want to add an extra volunteer anyway?`);
                        if (!override) {
                            return;
                        }
                    }
                    
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { data, error } = await supabase.from('volunteer_signups').insert({
                                roster_type: view,
                                shift_date: dateStr,
                                role_id: roleId,
                                volunteer_name: this.volunteerName.trim()
                            }).select();
                            if (error) throw error;
                            await this.loadSignups();
                            this.showNotification('‚úì Signed up successfully!');
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                this.showNotification('Error signing up. Please try again.', 'error');
                                return;
                            }
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                    
                    this.showModal = false;
                    this.volunteerName = '';
                    this.render();
                },

                async removeSignup(view, dateStr, roleId, signup) {
                    if (!confirm(`Remove ${signup.name}?`)) return;
                    
                    this.createBackup();

                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { error } = await supabase.from('volunteer_signups').delete().eq('id', signup.id);
                            if (error) throw error;
                            await this.loadSignups();
                            this.showNotification('‚úì Removed successfully');
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                this.showNotification('Error removing. Please try again.', 'error');
                                return;
                            }
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                    this.render();
                },

                getSignups(view, dateStr, roleId) {
                    return this.signups[view]?.[dateStr]?.[roleId] || [];
                },

                getNextShiftStats() {
                    if (this.currentView === 'weekly-tasks') return null;
                    
                    const nextDate = this.getNextUpcomingDate(this.currentView);
                    if (!nextDate) return null;
                    
                    const roles = this.getVisibleRoles(this.currentView);
                    let totalSlots = 0;
                    let filledSlots = 0;
                    
                    roles.forEach(role => {
                        if (role.id === 'giveaway' && !this.isGiveawayEnabled(this.currentView, nextDate)) {
                            return;
                        }
                        
                        const signups = this.getSignups(this.currentView, nextDate, role.id);
                        totalSlots += role.capacity;
                        filledSlots += Math.min(signups.length, role.capacity);
                    });

                    const [year, month, day] = nextDate.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    const dateLabel = date.toLocaleDateString('en-NZ', { 
                        weekday: 'long', day: 'numeric', month: 'long'
                    });

                    return { 
                        totalSlots, 
                        filledSlots, 
                        coverage: Math.round((filledSlots / totalSlots) * 100),
                        dateLabel,
                        needsHelp: totalSlots - filledSlots
                    };
                },

                getRosterStats() {
                    const dates = this.getDatesForPeriod();
                    const roles = this.getVisibleRoles(this.currentView);
                    let totalSlots = 0;
                    let filledSlots = 0;
                    let needsHelp = 0;
                    
                    dates.forEach(d => {
                        roles.forEach(role => {
                            const signups = this.getSignups(this.currentView, d.date, role.id);
                            totalSlots += role.capacity;
                            filledSlots += Math.min(signups.length, role.capacity);
                            if (signups.length < role.capacity) needsHelp++;
                        });
                    });
                    
                    return { totalSlots, filledSlots, needsHelp, coverage: Math.round((filledSlots / totalSlots) * 100) };
                },

                loginAdmin() {
                    const password = prompt('Enter admin password:');
                    if (password === ADMIN_PASSWORD) {
                        this.isAdmin = true;
                        this.currentView = 'admin';
                        this.pushState();
                        this.render();
                    } else if (password !== null) {
                        alert('Incorrect password');
                    }
                },

                logoutAdmin() {
                    this.isAdmin = false;
                    this.currentView = 'welcome';
                    this.pushState();
                    this.render();
                },

                addNextQuarter() {
                    const lastPeriod = this.periods[this.periods.length - 1];
                    const lastYear = lastPeriod.year;
                    const lastMonths = lastPeriod.months;
                    const lastMonth = lastMonths[lastMonths.length - 1];
                    
                    let newYear = lastYear;
                    let newMonths = [];
                    let startMonth = lastMonth + 1;
                    
                    if (startMonth > 12) {
                        startMonth = 1;
                        newYear++;
                    }
                    
                    for (let i = 0; i < 3; i++) {
                        let month = startMonth + i;
                        if (month > 12) {
                            month = month - 12;
                            newYear = lastYear + 1;
                        }
                        newMonths.push(month);
                    }
                    
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const label = `${monthNames[newMonths[0]-1]} - ${monthNames[newMonths[2]-1]} ${newYear}`;
                    const id = `${monthNames[newMonths[0]-1].toLowerCase()}-${monthNames[newMonths[2]-1].toLowerCase()}-${newYear}`;
                    
                    this.periods.push({
                        id: id,
                        label: label,
                        months: newMonths,
                        year: newYear
                    });
                    
                    this.showNotification(`Added quarter: ${label}`, 'success');
                    this.render();
                },

                exportToCSV() {
                    const rows = [['Date', 'Day', 'Roster Type', 'Role', 'Time', 'Volunteer', 'Capacity']];
                    
                    for (let rosterType in this.signups) {
                        const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                          rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';
                        
                        for (let dateStr in this.signups[rosterType]) {
                            const [year, month, day] = dateStr.split('-').map(Number);
                            const date = new Date(year, month - 1, day);
                            const dayName = date.toLocaleDateString('en-NZ', { weekday: 'long' });
                            const dateLabel = date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short', year: 'numeric' });
                            
                            for (let roleId in this.signups[rosterType][dateStr]) {
                                const role = this.roles[rosterType]?.find(r => r.id === roleId);
                                const volunteers = this.signups[rosterType][dateStr][roleId];
                                
                                if (volunteers.length === 0) {
                                    rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', '(empty)', role?.capacity || '']);
                                } else {
                                    volunteers.forEach(v => {
                                        rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', v.name, role?.capacity || '']);
                                    });
                                }
                            }
                        }
                    }
                    
                    const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `uts-roster-${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showNotification('CSV exported successfully!');
                },

                generateReport() {
                    const stats = {
                        totalSignups: 0,
                        volunteerList: new Set(),
                        byRoster: {},
                        coverageByDate: {},
                        volunteerCounts: {},
                        volunteersByRole: {
                            managers: new Set(),
                            hallHelp: new Set(),
                            drinks: new Set(),
                            dishes: new Set(),
                            laundry: new Set()
                        },
                        volunteerCountsByRole: {
                            managers: {},
                            hallHelp: {},
                            drinks: {},
                            dishes: {},
                            laundry: {}
                        }
                    };
                    
                    for (let rosterType in this.signups) {
                        stats.byRoster[rosterType] = { total: 0, volunteers: new Set() };
                        
                        for (let dateStr in this.signups[rosterType]) {
                            if (!stats.coverageByDate[dateStr]) {
                                stats.coverageByDate[dateStr] = { filled: 0, total: 0 };
                            }
                            
                            for (let roleId in this.signups[rosterType][dateStr]) {
                                const role = this.roles[rosterType]?.find(r => r.id === roleId);
                                const volunteers = this.signups[rosterType][dateStr][roleId];
                                
                                stats.totalSignups += volunteers.length;
                                stats.byRoster[rosterType].total += volunteers.length;
                                stats.coverageByDate[dateStr].filled += volunteers.length;
                                stats.coverageByDate[dateStr].total += role?.capacity || 1;
                                
                                volunteers.forEach(v => {
                                    const fullName = v.name.trim();
                                    stats.volunteerList.add(fullName);
                                    stats.byRoster[rosterType].volunteers.add(fullName);
                                    
                                    if (!stats.volunteerCounts[fullName]) {
                                        stats.volunteerCounts[fullName] = 0;
                                    }
                                    stats.volunteerCounts[fullName]++;
                                    
                                    if (roleId === 'managers') {
                                        stats.volunteersByRole.managers.add(fullName);
                                        if (!stats.volunteerCountsByRole.managers[fullName]) {
                                            stats.volunteerCountsByRole.managers[fullName] = 0;
                                        }
                                        stats.volunteerCountsByRole.managers[fullName]++;
                                    } else if (roleId.includes('hall-help')) {
                                        stats.volunteersByRole.hallHelp.add(fullName);
                                        if (!stats.volunteerCountsByRole.hallHelp[fullName]) {
                                            stats.volunteerCountsByRole.hallHelp[fullName] = 0;
                                        }
                                        stats.volunteerCountsByRole.hallHelp[fullName]++;
                                    } else if (roleId === 'drinks') {
                                        stats.volunteersByRole.drinks.add(fullName);
                                        if (!stats.volunteerCountsByRole.drinks[fullName]) {
                                            stats.volunteerCountsByRole.drinks[fullName] = 0;
                                        }
                                        stats.volunteerCountsByRole.drinks[fullName]++;
                                    } else if (roleId === 'dishes') {
                                        stats.volunteersByRole.dishes.add(fullName);
                                        if (!stats.volunteerCountsByRole.dishes[fullName]) {
                                            stats.volunteerCountsByRole.dishes[fullName] = 0;
                                        }
                                        stats.volunteerCountsByRole.dishes[fullName]++;
                                    } else if (roleId === 'laundry') {
                                        stats.volunteersByRole.laundry.add(fullName);
                                        if (!stats.volunteerCountsByRole.laundry[fullName]) {
                                            stats.volunteerCountsByRole.laundry[fullName] = 0;
                                        }
                                        stats.volunteerCountsByRole.laundry[fullName]++;
                                    }
                                });
                            }
                        }
                    }
                    
                    stats.topVolunteers = Object.entries(stats.volunteerCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10);
                    
                    stats.topByRole = {
                        managers: Object.entries(stats.volunteerCountsByRole.managers)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10),
                        hallHelp: Object.entries(stats.volunteerCountsByRole.hallHelp)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10),
                        drinks: Object.entries(stats.volunteerCountsByRole.drinks)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10),
                        dishes: Object.entries(stats.volunteerCountsByRole.dishes)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10),
                        laundry: Object.entries(stats.volunteerCountsByRole.laundry)
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 10)
                    };
                    
                    return stats;
                },

                downloadBackup() {
                    const backup = {
                        data: this.signups,
                        periods: this.periods,
                        timestamp: new Date().toISOString(),
                        version: '1.0'
                    };
                    
                    const json = JSON.stringify(backup, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `uts-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.showNotification('Backup downloaded!');
                },

                uploadBackup() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const backup = JSON.parse(event.target.result);
                                if (backup.data && this.validateData(backup.data)) {
                                    this.signups = backup.data;
                                    if (backup.periods && Array.isArray(backup.periods)) {
                                        this.periods = backup.periods;
                                    }
                                    this.createBackup();
                                    this.showNotification('Backup restored successfully!');
                                    this.render();
                                } else {
                                    throw new Error('Invalid backup file');
                                }
                            } catch (e) {
                                this.showNotification('Error loading backup: ' + e.message, 'error');
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                },

                navigateTo(view, extraState = {}) {
                    this.currentView = view;
                    Object.assign(this, extraState);
                    this.pushState();
                    this.render();
                },

                pushState() {
                    const state = {
                        view: this.currentView,
                        period: this.selectedPeriod,
                        showMySignups: this.showMySignups,
                        isAdmin: this.isAdmin,
                        adminView: this.adminView
                    };
                    
                    const title = this.currentView === 'welcome' ? 'Under the Stars - Home' :
                                 this.currentView === 'admin' ? 'Under the Stars - Admin' :
                                 this.currentView === 'thursday-hall' ? 'Thursday Hall Help' :
                                 this.currentView === 'saturday-hall' ? 'Saturday Hall Help' :
                                 'Under the Stars';
                    
                    history.pushState(state, title, window.location.pathname);
                },

                render() {
                    const appEl = document.getElementById('app');
                    
                    if (this.isLoading) {
                        appEl.innerHTML = `
                            <div class="min-h-screen flex items-center justify-center">
                                <div class="text-center">
                                    <div class="loading-spinner mx-auto mb-4"></div>
                                    <p class="text-gray-600">Loading roster...</p>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    if (this.showMySignups) {
                        appEl.innerHTML = this.renderMySignups();
                    } else if (this.currentView === 'welcome') {
                        appEl.innerHTML = this.renderWelcome();
                    } else if (this.currentView === 'admin') {
                        appEl.innerHTML = this.renderAdmin();
                    } else {
                        appEl.innerHTML = this.renderRoster();
                    }
                },renderWelcome() {
                    const visibleEvents = this.specialEvents.filter(e => e.visible);
                    
                    return `
                        <div class="min-h-screen p-4 md:p-8">
                            <div class="max-w-4xl mx-auto">
                                <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                                    <div class="text-center mb-8">
                                        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-3">
                                            Under the Stars
                                        </h1>
                                        <p class="text-xl text-gray-600">Volunteer Roster</p>
                                    </div>

                                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                                        <button onclick="app.navigateTo('thursday-hall')" 
                                                class="bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white p-8 rounded-xl shadow-lg transition transform hover:scale-105">
                                            <div class="text-3xl mb-2">üçΩÔ∏è</div>
                                            <div class="text-2xl font-bold mb-2">Thursday Hall Help</div>
                                            <div class="text-purple-100 text-sm">10:00am - 1:30pm</div>
                                        </button>

                                        <button onclick="app.navigateTo('saturday-hall')" 
                                                class="bg-gradient-to-br from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white p-8 rounded-xl shadow-lg transition transform hover:scale-105">
                                            <div class="text-3xl mb-2">üåÖ</div>
                                            <div class="text-2xl font-bold mb-2">Saturday Hall Help</div>
                                            <div class="text-pink-100 text-sm">3:00pm - 6:30pm</div>
                                        </button>
                                    </div>

                                    <button onclick="app.navigateTo('weekly-tasks')" 
                                            class="w-full bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white p-6 rounded-xl shadow-lg transition transform hover:scale-105 mb-6">
                                        <div class="text-3xl mb-2">üì¶</div>
                                        <div class="text-xl font-bold mb-1">Additional Weekly Tasks</div>
                                        <div class="text-orange-100 text-sm">Pickups & Special Roles</div>
                                    </button>

                                    ${visibleEvents.length > 0 ? `
                                        <div class="border-t pt-6 mt-6">
                                            <h3 class="text-lg font-bold text-gray-700 mb-4">üåü Special Events</h3>
                                            <div class="space-y-3">
                                                ${visibleEvents.map(event => `
                                                    <button onclick="app.navigateTo('${event.id}')"
                                                            class="w-full bg-gradient-to-br from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white p-4 rounded-lg shadow transition transform hover:scale-105">
                                                        <div class="font-bold">${event.name}</div>
                                                        <div class="text-indigo-100 text-sm">${event.dates.length} date${event.dates.length !== 1 ? 's' : ''}</div>
                                                    </button>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    <div class="border-t pt-6 mt-6">
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                            <h3 class="font-bold text-blue-900 mb-2">üîç Find Your Signups</h3>
                                            <div class="flex gap-2">
                                                <input type="text" 
                                                       placeholder="Enter your name..." 
                                                       value="${this.searchName}"
                                                       oninput="app.searchName = this.value"
                                                       onkeypress="if(event.key === 'Enter') app.getMySignups()"
                                                       class="flex-1 px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <button onclick="app.getMySignups()" 
                                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold">
                                                    Search
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                ${this.isAdmin ? `
                                    <div class="text-center mb-6">
                                        <button onclick="app.navigateTo('admin')" 
                                                class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-3 rounded-lg font-semibold">
                                            üîß Admin Dashboard
                                        </button>
                                    </div>
                                ` : `
                                    <div class="text-center">
                                        <button onclick="app.loginAdmin()" 
                                                class="text-gray-500 hover:text-gray-700 text-sm">
                                            Admin Login
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    `;
                },

                renderMySignups() {
                    return `
                        <div class="min-h-screen p-4 md:p-8">
                            <div class="max-w-4xl mx-auto">
                                <div class="bg-white rounded-2xl shadow-xl p-8">
                                    <div class="flex items-center justify-between mb-6">
                                        <h2 class="text-3xl font-bold text-gray-800">Your Signups</h2>
                                        <button onclick="app.showMySignups = false; app.render();" 
                                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                                            ‚Üê Back
                                        </button>
                                    </div>

                                    ${this.mySignupsList && this.mySignupsList.length > 0 ? `
                                        <div class="mb-4">
                                            <p class="text-gray-600">
                                                Found <strong>${this.mySignupsList.length}</strong> signup${this.mySignupsList.length !== 1 ? 's' : ''} for 
                                                <strong>${this.searchName}</strong>
                                            </p>
                                        </div>

                                        <div class="space-y-4">
                                            ${this.mySignupsList.map(signup => `
                                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <div class="font-bold text-lg text-gray-800">${signup.dateLabel}</div>
                                                            <div class="text-gray-600 mt-1">${signup.roster}</div>
                                                            <div class="text-purple-600 font-semibold">${signup.role}</div>
                                                            ${signup.time ? `<div class="text-sm text-gray-500">‚è∞ ${signup.time}</div>` : ''}
                                                        </div>
                                                        <div class="text-2xl">
                                                            ${new Date(signup.date) < new Date() ? '‚úÖ' : 'üìÖ'}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="text-center py-12">
                                            <div class="text-6xl mb-4">üîç</div>
                                            <p class="text-gray-600">No signups found</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                },

                renderRoster() {
                    const dates = this.getDatesForPeriod();
                    const roles = this.getVisibleRoles(this.currentView);
                    const stats = this.getRosterStats();
                    const nextShiftStats = this.getNextShiftStats();
                    const period = this.periods.find(p => p.id === this.selectedPeriod);
                    
                    const viewTitle = this.currentView === 'thursday-hall' ? 'Thursday Hall Help' :
                                     this.currentView === 'saturday-hall' ? 'Saturday Hall Help' :
                                     this.currentView === 'weekly-tasks' ? 'Additional Weekly Tasks' :
                                     this.specialEvents.find(e => e.id === this.currentView)?.name || 'Roster';

                    return `
                        <div class="min-h-screen p-2 md:p-4">
                            <div class="max-w-7xl mx-auto">
                                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-4 no-print">
                                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                                        <div>
                                            <button onclick="app.navigateTo('welcome')" 
                                                    class="text-purple-600 hover:text-purple-800 font-semibold mb-2 inline-block">
                                                ‚Üê Home
                                            </button>
                                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">${viewTitle}</h1>
                                        </div>
                                        
                                        <div class="flex flex-col sm:flex-row gap-2">
                                            <select onchange="app.selectedPeriod = this.value; localStorage.setItem('uts-selected-period', this.value); app.render();" 
                                                    class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                ${this.periods.map(p => `
                                                    <option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>
                                                        ${p.label}
                                                    </option>
                                                `).join('')}
                                            </select>
                                            ${this.isAdmin ? `
                                                <button onclick="window.print()" 
                                                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold">
                                                    üñ®Ô∏è Print
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>

                                    ${nextShiftStats ? `
                                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-sm font-semibold text-blue-900 mb-1">üìç NEXT SHIFT</div>
                                                    <div class="text-lg font-bold text-blue-800">${nextShiftStats.dateLabel}</div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-2xl font-bold ${nextShiftStats.coverage >= 90 ? 'text-green-600' : nextShiftStats.coverage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                                        ${nextShiftStats.filledSlots}/${nextShiftStats.totalSlots}
                                                    </div>
                                                    <div class="text-sm text-gray-600">
                                                        ${nextShiftStats.needsHelp > 0 ? `Need ${nextShiftStats.needsHelp} more!` : 'Fully covered! ‚úÖ'}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <div class="progress-bar">
                                                    <div class="progress-fill ${nextShiftStats.coverage >= 90 ? 'bg-green-500' : nextShiftStats.coverage >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                                         style="width: ${nextShiftStats.coverage}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}

                                    <div class="grid grid-cols-3 gap-3 text-center">
                                        <div class="bg-gray-50 rounded-lg p-3">
                                            <div class="text-2xl font-bold text-gray-800">${stats.filledSlots}/${stats.totalSlots}</div>
                                            <div class="text-xs text-gray-600">Slots Filled</div>
                                        </div>
                                        <div class="bg-gray-50 rounded-lg p-3">
                                            <div class="text-2xl font-bold ${stats.coverage >= 90 ? 'text-green-600' : stats.coverage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                                ${stats.coverage}%
                                            </div>
                                            <div class="text-xs text-gray-600">Coverage</div>
                                        </div>
                                        <div class="bg-gray-50 rounded-lg p-3">
                                            <div class="text-2xl font-bold text-gray-800">${stats.needsHelp}</div>
                                            <div class="text-xs text-gray-600">Need Help</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow-lg overflow-hidden print-full-width">
                                    <div class="table-container">
                                        <table class="w-full border-collapse">
                                            <thead class="bg-gradient-to-r from-purple-600 to-pink-600 text-white sticky top-0 z-10">
                                                <tr>
                                                    <th class="px-2 py-3 text-left font-semibold text-sm md:text-base border-r border-white/20">Role</th>
                                                    ${dates.map(d => `
                                                        <th class="px-2 py-2 text-center font-semibold text-xs md:text-sm border-r border-white/20 whitespace-nowrap ${this.getDateClass(d.date)}">
                                                            ${d.date === this.getNextUpcomingDate(this.currentView) ? '<span class="next-shift-badge">NEXT</span>' : ''}
                                                            ${d.label}
                                                        </th>
                                                    `).join('')}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${roles.map((role, idx) => {
                                                    const isGiveaway = role.id === 'giveaway';
                                                    
                                                    return `
                                                        <tr class="border-b hover:bg-gray-50">
                                                            <td class="px-2 py-3 font-semibold bg-gray-50 border-r border-gray-200 role-cell">
                                                                <div class="text-sm md:text-base text-gray-800">${role.name}</div>
                                                                <div class="text-xs text-gray-500">${role.time}</div>
                                                                <div class="text-xs text-gray-400">Need: ${role.capacity}</div>
                                                            </td>
                                                            ${dates.map(d => {
                                                                const signups = this.getSignups(this.currentView, d.date, role.id);
                                                                const filledCount = Math.min(signups.length, role.capacity);
                                                                const coverageClass = this.getCoverageClass(filledCount, role.capacity);
                                                                const dateClass = this.getDateClass(d.date);
                                                                const note = this.getNote(this.currentView, d.date);
                                                                const giveawayEnabled = isGiveaway ? this.isGiveawayEnabled(this.currentView, d.date) : true;
                                                                
                                                                return `
                                                                    <td class="px-2 py-2 text-center border-r border-gray-200 align-top ${dateClass} ${giveawayEnabled ? coverageClass : 'giveaway-disabled'}">
                                                                        ${!giveawayEnabled ? `
                                                                            <div class="text-xs text-gray-400 italic">Not scheduled</div>
                                                                            ${this.isAdmin ? `
                                                                                <button onclick="app.toggleGiveaway('${this.currentView}', '${d.date}')" 
                                                                                        class="text-xs text-blue-600 hover:text-blue-800 mt-1">
                                                                                    Enable
                                                                                </button>
                                                                            ` : ''}
                                                                        ` : `
                                                                            <div class="text-xs font-semibold mb-1 ${filledCount >= role.capacity ? 'text-green-700' : 'text-red-700'}">
                                                                                ${filledCount}/${role.capacity}
                                                                            </div>
                                                                            ${signups.map(signup => {
                                                                                const isEditing = this.editingSignup && 
                                                                                                this.editingSignup.signup.id === signup.id;
                                                                                
                                                                                return `
                                                                                    <div class="volunteer-item text-xs mb-1 px-1 py-0.5 bg-white rounded border border-gray-200 flex items-center justify-between group">
                                                                                        ${isEditing ? `
                                                                                            <input type="text" 
                                                                                                   value="${signup.name}"
                                                                                                   id="edit-input-${signup.id}"
                                                                                                   class="edit-mode flex-1 text-xs"
                                                                                                   onkeypress="if(event.key === 'Enter') app.saveEdit(this.value)">
                                                                                            <button onclick="app.saveEdit(document.getElementById('edit-input-${signup.id}').value)" 
                                                                                                    class="text-green-600 hover:text-green-800 ml-1">‚úì</button>
                                                                                            <button onclick="app.cancelEdit()" 
                                                                                                    class="text-red-600 hover:text-red-800 ml-1">‚úï</button>
                                                                                        ` : `
                                                                                            <span class="flex-1 text-left truncate">${signup.name}</span>
                                                                                            ${this.isAdmin ? `
                                                                                                <span class="edit-icon text-blue-600 ml-1" 
                                                                                                      onclick="app.startEdit('${this.currentView}', '${d.date}', '${role.id}', ${JSON.stringify(signup).replace(/"/g, '&quot;')})">‚úèÔ∏è</span>
                                                                                                <span class="edit-icon text-red-600 ml-1" 
                                                                                                      onclick="app.removeSignup('${this.currentView}', '${d.date}', '${role.id}', ${JSON.stringify(signup).replace(/"/g, '&quot;')})">‚úï</span>
                                                                                            ` : ''}
                                                                                        `}
                                                                                    </div>
                                                                                `;
                                                                            }).join('')}
                                                                            ${signups.length < role.capacity ? `
                                                                                <button onclick="app.selectedSlot = {view: '${this.currentView}', dateStr: '${d.date}', roleId: '${role.id}'}; app.showModal = true; app.render();" 
                                                                                        class="text-xs bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded mt-1 no-print">
                                                                                    + Sign Up
                                                                                </button>
                                                                            ` : ''}
                                                                            ${isGiveaway && this.isAdmin ? `
                                                                                <button onclick="app.toggleGiveaway('${this.currentView}', '${d.date}')" 
                                                                                        class="text-xs text-red-600 hover:text-red-800 mt-1">
                                                                                    Disable
                                                                                </button>
                                                                            ` : ''}
                                                                            ${note && idx === 0 ? `
                                                                                <div class="text-xs bg-yellow-100 border border-yellow-300 text-yellow-800 px-2 py-1 rounded mt-2">
                                                                                    üìå ${note}
                                                                                </div>
                                                                            ` : ''}
                                                                        `}
                                                                    </td>
                                                                `;
                                                            }).join('')}
                                                        </tr>
                                                    `;
                                                }).join('')}
                                                ${this.isAdmin ? `
                                                    <tr class="bg-gray-50 no-print">
                                                        <td class="px-2 py-2 font-semibold border-r">Notes</td>
                                                        ${dates.map(d => {
                                                            const note = this.getNote(this.currentView, d.date);
                                                            return `
                                                                <td class="px-2 py-2 border-r">
                                                                    <input type="text" 
                                                                           value="${note}"
                                                                           onchange="app.saveNote('${this.currentView}', '${d.date}', this.value)"
                                                                           placeholder="Add note..."
                                                                           class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
                                                                </td>
                                                            `;
                                                        }).join('')}
                                                    </tr>
                                                ` : ''}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                ${this.showModal ? `
                                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" 
                                         onclick="if(event.target === this) { app.showModal = false; app.render(); }">
                                        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
                                            <h3 class="text-2xl font-bold mb-4 text-gray-800">Sign Up for Shift</h3>
                                            <div class="mb-4">
                                                <label class="block text-sm font-semibold text-gray-700 mb-2">Your Name</label>
                                                <input type="text" 
                                                       value="${this.volunteerName}"
                                                       oninput="app.volunteerName = this.value"
                                                       onkeypress="if(event.key === 'Enter') app.addSignup()"
                                                       placeholder="Enter your full name"
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                       autofocus>
                                            </div>
                                            <div class="flex gap-3">
                                                <button onclick="app.addSignup()" 
                                                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg">
                                                    Confirm Sign Up
                                                </button>
                                                <button onclick="app.showModal = false; app.volunteerName = ''; app.render();" 
                                                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-lg">
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                },

                renderAdmin() {
                    const stats = this.generateReport();
                    
                    return `
                        <div class="min-h-screen p-4 md:p-8 bg-gray-100">
                            <div class="max-w-6xl mx-auto">
                                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                                    <div class="flex items-center justify-between mb-6">
                                        <h1 class="text-3xl font-bold text-gray-800">üîß Admin Dashboard</h1>
                                        <div class="flex gap-2">
                                            <button onclick="app.navigateTo('welcome')" 
                                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                                                ‚Üê Home
                                            </button>
                                            <button onclick="app.logoutAdmin()" 
                                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                                                Logout
                                            </button>
                                        </div>
                                    </div>

                                    <div class="flex gap-2 border-b mb-6">
                                        <button onclick="app.adminView = 'dashboard'; app.render();" 
                                                class="px-4 py-2 font-semibold ${this.adminView === 'dashboard' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}">
                                            Dashboard
                                        </button>
                                        <button onclick="app.adminView = 'reports'; app.render();" 
                                                class="px-4 py-2 font-semibold ${this.adminView === 'reports' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}">
                                            Reports
                                        </button>
                                        <button onclick="app.adminView = 'backup'; app.render();" 
                                                class="px-4 py-2 font-semibold ${this.adminView === 'backup' ? 'border-b-2 border-purple-600 text-purple-600' : 'text-gray-600'}">
                                            Backup
                                        </button>
                                    </div>

                                    ${this.adminView === 'dashboard' ? `
                                        <div class="space-y-6">
                                            <div>
                                                <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
                                                <div class="grid md:grid-cols-2 gap-4">
                                                    <button onclick="app.exportToCSV()" 
                                                            class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg font-semibold">
                                                        üìä Export to CSV
                                                    </button>
                                                    <button onclick="app.addNextQuarter()" 
                                                            class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg font-semibold">
                                                        ‚ûï Add Next Quarter
                                                    </button>
                                                </div>
                                            </div>

                                            <div>
                                                <h3 class="text-xl font-bold mb-4">System Status</h3>
                                                <div class="bg-gray-50 rounded-lg p-4">
                                                    <div class="grid md:grid-cols-2 gap-4">
                                                        <div>
                                                            <div class="text-sm text-gray-600">Database Connection</div>
                                                            <div class="text-lg font-bold ${this.connectionStatus === 'connected' ? 'text-green-600' : 'text-red-600'}">
                                                                ${this.connectionStatus === 'connected' ? '‚úÖ Connected' : '‚ùå Disconnected'}
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <div class="text-sm text-gray-600">Total Signups</div>
                                                            <div class="text-lg font-bold text-gray-800">${stats.totalSignups}</div>
                                                        </div>
                                                        <div>
                                                            <div class="text-sm text-gray-600">Unique Volunteers</div>
                                                            <div class="text-lg font-bold text-gray-800">${stats.volunteerList.size}</div>
                                                        </div>
                                                        <div>
                                                            <div class="text-sm text-gray-600">Available Periods</div>
                                                            <div class="text-lg font-bold text-gray-800">${this.periods.length}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ` : this.adminView === 'reports' ? `
                                        <div class="space-y-6">
                                            <div>
                                                <h3 class="text-xl font-bold mb-4">Top Volunteers (All Time)</h3>
                                                <div class="bg-gray-50 rounded-lg p-4">
                                                    <table class="w-full">
                                                        <thead>
                                                            <tr class="border-b">
                                                                <th class="text-left py-2">Rank</th>
                                                                <th class="text-left py-2">Name</th>
                                                                <th class="text-right py-2">Shifts</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${stats.topVolunteers.map(([name, count], idx) => `
                                                                <tr class="border-b">
                                                                    <td class="py-2">
                                                                        ${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : idx + 1}
                                                                    </td>
                                                                    <td class="py-2 font-semibold">${name}</td>
                                                                    <td class="text-right py-2">${count}</td>
                                                                </tr>
                                                            `).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            <div>
                                                <h3 class="text-xl font-bold mb-4">By Roster Type</h3>
                                                <div class="grid md:grid-cols-3 gap-4">
                                                    ${Object.entries(stats.byRoster).map(([type, data]) => `
                                                        <div class="bg-gray-50 rounded-lg p-4">
                                                            <div class="text-sm text-gray-600 mb-2">
                                                                ${type === 'thursday-hall' ? 'Thursday Hall' : type === 'saturday-hall' ? 'Saturday Hall' : 'Weekly Tasks'}
                                                            </div>
                                                            <div class="text-2xl font-bold text-gray-800">${data.total}</div>
                                                            <div class="text-xs text-gray-500">${data.volunteers.size} volunteers</div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="space-y-6">
                                            <div>
                                                <h3 class="text-xl font-bold mb-4">Backup & Restore</h3>
                                                <div class="grid md:grid-cols-2 gap-4">
                                                    <button onclick="app.downloadBackup()" 
                                                            class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg font-semibold">
                                                        üíæ Download Backup
                                                    </button>
                                                    <button onclick="app.uploadBackup()" 
                                                            class="bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-lg font-semibold">
                                                        üìÇ Restore from Backup
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                                                <h4 class="font-bold text-yellow-900 mb-2">‚ö†Ô∏è Important Notes</h4>
                                                <ul class="text-sm text-yellow-800 space-y-1 list-disc list-inside">
                                                    <li>Backups are automatically created every 5 minutes</li>
                                                    <li>Cloud backups are stored in Supabase</li>
                                                    <li>Local backups are stored in your browser</li>
                                                    <li>Download backups regularly for safety</li>
                                                </ul>
                                            </div>

                                            <div>
                                                <h4 class="font-bold text-gray-800 mb-3">Recent Backups</h4>
                                                <div class="bg-gray-50 rounded-lg p-4">
                                                    ${this.getBackups().slice(-5).reverse().map(backup => `
                                                        <div class="border-b last:border-b-0 py-2">
                                                            <div class="text-sm font-semibold text-gray-700">
                                                                ${new Date(backup.timestamp).toLocaleString('en-NZ')}
                                                            </div>
                                                            <div class="text-xs text-gray-500">
                                                                Version ${backup.version}
                                                            </div>
                                                        </div>
                                                    `).join('') || '<div class="text-gray-500 text-center py-4">No local backups found</div>'}
                                                </div>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }
            };

            // Start the app
            try {
                app.init();
            } catch (e) {
                console.error('‚ùå Failed to start app:', e);
                showError('Startup Failed', 'The roster app failed to start: ' + e.message);
            }
        })();
    </script>
</body>
</html>
