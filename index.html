<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under the Stars Volunteer Roster</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
    <div id="app"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://evhjncobivtsxeeqvlue.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aGpuY29iaXZ0c3hlZXF2bHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDAyMTUsImV4cCI6MjA3NzM3NjIxNX0.NZKMBV8WKbef8ADsWAYlgtWlTJsiLqo9T8tjruuy7_k';
        
        let supabase = null;
        let useLocalStorage = false;

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error('Supabase failed, using localStorage');
            useLocalStorage = true;
        }

        const app = {
            currentView: 'welcome',
            selectedPeriod: 'dec-2025',
            showModal: false,
            selectedSlot: null,
            volunteerName: '',
            signups: {},

            // ‚≠ê TO ADD NEW QUARTERS: Just copy a line below and change the year/months
            // Format: { id: 'unique-id', label: 'Display Name', months: [1,2,3], year: 2026 }
            periods: [
                { id: 'dec-2025', label: 'December 2025', months: [12], year: 2025 },
                { id: 'jan-mar-2026', label: 'January - March 2026', months: [1,2,3], year: 2026 },
                { id: 'apr-jun-2026', label: 'April - June 2026', months: [4,5,6], year: 2026 },
                { id: 'jul-sep-2026', label: 'July - September 2026', months: [7,8,9], year: 2026 },
                { id: 'oct-dec-2026', label: 'October - December 2026', months: [10,11,12], year: 2026 },
                // üìù ADD 2027 QUARTERS HERE WHEN NEEDED (copy format above):
                // { id: 'jan-mar-2027', label: 'January - March 2027', months: [1,2,3], year: 2027 },
                // { id: 'apr-jun-2027', label: 'April - June 2027', months: [4,5,6], year: 2027 },
                // { id: 'jul-sep-2027', label: 'July - September 2027', months: [7,8,9], year: 2027 },
                // { id: 'oct-dec-2027', label: 'October - December 2027', months: [10,11,12], year: 2027 },
            ],

            roles: {
                'thursday-hall': [
                    { id: 'managers', name: 'Managers', time: '9:45am-1:30pm', capacity: 2 },
                    { id: 'hall-help', name: 'Hall Help', time: '10:00am-1:30pm', capacity: 5 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '11:15am-1:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '11:30am-1:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                ],
                'saturday-hall': [
                    { id: 'managers', name: 'Managers', time: '2:45pm-6:30pm', capacity: 2 },
                    { id: 'hall-help-1', name: 'Hall Help - Shift 1', time: '3:15pm-6:30pm', capacity: 3 },
                    { id: 'hall-help-2', name: 'Hall Help - Shift 2', time: '4:45pm-6:30pm', capacity: 2 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '4:00pm-6:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '4:30pm-6:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                ],
                'weekly-tasks': [
                    { id: 'wed-pickup', name: 'Wed Bakers Delight', time: '~3:45pm', capacity: 1 },
                    { id: 'thurs-pickup', name: 'Thurs Bakers Delight', time: '4:50pm', capacity: 1 },
                    { id: 'cheesecake', name: 'Cheesecake Shop', time: '3-6pm', capacity: 1 },
                ]
            },
            
            connectionStatus: 'checking',
            lastSaveTime: null,

            async init() {
                await this.checkConnection();
                await this.loadSignups();
                this.render();
                
                if (!useLocalStorage && supabase) {
                    supabase.channel('signups').on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'volunteer_signups' }, 
                        () => this.loadSignups()
                    ).subscribe();
                }
                
                // Auto-backup to localStorage every 30 seconds
                setInterval(() => this.autoBackup(), 30000);
            },
            
            async checkConnection() {
                if (useLocalStorage) {
                    this.connectionStatus = 'offline';
                    return;
                }
                try {
                    const { error } = await supabase.from('volunteer_signups').select('id').limit(1);
                    this.connectionStatus = error ? 'error' : 'connected';
                } catch (e) {
                    this.connectionStatus = 'error';
                }
            },
            
            autoBackup() {
                try {
                    localStorage.setItem('uts-roster-backup', JSON.stringify({
                        data: this.signups,
                        timestamp: new Date().toISOString()
                    }));
                } catch (e) {
                    console.error('Auto-backup failed:', e);
                }
            },
            
            showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-600' : 'bg-red-600'
                } text-white font-semibold`;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            },

            getDatesForPeriod() {
                const period = this.periods.find(p => p.id === this.selectedPeriod);
                if (!period) return [];
                
                const dates = [];
                const targetDay = this.currentView === 'thursday-hall' ? 4 : 
                                 this.currentView === 'saturday-hall' ? 6 : 3;
                
                period.months.forEach(month => {
                    const date = new Date(period.year, month - 1, 1);
                    
                    while (date.getMonth() === month - 1) {
                        if (date.getDay() === targetDay) {
                            dates.push({
                                date: date.toISOString().split('T')[0],
                                label: date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })
                            });
                        }
                        date.setDate(date.getDate() + 1);
                    }
                });
                
                return dates;
            },

            async loadSignups() {
                if (useLocalStorage) {
                    const saved = localStorage.getItem('uts-roster');
                    if (saved) this.signups = JSON.parse(saved);
                } else {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { data, error } = await supabase.from('volunteer_signups').select('*');
                            if (error) throw error;
                            
                            this.signups = {};
                            data.forEach(s => {
                                if (!this.signups[s.roster_type]) this.signups[s.roster_type] = {};
                                if (!this.signups[s.roster_type][s.shift_date]) this.signups[s.roster_type][s.shift_date] = {};
                                if (!this.signups[s.roster_type][s.shift_date][s.role_id]) this.signups[s.roster_type][s.shift_date][s.role_id] = [];
                                this.signups[s.roster_type][s.shift_date][s.role_id].push({
                                    id: s.id,
                                    name: s.volunteer_name
                                });
                            });
                            this.connectionStatus = 'connected';
                            this.lastSaveTime = new Date();
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                console.error('Load failed after retries:', e);
                                this.connectionStatus = 'error';
                                // Fallback to backup
                                const backup = localStorage.getItem('uts-roster-backup');
                                if (backup) {
                                    const parsed = JSON.parse(backup);
                                    this.signups = parsed.data;
                                    this.showNotification('Using offline backup', 'warning');
                                }
                            } else {
                                await new Promise(r => setTimeout(r, 1000));
                            }
                        }
                    }
                }
                this.render();
            },

            async addSignup() {
                if (!this.volunteerName.trim()) return alert('Please enter your name');
                const { view, dateStr, roleId } = this.selectedSlot;
                
                if (useLocalStorage) {
                    if (!this.signups[view]) this.signups[view] = {};
                    if (!this.signups[view][dateStr]) this.signups[view][dateStr] = {};
                    if (!this.signups[view][dateStr][roleId]) this.signups[view][dateStr][roleId] = [];
                    this.signups[view][dateStr][roleId].push({ name: this.volunteerName.trim() });
                    localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                    this.showNotification('Signed up successfully!');
                } else {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { error } = await supabase.from('volunteer_signups').insert({
                                roster_type: view,
                                shift_date: dateStr,
                                role_id: roleId,
                                volunteer_name: this.volunteerName.trim()
                            });
                            if (error) throw error;
                            await this.loadSignups();
                            this.showNotification('Signed up successfully!');
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                this.showNotification('Error signing up. Please try again.', 'error');
                                return;
                            }
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                }
                
                this.showModal = false;
                this.volunteerName = '';
                this.render();
            },

            async removeSignup(view, dateStr, roleId, signup) {
                if (!confirm(`Remove ${signup.name}?`)) return;
                
                if (useLocalStorage) {
                    this.signups[view][dateStr][roleId] = this.signups[view][dateStr][roleId].filter(s => s !== signup);
                    localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                    this.showNotification('Removed successfully');
                } else {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { error } = await supabase.from('volunteer_signups').delete().eq('id', signup.id);
                            if (error) throw error;
                            await this.loadSignups();
                            this.showNotification('Removed successfully');
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                this.showNotification('Error removing. Please try again.', 'error');
                                return;
                            }
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                }
                this.render();
            },

            getSignups(view, dateStr, roleId) {
                return this.signups[view]?.[dateStr]?.[roleId] || [];
            },

            exportData() {
                const data = JSON.stringify(this.signups, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `roster-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            },

            importData(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (confirm('Replace all data with backup?')) {
                            this.signups = imported;
                            if (useLocalStorage) {
                                localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                            } else {
                                await supabase.from('volunteer_signups').delete().neq('id', 0);
                                for (let view in imported) {
                                    for (let date in imported[view]) {
                                        for (let role in imported[view][date]) {
                                            for (let signup of imported[view][date][role]) {
                                                await supabase.from('volunteer_signups').insert({
                                                    roster_type: view,
                                                    shift_date: date,
                                                    role_id: role,
                                                    volunteer_name: signup.name
                                                });
                                            }
                                        }
                                    }
                                }
                            }
                            await this.loadSignups();
                            alert('Backup restored!');
                        }
                    } catch (error) {
                        alert('Invalid backup file');
                    }
                };
                reader.readAsText(file);
            },

            render() {
                const appEl = document.getElementById('app');
                if (this.currentView === 'welcome') {
                    appEl.innerHTML = this.renderWelcome();
                } else {
                    appEl.innerHTML = this.renderRoster();
                }
            },

            renderWelcome() {
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-8">
                                <div class="flex items-center gap-3 mb-6">
                                    <svg class="w-12 h-12 text-pink-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    <div>
                                        <h1 class="text-4xl font-bold">Under the Stars</h1>
                                        <p class="text-xl text-gray-600">Meal Rosters</p>
                                    </div>
                                </div>

                                <div class="mb-8 text-gray-700 space-y-4">
                                    <p class="text-lg">Welcome! üòä</p>
                                    <p>Thanks for volunteering! We ask volunteers give their time once a month. Don't burn yourself out - we want you around for the long haul! üôÇ</p>
                                    
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h3 class="font-bold text-blue-900 mb-2">To sign up:</h3>
                                        <ol class="list-decimal list-inside space-y-1 text-blue-800">
                                            <li>Choose your preferred day and task</li>
                                            <li>Find an available date and enter your name</li>
                                        </ol>
                                    </div>

                                    <p><strong>Meal Managers:</strong> Ani Stace, Carol Machai, Keiran Stuart, Aroha Kelly, Rose Kent-Wilson, Adrian De Souza</p>
                                    <p><strong>Venue:</strong> Cliff Rd community hall, 45 Cliff Rd</p>
                                    <p class="text-sm">*Long hair tied back. Closed toe shoes required.</p>
                                </div>

                                <div class="space-y-3">
                                    <button onclick="app.currentView='thursday-hall'; app.render();" class="w-full bg-blue-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-blue-700">Thursday Hall Help ‚Üí</button>
                                    <button onclick="app.currentView='saturday-hall'; app.render();" class="w-full bg-orange-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-orange-700">Saturday Hall Help ‚Üí</button>
                                    <button onclick="app.currentView='weekly-tasks'; app.render();" class="w-full bg-pink-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-pink-700">Weekly Tasks ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderRoster() {
                const dates = this.getDatesForPeriod();
                const roles = this.roles[this.currentView] || [];
                const title = this.currentView === 'thursday-hall' ? 'Thursday Hall Help' : 
                             this.currentView === 'saturday-hall' ? 'Saturday Hall Help' : 
                             'Weekly Tasks';
                
                const statusColor = this.connectionStatus === 'connected' ? 'green' : 
                                   this.connectionStatus === 'error' ? 'red' : 'yellow';
                const statusText = this.connectionStatus === 'connected' ? '‚óè Online' : 
                                  this.connectionStatus === 'error' ? '‚óè Offline' : '‚óè Connecting...';

                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-7xl mx-auto">
                            <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
                                <button onclick="app.currentView='welcome'; app.render();" class="text-gray-600 hover:text-gray-800 mb-4">‚Üê Back</button>
                                
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h1 class="text-3xl font-bold mb-2">${title}</h1>
                                        <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                            <p class="text-sm text-blue-900">
                                                <strong>Questions?</strong> Contact: <a href="mailto:operations2@underthestars.org.nz" class="underline">operations2@underthestars.org.nz</a>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-${statusColor}-600 text-sm font-semibold mb-2">${statusText}</div>
                                        <select onchange="app.selectedPeriod=this.value; app.render();" class="px-4 py-2 border rounded-lg">
                                            ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-lg overflow-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-800 text-white">
                                            <th class="p-3 text-left sticky left-0 bg-gray-800 z-10">Date</th>
                                            ${roles.map(role => `
                                                <th class="p-3 text-center min-w-[150px]">
                                                    <div class="font-bold">${role.name}</div>
                                                    <div class="text-xs font-normal">${role.time}</div>
                                                    <div class="text-xs font-normal">(${role.capacity} needed)</div>
                                                </th>
                                            `).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dates.map((d, idx) => `
                                            <tr class="${idx % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                                                <td class="p-3 font-semibold sticky left-0 bg-inherit border-r">${d.label}</td>
                                                ${roles.map(role => {
                                                    const signups = this.getSignups(this.currentView, d.date, role.id);
                                                    const isFull = signups.length >= role.capacity;
                                                    return `
                                                        <td class="p-2 border">
                                                            ${signups.map(s => `
                                                                <div class="bg-green-100 rounded px-2 py-1 text-sm mb-1 flex justify-between">
                                                                    <span>${s.name}</span>
                                                                    <button onclick='app.removeSignup("${this.currentView}", "${d.date}", "${role.id}", ${JSON.stringify(s)})' class="text-red-600 hover:text-red-800">‚úï</button>
                                                                </div>
                                                            `).join('')}
                                                            ${!isFull ? `
                                                                <button onclick='app.selectedSlot={view:"${this.currentView}",dateStr:"${d.date}",roleId:"${role.id}",dateLabel:"${d.label}",roleName:"${role.name}"}; app.showModal=true; app.render();' class="w-full bg-indigo-50 border-2 border-dashed border-indigo-300 rounded px-2 py-1 text-sm text-indigo-600 hover:bg-indigo-100">+ Sign Up</button>
                                                            ` : '<div class="text-gray-500 text-center text-sm">Full</div>'}
                                                        </td>
                                                    `;
                                                }).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        ${this.showModal ? `
                            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                    <h3 class="text-xl font-bold mb-4">Sign Up for Shift</h3>
                                    <div class="mb-4 p-3 bg-gray-50 rounded text-sm">
                                        <div><strong>Date:</strong> ${this.selectedSlot.dateLabel}</div>
                                        <div><strong>Role:</strong> ${this.selectedSlot.roleName}</div>
                                    </div>
                                    <input type="text" id="volName" placeholder="Enter your name" class="w-full px-4 py-2 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" value="${this.volunteerName}">
                                    <div class="flex gap-3">
                                        <button onclick="app.showModal=false; app.volunteerName=''; app.render();" class="flex-1 bg-gray-200 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                                        <button onclick="app.volunteerName=document.getElementById('volName').value; app.addSignup();" class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700">Sign Up</button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
