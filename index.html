<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under the Stars Volunteer Roster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .print-full-width { max-width: 100% !important; }
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 768px) {
            .role-cell {
                min-width: 160px;
            }
        }
        
        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .date-past { opacity: 0.4; background-color: #f3f4f6 !important; }
        .date-today { background-color: #fef3c7 !important; border-left: 4px solid #f59e0b; }
        .date-future { }
        .date-next-shift { 
            background: linear-gradient(135deg, #bfdbfe 0%, #dbeafe 100%) !important;
            border: 4px solid #2563eb !important;
            position: relative;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
        .next-shift-badge {
            position: absolute;
            top: -12px;
            right: 8px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        .coverage-excellent { background-color: #dcfce7; }
        .coverage-good { background-color: #fef9c3; }
        .coverage-poor { background-color: #fee2e2; }
        
        .notification-enter {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .edit-mode input {
            width: 100%;
            padding: 2px 4px;
            border: 2px solid #3b82f6;
            border-radius: 4px;
        }
        
        .edit-icon {
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            color: #6b7280;
        }
        
        .volunteer-item:hover .edit-icon {
            opacity: 1;
        }
        
        .edit-icon:hover {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://evhjncobivtsxeeqvlue.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aGpuY29iaXZ0c3hlZXF2bHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDAyMTUsImV4cCI6MjA3NzM3NjIxNX0.NZKMBV8WKbef8ADsWAYlgtWlTJsiLqo9T8tjruuy7_k';
        const ADMIN_PASSWORD = 'UTS2025Admin';

        const HISTORICAL_DATA = {"thursday-hall":{"2025-10-02":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Alixandra Villis (new CIP)"},{name:"Anil (New, CIP)"}],"drinks":[{name:"Ali or Lesley"}],"laundry":[{name:"Catherine"}]},"2025-10-09":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Janet"},{name:"Sara"},{name:"Tina"}],"drinks":[{name:"Lesley"}],"dishes":[{name:"Catherine (coming early)"}],"laundry":[{name:"Catherine"}]},"2025-10-16":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help":[{name:"Lesley"},{name:"Catherine"},{name:"Viv Clark (new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-10-23":{"managers":[{name:"Carl"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Paul"},{name:"Sarah Cornish (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley (hall help)"}],"laundry":[{name:"Adrian"}]},"2025-10-30":{"managers":[{name:"Ani"},{name:"Carl"}],"hall-help":[{name:"Kerry (2 hours)"},{name:"Sara"},{name:"Lesley"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Liz"}]},"2025-11-06":{"managers":[{name:"Ani"},{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Maria and Maca (until 115)"},{name:"Tina"},{name:"Deb"},{name:"Richard (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}],"laundry":[{name:"Adrian"}]},"2025-11-13":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Sarah Cornish"},{name:"Harina (FCU, new)"},{name:"Lesley"},{name:"Larissa (FCU)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-11-20":{"managers":[{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Tina"},{name:"Matthew Poland (one lineage, new)"},{name:"Nikita (one lineage)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Lesley"}]},"2025-11-27":{"managers":[{name:"Adrian 9:30-1:15"}],"hall-help":[{name:"Ali"},{name:"Sara"},{name:"Rachel K"},{name:"Deb"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-04":{"managers":[{name:"Ani"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"MJ (one lineage)"},{name:"Nick (one lineage, new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Catherine"}],"laundry":[{name:"Catherine"}]},"2025-12-11":{"managers":[{name:"Adrian"},{name:"Rose"}],"hall-help":[{name:"Ali"},{name:"Lesley"},{name:"Elaine (one lineage, new)"},{name:"Matthew (one lineage, new)"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Adrian"}]},"2025-12-18":{"managers":[{name:"Ani"},{name:"Adrian"}],"hall-help":[{name:"Ali"},{name:"Josh (one lineage, new)"},{name:"Lesley"}],"drinks":[{name:"Sue"}]},"2025-12-25":{"hall-help":[{name:"Carol"},{name:"Lesley"},{name:"Steve (Lesley husband)"},{name:"Harley"},{name:"Elle"}]}},"saturday-hall":{"2025-10-04":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey (new)"},{name:"Sarah (new)"},{name:"Morgan"}],"hall-help-2":[{name:"Aimi"},{name:"Steve"}],"drinks":[{name:"Christine"}],"dishes":[{name:"Uatesoni"}],"laundry":[{name:"Morgan"}]},"2025-10-11":{"managers":[{name:"Carl"},{name:"Keiran"}],"hall-help-1":[{name:"Harriet Campbell (new)"},{name:"Jolene"},{name:"Cathleen"}],"hall-help-2":[{name:"Uatesoni"},{name:"Elle"}],"drinks":[{name:"Catherine"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-10-18":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Paul"},{name:"Cecilia (new)"},{name:"Michelle"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Sara"}],"laundry":[{name:"Sue"}]},"2025-10-25":{"managers":[{name:"Rose"}],"hall-help-1":[{name:"Paul"},{name:"Joanne (new)"},{name:"Harley"}],"hall-help-2":[{name:"Jaylah (16,new)"},{name:"Jaylah's mum (new)"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Maria Moran"}],"laundry":[{name:"Liz"}]},"2025-11-01":{"managers":[{name:"Carol"}],"hall-help-1":[{name:"Abbey"},{name:"Kaaren"},{name:"Harley"}],"hall-help-2":[{name:"Cecilia"},{name:"Maryanne"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jimmy"}],"laundry":[{name:"Sue"}]},"2025-11-08":{"managers":[{name:"Keiran 4 - 6"},{name:"Carl"}],"hall-help-1":[{name:"Harriet Campbell"},{name:"Elle"}],"hall-help-2":[{name:"Cathleen Meichtry"},{name:"Karen P"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Rachelt"}],"laundry":[{name:"Sue"}]},"2025-11-15":{"managers":[{name:"Keiran"}],"hall-help-1":[{name:"Sara"},{name:"Morgan"},{name:"Elle"}],"hall-help-2":[{name:"Maryanne"},{name:"Lisa"}],"drinks":[{name:"Sue"}],"dishes":[{name:"Jolene"}],"laundry":[{name:"Sue"}]},"2025-11-22":{"managers":[{name:"Carl"},{name:"Ani 4 - 6"}],"hall-help-1":[{name:"Jaylah"},{name:"Jaylahs mum"},{name:"Cecilia"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-11-29":{"managers":[{name:"Rose"},{name:"Carl"}],"hall-help-1":[{name:"Rachelt"},{name:"Steve"},{name:"Arshy (new)"}],"drinks":[{name:"Sue"}]},"2025-12-06":{"hall-help-1":[{name:"Abbey"},{name:"Cathleen Meichtry"}],"hall-help-2":[{name:"Harley"}],"drinks":[{name:"Sue"}],"laundry":[{name:"Lynn Lee"}]},"2025-12-13":{"managers":[{name:"Keiran"}],"hall-help-2":[{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-20":{"hall-help-1":[{name:"Paul"},{name:"Harriet"},{name:"Elle"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]},"2025-12-27":{"managers":[{name:"Rose"}],"hall-help-2":[{name:"Harley"},{name:"Maryanne"}],"drinks":[{name:"Sue"}]}},"weekly-tasks":{"2025-10-01":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-08":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-15":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}],"cheesecake":[{name:"Rose"}]},"2025-10-22":{"wed-pickup":[{name:"Greg"}],"thurs-pickup":[{name:"Carl"}]},"2025-10-29":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-05":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Carl"}]},"2025-11-12":{"wed-pickup":[{name:"Carl"}],"thurs-pickup":[{name:"Catherine"}]}}};

        let supabase = null;
        let useLocalStorage = false;

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error('Supabase failed, using localStorage');
            useLocalStorage = true;
        }

        const app = {
            currentView: 'welcome',
            selectedPeriod: 'oct-dec-2025',
            showModal: false,
            selectedSlot: null,
            volunteerName: '',
            signups: {},
            connectionStatus: 'checking',
            lastSaveTime: null,
            backupCount: 5,
            isInitialized: false,
            isAdmin: false,
            adminView: 'dashboard',
            dateNotes: {},
            giveawayDates: {},
            showMySignups: false,
            searchName: '',
            isLoading: false,
            editingSignup: null,

            periods: [
                { id: 'oct-dec-2025', label: 'October - December 2025', months: [10,11,12], year: 2025 },
                { id: 'jan-mar-2026', label: 'January - March 2026', months: [1,2,3], year: 2026 },
                { id: 'apr-jun-2026', label: 'April - June 2026', months: [4,5,6], year: 2026 },
                { id: 'jul-sep-2026', label: 'July - September 2026', months: [7,8,9], year: 2026 },
                { id: 'oct-dec-2026', label: 'October - December 2026', months: [10,11,12], year: 2026 },
            ],

            roles: {
                'thursday-hall': [
                    { id: 'managers', name: 'Managers', time: '9:45am-1:30pm', capacity: 2 },
                    { id: 'hall-help', name: 'Hall Help', time: '10:00am-1:30pm', capacity: 4 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '11:15am-1:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '11:30am-1:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                    { id: 'giveaway', name: 'Giveaway Table', time: '10:45am-12:45pm', capacity: 2 },
                ],
                'saturday-hall': [
                    { id: 'managers', name: 'Managers', time: '2:45pm-6:30pm', capacity: 2 },
                    { id: 'hall-help-1', name: 'Hall Help - Shift 1', time: '3:15pm-6:30pm', capacity: 3 },
                    { id: 'hall-help-2', name: 'Hall Help - Shift 2', time: '4:30pm-6:30pm (can come earlier)', capacity: 2 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '4:00pm-6:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '4:30pm-6:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                    { id: 'giveaway', name: 'Giveaway Table', time: '3:45pm-5:45pm', capacity: 2 },
                ],
                'weekly-tasks': [
                    { id: 'wed-pickup', name: 'Wed Bakers Delight', time: '~3:45pm', capacity: 1 },
                    { id: 'thurs-pickup', name: 'Thurs Bakers Delight', time: '4:50pm', capacity: 1 },
                    { id: 'cheesecake', name: 'Cheesecake Shop', time: '3-6pm Fri', capacity: 1 },
                ]
            },

            getVisibleRoles(view) {
                const allRoles = this.roles[view] || [];
                return allRoles.filter(role => {
                    if (role.id !== 'giveaway') return true;
                    return this.hasAnyGiveaway(view);
                });
            },

            hasAnyGiveaway(view) {
                const dates = this.getDatesForPeriod();
                return dates.some(d => this.isGiveawayEnabled(view, d.date));
            },

            isGiveawayEnabled(view, dateStr) {
                const key = `${view}-${dateStr}`;
                return this.giveawayDates[key] === true;
            },

            toggleGiveaway(view, dateStr) {
                const key = `${view}-${dateStr}`;
                this.giveawayDates[key] = !this.giveawayDates[key];
                localStorage.setItem('uts-giveaway-dates', JSON.stringify(this.giveawayDates));
                this.showNotification(this.giveawayDates[key] ? 'Giveaway table enabled' : 'Giveaway table disabled');
                this.render();
            },

            getNextUpcomingDate() {
                const today = new Date();
                today.setHours(0,0,0,0);
                const dates = this.getDatesForPeriod();
                
                for (let d of dates) {
                    const date = new Date(d.date);
                    date.setHours(0,0,0,0);
                    if (date >= today) {
                        return d.date;
                    }
                }
                return null;
            },

            getDateClass(dateStr) {
                const today = new Date();
                today.setHours(0,0,0,0);
                const date = new Date(dateStr);
                date.setHours(0,0,0,0);
                const nextShift = this.getNextUpcomingDate();
                
                if (dateStr === nextShift) return 'date-next-shift';
                if (date < today) return 'date-past';
                if (date.getTime() === today.getTime()) return 'date-today';
                return 'date-future';
            },

            getCoverageClass(filled, total) {
                const percentage = (filled / total) * 100;
                if (percentage >= 90) return 'coverage-excellent';
                if (percentage >= 60) return 'coverage-good';
                return 'coverage-poor';
            },

            getMySignups() {
                if (!this.searchName.trim()) {
                    alert('Please enter your name to find your signups');
                    return;
                }
                
                const name = this.searchName.trim().toLowerCase();
                const mySignups = [];
                
                for (let rosterType in this.signups) {
                    for (let dateStr in this.signups[rosterType]) {
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            volunteers.forEach(v => {
                                if (v.name.toLowerCase().includes(name)) {
                                    const role = this.roles[rosterType]?.find(r => r.id === roleId);
                                    const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                                      rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';
                                    mySignups.push({
                                        date: dateStr,
                                        dateLabel: new Date(dateStr).toLocaleDateString('en-NZ', { 
                                            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
                                        }),
                                        roster: rosterName,
                                        role: role?.name || roleId,
                                        time: role?.time || ''
                                    });
                                }
                            });
                        }
                    }
                }
                
                mySignups.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                if (mySignups.length === 0) {
                    this.showNotification(`No signups found for "${this.searchName}"`, 'warning');
                } else {
                    this.showMySignups = true;
                    this.mySignupsList = mySignups;
                    this.render();
                }
            },

            startEdit(view, dateStr, roleId, signup) {
                this.editingSignup = { view, dateStr, roleId, signup, originalName: signup.name };
                this.render();
            },

            cancelEdit() {
                this.editingSignup = null;
                this.render();
            },

            async saveEdit(newName) {
                if (!newName.trim()) {
                    alert('Name cannot be empty');
                    return;
                }

                const { view, dateStr, roleId, signup } = this.editingSignup;
                
                if (useLocalStorage) {
                    const signupIndex = this.signups[view][dateStr][roleId].indexOf(signup);
                    if (signupIndex !== -1) {
                        this.signups[view][dateStr][roleId][signupIndex].name = newName.trim();
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        this.createBackup();
                        this.showNotification('Name updated successfully!');
                    }
                } else {
                    try {
                        const { error } = await supabase
                            .from('volunteer_signups')
                            .update({ volunteer_name: newName.trim() })
                            .eq('id', signup.id);
                        
                        if (error) throw error;
                        await this.loadSignups();
                        this.showNotification('Name updated successfully!');
                    } catch (e) {
                        this.showNotification('Error updating name', 'error');
                        console.error(e);
                    }
                }
                
                this.editingSignup = null;
                this.render();
            },

            validateData(data) {
                if (!data || typeof data !== 'object') return false;
                for (let rosterType in data) {
                    if (!['thursday-hall', 'saturday-hall', 'weekly-tasks'].includes(rosterType)) continue;
                    const dates = data[rosterType];
                    if (typeof dates !== 'object') return false;
                    for (let date in dates) {
                        const roles = dates[date];
                        if (typeof roles !== 'object') return false;
                        for (let roleId in roles) {
                            const signups = roles[roleId];
                            if (!Array.isArray(signups)) return false;
                            for (let signup of signups) {
                                if (!signup.name || typeof signup.name !== 'string') return false;
                            }
                        }
                    }
                }
                return true;
            },

            createBackup() {
                try {
                    const timestamp = new Date().toISOString();
                    const backup = { data: this.signups, timestamp: timestamp, version: '1.0' };
                    const backups = this.getBackups();
                    backups.push(backup);
                    if (backups.length > this.backupCount) backups.shift();
                    localStorage.setItem('uts-roster-backups', JSON.stringify(backups));
                    console.log('Backup created:', timestamp);
                } catch (e) {
                    console.error('Backup creation failed:', e);
                }
            },

            getBackups() {
                try {
                    const stored = localStorage.getItem('uts-roster-backups');
                    if (!stored) return [];
                    const backups = JSON.parse(stored);
                    return Array.isArray(backups) ? backups : [];
                } catch (e) {
                    return [];
                }
            },

            restoreFromBackup() {
                const backups = this.getBackups();
                for (let i = backups.length - 1; i >= 0; i--) {
                    const backup = backups[i];
                    if (backup.data && this.validateData(backup.data)) {
                        this.signups = backup.data;
                        console.log('Restored from backup:', backup.timestamp);
                        return true;
                    }
                }
                console.log('No valid backups found. Starting fresh.');
                this.signups = {};
                return false;
            },

            showNotification(message, type = 'success') {
                if (this.currentView === 'welcome' && !this.isInitialized) {
                    console.log('Notification suppressed on welcome:', message);
                    return;
                }
                const notif = document.createElement('div');
                notif.className = `notification-enter fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-red-600'
                } text-white font-semibold`;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            },

            async init() {
                this.isLoading = true;
                this.render();
                
                await this.checkConnection();
                await this.loadHistoricalData();
                await this.loadSignups();
                
                this.isLoading = false;
                this.isInitialized = true;
                this.render();

                if (!useLocalStorage && supabase) {
                    supabase.channel('signups').on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'volunteer_signups' }, 
                        () => this.loadSignups()
                    ).subscribe();
                }

                setInterval(() => this.autoBackup(), 300000);
                this.createBackup();
            },

            async checkConnection() {
                if (useLocalStorage) {
                    this.connectionStatus = 'offline';
                    return;
                }
                try {
                    const { error } = await supabase.from('volunteer_signups').select('id').limit(1);
                    this.connectionStatus = error ? 'error' : 'connected';
                } catch (e) {
                    this.connectionStatus = 'error';
                    console.error('Connection check failed:', e);
                }
            },

            async loadHistoricalData() {
                const hasHistoricalData = localStorage.getItem('uts-historical-loaded-to-supabase');
                if (hasHistoricalData) {
                    console.log('Historical data already loaded to database');
                    return;
                }

                console.log('Loading historical data to database...');

                if (useLocalStorage) {
                    this.signups = JSON.parse(JSON.stringify(HISTORICAL_DATA));
                    localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                    localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                    console.log('✓ Historical data loaded to localStorage');
                } else {
                    try {
                        const insertions = [];
                        
                        for (let rosterType in HISTORICAL_DATA) {
                            for (let dateStr in HISTORICAL_DATA[rosterType]) {
                                for (let roleId in HISTORICAL_DATA[rosterType][dateStr]) {
                                    const volunteers = HISTORICAL_DATA[rosterType][dateStr][roleId];
                                    volunteers.forEach(v => {
                                        insertions.push({
                                            roster_type: rosterType,
                                            shift_date: dateStr,
                                            role_id: roleId,
                                            volunteer_name: v.name
                                        });
                                    });
                                }
                            }
                        }

                        console.log(`Inserting ${insertions.length} historical signups...`);
                        
                        const batchSize = 50;
                        for (let i = 0; i < insertions.length; i += batchSize) {
                            const batch = insertions.slice(i, i + batchSize);
                            const { error } = await supabase.from('volunteer_signups').insert(batch);
                            if (error) throw error;
                            console.log(`Inserted batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(insertions.length/batchSize)}`);
                        }

                        localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                        console.log('✓ Historical data loaded to Supabase successfully!');
                        
                    } catch (e) {
                        console.error('Error loading historical data to Supabase:', e);
                        this.signups = JSON.parse(JSON.stringify(HISTORICAL_DATA));
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        localStorage.setItem('uts-historical-loaded-to-supabase', 'true');
                        console.log('✓ Historical data loaded to localStorage (fallback)');
                    }
                }

                this.createBackup();
            },

            autoBackup() {
                try {
                    if (!this.validateData(this.signups)) {
                        console.error('Data validation failed - backup skipped');
                        return;
                    }
                    this.createBackup();
                } catch (e) {
                    console.error('Auto-backup failed:', e);
                }
            },

            getDatesForPeriod() {
                const period = this.periods.find(p => p.id === this.selectedPeriod);
                if (!period) return [];
                const dates = [];
                
                if (this.currentView === 'weekly-tasks') {
                    period.months.forEach(month => {
                        const date = new Date(period.year, month - 1, 1);
                        while (date.getMonth() === month - 1) {
                            if (date.getDay() === 3) {
                                const wed = new Date(date);
                                const thurs = new Date(date);
                                thurs.setDate(thurs.getDate() + 1);
                                dates.push({
                                    date: wed.toISOString().split('T')[0],
                                    label: `${wed.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })} - ${thurs.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })}`
                                });
                            }
                            date.setDate(date.getDate() + 1);
                        }
                    });
                } else {
                    const targetDay = this.currentView === 'thursday-hall' ? 4 : 6;
                    period.months.forEach(month => {
                        const date = new Date(period.year, month - 1, 1);
                        while (date.getMonth() === month - 1) {
                            if (date.getDay() === targetDay) {
                                dates.push({
                                    date: date.toISOString().split('T')[0],
                                    label: date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short' })
                                });
                            }
                            date.setDate(date.getDate() + 1);
                        }
                    });
                }
                return dates;
            },

            async loadSignups() {
                if (useLocalStorage) {
                    const saved = localStorage.getItem('uts-roster');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            if (this.validateData(parsed)) {
                                this.signups = parsed;
                                this.createBackup();
                            } else {
                                console.error('Loaded data is corrupted. Attempting recovery...');
                                this.restoreFromBackup();
                            }
                        } catch (e) {
                            console.error('Error parsing data:', e);
                            this.restoreFromBackup();
                        }
                    }
                    const savedNotes = localStorage.getItem('uts-date-notes');
                    if (savedNotes) {
                        try {
                            this.dateNotes = JSON.parse(savedNotes);
                        } catch (e) {
                            this.dateNotes = {};
                        }
                    }
                    const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
                    if (savedGiveaway) {
                        try {
                            this.giveawayDates = JSON.parse(savedGiveaway);
                        } catch (e) {
                            this.giveawayDates = {};
                        }
                    }
                } else {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { data, error } = await supabase.from('volunteer_signups').select('*');
                            if (error) throw error;
                            this.signups = {};
                            data.forEach(s => {
                                if (!this.signups[s.roster_type]) this.signups[s.roster_type] = {};
                                if (!this.signups[s.roster_type][s.shift_date]) this.signups[s.roster_type][s.shift_date] = {};
                                if (!this.signups[s.roster_type][s.shift_date][s.role_id]) this.signups[s.roster_type][s.shift_date][s.role_id] = [];
                                this.signups[s.roster_type][s.shift_date][s.role_id].push({
                                    id: s.id,
                                    name: s.volunteer_name
                                });
                            });
                            if (!this.validateData(this.signups)) {
                                throw new Error('Loaded data failed validation');
                            }
                            this.connectionStatus = 'connected';
                            this.lastSaveTime = new Date();
                            this.createBackup();
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                console.error('Load failed after retries:', e);
                                this.connectionStatus = 'error';
                                this.restoreFromBackup();
                            } else {
                                await new Promise(r => setTimeout(r, 1000));
                            }
                        }
                    }
                    const savedNotes = localStorage.getItem('uts-date-notes');
                    if (savedNotes) {
                        try {
                            this.dateNotes = JSON.parse(savedNotes);
                        } catch (e) {
                            this.dateNotes = {};
                        }
                    }
                    const savedGiveaway = localStorage.getItem('uts-giveaway-dates');
                    if (savedGiveaway) {
                        try {
                            this.giveawayDates = JSON.parse(savedGiveaway);
                        } catch (e) {
                            this.giveawayDates = {};
                        }
                    }
                }
                if (this.isInitialized) {
                    this.render();
                }
            },

            saveNote(view, dateStr, note) {
                const key = `${view}-${dateStr}`;
                if (note.trim()) {
                    this.dateNotes[key] = note.trim();
                } else {
                    delete this.dateNotes[key];
                }
                localStorage.setItem('uts-date-notes', JSON.stringify(this.dateNotes));
                this.showNotification('Note saved');
            },

            getNote(view, dateStr) {
                const key = `${view}-${dateStr}`;
                return this.dateNotes[key] || '';
            },

            async addSignup() {
                if (!this.volunteerName.trim()) return alert('Please enter your name');
                const { view, dateStr, roleId } = this.selectedSlot;
                const originalSignups = JSON.parse(JSON.stringify(this.signups));

                if (useLocalStorage) {
                    try {
                        if (!this.signups[view]) this.signups[view] = {};
                        if (!this.signups[view][dateStr]) this.signups[view][dateStr] = {};
                        if (!this.signups[view][dateStr][roleId]) this.signups[view][dateStr][roleId] = [];
                        this.signups[view][dateStr][roleId].push({ name: this.volunteerName.trim() });
                        if (!this.validateData(this.signups)) {
                            throw new Error('Data validation failed');
                        }
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        this.createBackup();
                        this.showNotification('✓ Signed up successfully!');
                    } catch (e) {
                        this.signups = originalSignups;
                        this.showNotification('Error signing up: ' + e.message, 'error');
                        return;
                    }
                } else {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { data, error } = await supabase.from('volunteer_signups').insert({
                                roster_type: view,
                                shift_date: dateStr,
                                role_id: roleId,
                                volunteer_name: this.volunteerName.trim()
                            }).select();
                            if (error) throw error;
                            await this.loadSignups();
                            this.showNotification('✓ Signed up successfully!');
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                this.showNotification('Error signing up. Please try again.', 'error');
                                return;
                            }
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                }
                this.showModal = false;
                this.volunteerName = '';
                this.render();
            },

            async removeSignup(view, dateStr, roleId, signup) {
                if (!confirm(`Remove ${signup.name}?`)) return;
                const originalSignups = JSON.parse(JSON.stringify(this.signups));

                if (useLocalStorage) {
                    try {
                        this.signups[view][dateStr][roleId] = this.signups[view][dateStr][roleId].filter(s => s !== signup);
                        if (!this.validateData(this.signups)) {
                            throw new Error('Data validation failed');
                        }
                        localStorage.setItem('uts-roster', JSON.stringify(this.signups));
                        this.createBackup();
                        this.showNotification('✓ Removed successfully');
                    } catch (e) {
                        this.signups = originalSignups;
                        this.showNotification('Error removing: ' + e.message, 'error');
                        return;
                    }
                } else {
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { error } = await supabase.from('volunteer_signups').delete().eq('id', signup.id);
                            if (error) throw error;
                            await this.loadSignups();
                            this.showNotification('✓ Removed successfully');
                            break;
                        } catch (e) {
                            retries--;
                            if (retries === 0) {
                                this.showNotification('Error removing. Please try again.', 'error');
                                return;
                            }
                            await new Promise(r => setTimeout(r, 1000));
                        }
                    }
                }
                this.render();
            },

            getSignups(view, dateStr, roleId) {
                return this.signups[view]?.[dateStr]?.[roleId] || [];
            },

            getNextShiftStats() {
                // Don't show progress bar for weekly tasks
                if (this.currentView === 'weekly-tasks') return null;
                
                const nextDate = this.getNextUpcomingDate();
                if (!nextDate) return null;
                
                const roles = this.getVisibleRoles(this.currentView);
                let totalSlots = 0;
                let filledSlots = 0;
                
                roles.forEach(role => {
                    const signups = this.getSignups(this.currentView, nextDate, role.id);
                    totalSlots += role.capacity;
                    filledSlots += Math.min(signups.length, role.capacity);
                });
                
                // Parse the date string correctly (YYYY-MM-DD format)
                const [year, month, day] = nextDate.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const dateLabel = date.toLocaleDateString('en-NZ', { 
                    weekday: 'long', day: 'numeric', month: 'long'
                });
                
                return { 
                    totalSlots, 
                    filledSlots, 
                    coverage: Math.round((filledSlots / totalSlots) * 100),
                    dateLabel,
                    needsHelp: totalSlots - filledSlots
                };
            },

            getRosterStats() {
                const dates = this.getDatesForPeriod();
                const roles = this.getVisibleRoles(this.currentView);
                let totalSlots = 0;
                let filledSlots = 0;
                let needsHelp = 0;
                
                dates.forEach(d => {
                    roles.forEach(role => {
                        const signups = this.getSignups(this.currentView, d.date, role.id);
                        totalSlots += role.capacity;
                        filledSlots += Math.min(signups.length, role.capacity);
                        if (signups.length < role.capacity) needsHelp++;
                    });
                });
                
                return { totalSlots, filledSlots, needsHelp, coverage: Math.round((filledSlots / totalSlots) * 100) };
            },

            loginAdmin() {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    this.isAdmin = true;
                    this.currentView = 'admin';
                    this.render();
                } else if (password !== null) {
                    alert('Incorrect password');
                }
            },

            logoutAdmin() {
                this.isAdmin = false;
                this.currentView = 'welcome';
                this.render();
            },

            addNextQuarter() {
                const lastPeriod = this.periods[this.periods.length - 1];
                const lastYear = lastPeriod.year;
                const lastMonths = lastPeriod.months;
                const lastMonth = lastMonths[lastMonths.length - 1];
                
                let newYear = lastYear;
                let newMonths = [];
                let startMonth = lastMonth + 1;
                
                if (startMonth > 12) {
                    startMonth = 1;
                    newYear++;
                }
                
                for (let i = 0; i < 3; i++) {
                    let month = startMonth + i;
                    if (month > 12) {
                        month = month - 12;
                        newYear = lastYear + 1;
                    }
                    newMonths.push(month);
                }
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const label = `${monthNames[newMonths[0]-1]} - ${monthNames[newMonths[2]-1]} ${newYear}`;
                const id = `${monthNames[newMonths[0]-1].toLowerCase()}-${monthNames[newMonths[2]-1].toLowerCase()}-${newYear}`;
                
                this.periods.push({
                    id: id,
                    label: label,
                    months: newMonths,
                    year: newYear
                });
                
                this.showNotification(`Added quarter: ${label}`, 'success');
                this.render();
            },

            exportToCSV() {
                const rows = [['Date', 'Day', 'Roster Type', 'Role', 'Time', 'Volunteer', 'Capacity']];
                
                for (let rosterType in this.signups) {
                    const rosterName = rosterType === 'thursday-hall' ? 'Thursday Hall' :
                                      rosterType === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';
                    
                    for (let dateStr in this.signups[rosterType]) {
                        const date = new Date(dateStr);
                        const dayName = date.toLocaleDateString('en-NZ', { weekday: 'long' });
                        const dateLabel = date.toLocaleDateString('en-NZ', { day: 'numeric', month: 'short', year: 'numeric' });
                        
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const role = this.roles[rosterType]?.find(r => r.id === roleId);
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            
                            if (volunteers.length === 0) {
                                rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', '(empty)', role?.capacity || '']);
                            } else {
                                volunteers.forEach(v => {
                                    rows.push([dateLabel, dayName, rosterName, role?.name || roleId, role?.time || '', v.name, role?.capacity || '']);
                                });
                            }
                        }
                    }
                }
                
                const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-roster-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('CSV exported successfully!');
            },

            generateReport() {
                const stats = {
                    totalSignups: 0,
                    volunteerList: new Set(),
                    byRoster: {},
                    coverageByDate: {},
                    volunteerCounts: {},
                    volunteersByRole: {
                        managers: new Set(),
                        hallHelp: new Set(),
                        drinks: new Set(),
                        dishes: new Set(),
                        laundry: new Set()
                    },
                    volunteerCountsByRole: {
                        managers: {},
                        hallHelp: {},
                        drinks: {},
                        dishes: {},
                        laundry: {}
                    }
                };
                
                for (let rosterType in this.signups) {
                    stats.byRoster[rosterType] = { total: 0, volunteers: new Set() };
                    
                    for (let dateStr in this.signups[rosterType]) {
                        if (!stats.coverageByDate[dateStr]) {
                            stats.coverageByDate[dateStr] = { filled: 0, total: 0 };
                        }
                        
                        for (let roleId in this.signups[rosterType][dateStr]) {
                            const role = this.roles[rosterType]?.find(r => r.id === roleId);
                            const volunteers = this.signups[rosterType][dateStr][roleId];
                            
                            stats.totalSignups += volunteers.length;
                            stats.byRoster[rosterType].total += volunteers.length;
                            stats.coverageByDate[dateStr].filled += volunteers.length;
                            stats.coverageByDate[dateStr].total += role?.capacity || 1;
                            
                            volunteers.forEach(v => {
                                // Keep the full name - don't strip parentheses
                                const fullName = v.name.trim();
                                stats.volunteerList.add(fullName);
                                stats.byRoster[rosterType].volunteers.add(fullName);
                                
                                if (!stats.volunteerCounts[fullName]) {
                                    stats.volunteerCounts[fullName] = 0;
                                }
                                stats.volunteerCounts[fullName]++;
                                
                                // Categorize by role and count
                                if (roleId === 'managers') {
                                    stats.volunteersByRole.managers.add(fullName);
                                    if (!stats.volunteerCountsByRole.managers[fullName]) {
                                        stats.volunteerCountsByRole.managers[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.managers[fullName]++;
                                } else if (roleId.includes('hall-help')) {
                                    stats.volunteersByRole.hallHelp.add(fullName);
                                    if (!stats.volunteerCountsByRole.hallHelp[fullName]) {
                                        stats.volunteerCountsByRole.hallHelp[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.hallHelp[fullName]++;
                                } else if (roleId === 'drinks') {
                                    stats.volunteersByRole.drinks.add(fullName);
                                    if (!stats.volunteerCountsByRole.drinks[fullName]) {
                                        stats.volunteerCountsByRole.drinks[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.drinks[fullName]++;
                                } else if (roleId === 'dishes') {
                                    stats.volunteersByRole.dishes.add(fullName);
                                    if (!stats.volunteerCountsByRole.dishes[fullName]) {
                                        stats.volunteerCountsByRole.dishes[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.dishes[fullName]++;
                                } else if (roleId === 'laundry') {
                                    stats.volunteersByRole.laundry.add(fullName);
                                    if (!stats.volunteerCountsByRole.laundry[fullName]) {
                                        stats.volunteerCountsByRole.laundry[fullName] = 0;
                                    }
                                    stats.volunteerCountsByRole.laundry[fullName]++;
                                }
                            });
                        }
                    }
                }
                
                stats.topVolunteers = Object.entries(stats.volunteerCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                // Create top 10 for each role
                stats.topByRole = {
                    managers: Object.entries(stats.volunteerCountsByRole.managers)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    hallHelp: Object.entries(stats.volunteerCountsByRole.hallHelp)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    drinks: Object.entries(stats.volunteerCountsByRole.drinks)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    dishes: Object.entries(stats.volunteerCountsByRole.dishes)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10),
                    laundry: Object.entries(stats.volunteerCountsByRole.laundry)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10)
                };
                
                return stats;
            },

            downloadBackup() {
                const backup = {
                    data: this.signups,
                    periods: this.periods,
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
                
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `uts-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Backup downloaded!');
            },

            uploadBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            if (backup.data && this.validateData(backup.data)) {
                                this.signups = backup.data;
                                if (backup.periods && Array.isArray(backup.periods)) {
                                    this.periods = backup.periods;
                                }
                                this.createBackup();
                                this.showNotification('Backup restored successfully!');
                                this.render();
                            } else {
                                throw new Error('Invalid backup file');
                            }
                        } catch (e) {
                            this.showNotification('Error loading backup: ' + e.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            render() {
                const appEl = document.getElementById('app');
                
                if (this.isLoading) {
                    appEl.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center">
                            <div class="text-center">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-600">Loading roster...</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                if (this.showMySignups) {
                    appEl.innerHTML = this.renderMySignups();
                } else if (this.currentView === 'welcome') {
                    appEl.innerHTML = this.renderWelcome();
                } else if (this.currentView === 'admin') {
                    appEl.innerHTML = this.renderAdmin();
                } else {
                    appEl.innerHTML = this.renderRoster();
                }
            },

            renderMySignups() {
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-bold">My Signups: ${this.searchName}</h2>
                                    <button onclick="app.showMySignups=false; app.render();" class="text-gray-600 hover:text-gray-800">✕ Close</button>
                                </div>
                                
                                ${this.mySignupsList.length === 0 ? `
                                    <p class="text-gray-600">No signups found.</p>
                                ` : `
                                    <div class="space-y-3">
                                        ${this.mySignupsList.map(s => `
                                            <div class="p-4 border rounded-lg ${this.getDateClass(s.date)}">
                                                <div class="font-bold text-lg mb-1">${s.dateLabel}</div>
                                                <div class="text-sm text-gray-700">
                                                    <span class="font-semibold">${s.roster}</span> - ${s.role}
                                                    ${s.time ? `<span class="text-gray-500"> (${s.time})</span>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                                
                                <button onclick="app.showMySignups=false; app.render();" class="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                    Back to Roster
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderWelcome() {
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-8">
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-12 h-12 text-pink-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                        <div>
                                            <h1 class="text-4xl font-bold">Under the Stars</h1>
                                            <p class="text-xl text-gray-600">Meal Rosters</p>
                                        </div>
                                    </div>
                                    <button onclick="app.loginAdmin()" class="text-gray-400 hover:text-gray-600 text-sm">Admin</button>
                                </div>

                                <div class="mb-8 text-gray-700 space-y-4">
                                    <p class="text-lg">Welcome! 😊</p>
                                    <p>Thanks for volunteering! We ask volunteers give their time once a month. Don't burn yourself out - we want you around for the long haul! 🙂</p>
                                    
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                                        <h3 class="font-bold text-blue-900 mb-2">To sign up:</h3>
                                        <ol class="list-decimal list-inside space-y-1 text-blue-800">
                                            <li>Choose your preferred day and task</li>
                                            <li>Find an available date and enter your name</li>
                                            <li><strong>If anything changes, please notify the operations coordinator at <a href="mailto:operations@underthestars.org.nz" class="underline">operations@underthestars.org.nz</a> as soon as possible</strong></li>
                                        </ol>
                                    </div>
                                    
                                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                                        <h3 class="font-bold text-green-900 mb-2">Find Your Signups:</h3>
                                        <div class="flex gap-2">
                                            <input 
                                                type="text" 
                                                placeholder="Enter your name" 
                                                id="searchNameInput"
                                                class="flex-1 px-4 py-2 border rounded-lg"
                                                onkeypress="if(event.key==='Enter'){app.searchName=this.value; app.getMySignups();}"
                                            />
                                            <button onclick="app.searchName=document.getElementById('searchNameInput').value; app.getMySignups();" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700">
                                                Search
                                            </button>
                                        </div>
                                    </div>

                                    <p><strong>Meal Managers:</strong> Ani Stace, Carol Machaj, Keiran Stuart, Carl Fenton, Rose Kent-Wilson, Adrian De Souza</p>
                                    <p><strong>Venue:</strong> Cliff Rd community hall, 45 Cliff Rd</p>
                                    <p class="text-sm">*Long hair tied back. Closed toe shoes required.</p>
                                </div>

                                <div class="space-y-3">
                                    <button onclick="app.currentView='thursday-hall'; app.render();" class="w-full bg-blue-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-blue-700 transition-colors">Thursday Hall Help →</button>
                                    <button onclick="app.currentView='saturday-hall'; app.render();" class="w-full bg-orange-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-orange-700 transition-colors">Saturday Hall Help →</button>
                                    <button onclick="app.currentView='weekly-tasks'; app.render();" class="w-full bg-pink-600 text-white p-6 rounded-lg font-bold text-xl hover:bg-pink-700 transition-colors">Additional Weekly Tasks →</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderRoster() {
                const currentPeriod = this.periods.find(p => p.id === this.selectedPeriod);
                const dates = this.getDatesForPeriod();
                const roles = this.getVisibleRoles(this.currentView);
                const stats = this.getRosterStats();
                const nextShiftStats = this.getNextShiftStats();
                const nextShiftDate = this.getNextUpcomingDate();

                return `
                    <div class="min-h-screen p-2 md:p-4 print-full-width">
                        <div class="max-w-7xl mx-auto">
                            ${this.connectionStatus === 'connected' ? `
                                <div class="mb-4 p-3 bg-green-100 text-green-800 rounded-lg text-sm">
                                    ✓ Connected - Changes sync across all devices
                                </div>
                            ` : this.connectionStatus === 'error' ? `
                                <div class="mb-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg text-sm">
                                    ⚠️ Working offline - Using local storage
                                </div>
                            ` : ''}

                            <div class="bg-white rounded-lg shadow-xl p-4 md:p-6 mb-6 no-print">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                    <div>
                                        <h1 class="text-2xl md:text-3xl font-bold mb-1">
                                            ${this.currentView === 'thursday-hall' ? 'Thursday Hall Help' : 
                                              this.currentView === 'saturday-hall' ? 'Saturday Hall Help' : 'Additional Weekly Tasks'}
                                        </h1>
                                        <p class="text-gray-600">${currentPeriod.label}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="app.currentView='welcome'; app.render();" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">← Back</button>
                                        <button onclick="window.print()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Print</button>
                                    </div>
                                </div>

                                ${nextShiftStats ? `
                                    <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border-2 border-blue-300">
                                        <div class="flex justify-between items-center mb-2">
                                            <div>
                                                <h3 class="font-bold text-blue-900">Next Shift: ${nextShiftStats.dateLabel}</h3>
                                                <p class="text-sm text-blue-700">${nextShiftStats.filledSlots} of ${nextShiftStats.totalSlots} positions filled</p>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-3xl font-bold ${nextShiftStats.coverage >= 90 ? 'text-green-600' : nextShiftStats.coverage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                                    ${nextShiftStats.coverage}%
                                                </div>
                                                ${nextShiftStats.needsHelp > 0 ? `
                                                    <div class="text-xs text-red-600 font-semibold">
                                                        Need ${nextShiftStats.needsHelp} more!
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill ${nextShiftStats.coverage >= 90 ? 'bg-green-500' : nextShiftStats.coverage >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" 
                                                 style="width: ${nextShiftStats.coverage}%"></div>
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="flex flex-col md:flex-row gap-2 mb-4">
                                    <select onchange="app.selectedPeriod=this.value; app.render();" class="flex-1 p-2 border rounded-lg">
                                        ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                                    </select>
                                    ${this.currentView !== 'weekly-tasks' ? `
                                        <button onclick="app.currentView='${this.currentView === 'thursday-hall' ? 'saturday-hall' : 'thursday-hall'}'; app.render();" 
                                                class="px-4 py-2 ${this.currentView === 'thursday-hall' ? 'bg-orange-600' : 'bg-blue-600'} text-white rounded-lg hover:opacity-90">
                                            Switch to ${this.currentView === 'thursday-hall' ? 'Saturday' : 'Thursday'}
                                        </button>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="table-container bg-white rounded-lg shadow-xl overflow-hidden">
                                <table class="w-full">
                                    <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                                        <tr>
                                            <th class="p-2 md:p-3 text-left text-xs md:text-sm font-semibold sticky left-0 bg-indigo-600 z-10">Date</th>
                                            ${roles.map(role => `
                                                <th class="p-2 md:p-3 text-left text-xs md:text-sm font-semibold role-cell">
                                                    <div class="font-bold">${role.name}</div>
                                                    <div class="text-xs opacity-90">${role.time}</div>
                                                </th>
                                            `).join('')}
                                            ${this.isAdmin ? '<th class="p-2 md:p-3 text-left text-xs md:text-sm font-semibold">Notes</th>' : ''}
                                            ${this.isAdmin && this.currentView !== 'weekly-tasks' ? '<th class="p-2 md:p-3 text-center text-xs md:text-sm font-semibold">Giveaway</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dates.map((d, i) => {
                                            const dateClass = this.getDateClass(d.date);
                                            const isNextShift = d.date === nextShiftDate;
                                            return `
                                            <tr class="border-b hover:bg-gray-50 ${dateClass}">
                                                <td class="p-2 md:p-3 font-semibold text-xs md:text-sm sticky left-0 ${dateClass} z-10 relative">
                                                    ${isNextShift ? '<div class="next-shift-badge">NEXT SHIFT</div>' : ''}
                                                    ${d.label}
                                                </td>
                                                ${roles.map(role => {
                                                    // Skip giveaway role if not enabled for this date
                                                    if (role.id === 'giveaway' && !this.isGiveawayEnabled(this.currentView, d.date)) {
                                                        return '';
                                                    }
                                                    
                                                    const signups = this.getSignups(this.currentView, d.date, role.id);
                                                    const slotsLeft = role.capacity - signups.length;
                                                    return `
                                                    <td class="p-2 md:p-3 text-xs md:text-sm role-cell">
                                                        ${signups.map(signup => {
                                                            const isEditing = this.editingSignup && 
                                                                            this.editingSignup.view === this.currentView && 
                                                                            this.editingSignup.dateStr === d.date && 
                                                                            this.editingSignup.roleId === role.id && 
                                                                            this.editingSignup.signup === signup;
                                                            
                                                            return `
                                                                <div class="mb-1 flex items-center gap-1 volunteer-item">
                                                                    ${isEditing ? `
                                                                        <input 
                                                                            type="text" 
                                                                            value="${signup.name}" 
                                                                            id="editInput-${i}"
                                                                            class="flex-1 px-2 py-1 border-2 border-blue-500 rounded"
                                                                            onkeypress="if(event.key==='Enter'){app.saveEdit(this.value);}"
                                                                        />
                                                                        <button onclick="app.saveEdit(document.getElementById('editInput-${i}').value);" class="text-green-600 hover:text-green-800 text-lg">✓</button>
                                                                        <button onclick="app.cancelEdit();" class="text-red-600 hover:text-red-800 text-lg">✕</button>
                                                                    ` : `
                                                                        <span class="flex-1">✓ ${signup.name}</span>
                                                                        <button onclick="app.startEdit('${this.currentView}', '${d.date}', '${role.id}', app.getSignups('${this.currentView}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                                class="edit-icon text-sm">✏️</button>
                                                                        <button onclick="app.removeSignup('${this.currentView}', '${d.date}', '${role.id}', app.getSignups('${this.currentView}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                                class="text-red-600 hover:text-red-800 text-sm ml-1">✕</button>
                                                                    `}
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                        ${slotsLeft > 0 && (!this.editingSignup || this.editingSignup.view !== this.currentView || this.editingSignup.dateStr !== d.date || this.editingSignup.roleId !== role.id) ? 
                                                            Array(slotsLeft).fill(0).map(() => `
                                                                <button onclick="app.selectedSlot={view:'${this.currentView}', dateStr:'${d.date}', roleId:'${role.id}'}; app.showModal=true; app.render();" 
                                                                        class="w-full text-left px-2 py-1 mb-1 border-2 border-dashed border-gray-300 rounded hover:border-indigo-500 hover:bg-indigo-50 text-gray-500 text-xs">
                                                                    + Add volunteer
                                                                </button>
                                                            `).join('') : ''
                                                        }
                                                    </td>
                                                `;
                                                }).join('')}
                                                ${this.isAdmin ? `
                                                    <td class="p-2 md:p-3">
                                                        <input type="text" 
                                                               placeholder="Add note..." 
                                                               value="${this.getNote(this.currentView, d.date)}"
                                                               onchange="app.saveNote('${this.currentView}', '${d.date}', this.value)"
                                                               class="w-full p-1 text-xs border rounded" />
                                                    </td>
                                                ` : ''}
                                                ${this.isAdmin && this.currentView !== 'weekly-tasks' ? `
                                                    <td class="p-2 md:p-3 text-center">
                                                        <input type="checkbox" 
                                                               ${this.isGiveawayEnabled(this.currentView, d.date) ? 'checked' : ''}
                                                               onchange="app.toggleGiveaway('${this.currentView}', '${d.date}')"
                                                               class="w-4 h-4" />
                                                    </td>
                                                ` : ''}
                                            </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    ${this.showModal ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){app.showModal=false; app.render();}">
                            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 class="text-xl font-bold mb-4">Sign Up</h3>
                                <input type="text" 
                                       placeholder="Enter your name" 
                                       value="${this.volunteerName}"
                                       oninput="app.volunteerName=this.value"
                                       onkeypress="if(event.key==='Enter'){app.addSignup();}"
                                       class="w-full p-3 border rounded-lg mb-4"
                                       autofocus />
                                <div class="flex gap-2">
                                    <button onclick="app.addSignup()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                        Confirm
                                    </button>
                                    <button onclick="app.showModal=false; app.volunteerName=''; app.render();" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;
            },

            renderAdminRoster(view) {
                const currentPeriod = this.periods.find(p => p.id === this.selectedPeriod);
                const dates = this.getDatesForView(view);
                const roles = this.getVisibleRoles(view);
                const viewName = view === 'thursday-hall' ? 'Thursday Hall' : 
                                view === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks';

                return `
                    <div class="mb-4">
                        <h3 class="text-xl font-bold mb-3">${viewName}</h3>
                        <select onchange="app.selectedPeriod=this.value; app.render();" class="p-2 border rounded-lg mb-4">
                            ${this.periods.map(p => `<option value="${p.id}" ${p.id === this.selectedPeriod ? 'selected' : ''}>${p.label}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="table-container overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                                <tr>
                                    <th class="p-2 text-left text-sm font-semibold border">Date</th>
                                    ${roles.map(role => `
                                        <th class="p-2 text-left text-sm font-semibold border">
                                            <div class="font-bold">${role.name}</div>
                                            <div class="text-xs opacity-90">${role.time}</div>
                                        </th>
                                    `).join('')}
                                    <th class="p-2 text-left text-sm font-semibold border">Notes</th>
                                    ${view !== 'weekly-tasks' ? '<th class="p-2 text-center text-sm font-semibold border">Giveaway</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${dates.map((d, i) => {
                                    const dateClass = this.getDateClass(d.date);
                                    return `
                                    <tr class="border ${dateClass}">
                                        <td class="p-2 font-semibold text-sm border ${dateClass}">
                                            ${d.label}
                                        </td>
                                        ${roles.map(role => {
                                            if (role.id === 'giveaway' && !this.isGiveawayEnabled(view, d.date)) {
                                                return '';
                                            }
                                            
                                            const signups = this.getSignups(view, d.date, role.id);
                                            const slotsLeft = role.capacity - signups.length;
                                            return `
                                            <td class="p-2 text-sm border">
                                                ${signups.map(signup => {
                                                    const isEditing = this.editingSignup && 
                                                                    this.editingSignup.view === view && 
                                                                    this.editingSignup.dateStr === d.date && 
                                                                    this.editingSignup.roleId === role.id && 
                                                                    this.editingSignup.signup === signup;
                                                    
                                                    return `
                                                        <div class="mb-1 flex items-center gap-1 volunteer-item">
                                                            ${isEditing ? `
                                                                <input 
                                                                    type="text" 
                                                                    value="${signup.name}" 
                                                                    id="editInput-${i}"
                                                                    class="flex-1 px-2 py-1 border-2 border-blue-500 rounded"
                                                                    onkeypress="if(event.key==='Enter'){app.saveEdit(this.value);}"
                                                                />
                                                                <button onclick="app.saveEdit(document.getElementById('editInput-${i}').value);" class="text-green-600 hover:text-green-800 text-lg">✓</button>
                                                                <button onclick="app.cancelEdit();" class="text-red-600 hover:text-red-800 text-lg">✕</button>
                                                            ` : `
                                                                <span class="flex-1">✓ ${signup.name}</span>
                                                                <button onclick="app.startEdit('${view}', '${d.date}', '${role.id}', app.getSignups('${view}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="edit-icon text-sm">✏️</button>
                                                                <button onclick="app.removeSignup('${view}', '${d.date}', '${role.id}', app.getSignups('${view}', '${d.date}', '${role.id}')[${signups.indexOf(signup)}]);" 
                                                                        class="text-red-600 hover:text-red-800 text-sm ml-1">✕</button>
                                                            `}
                                                        </div>
                                                    `;
                                                }).join('')}
                                                ${slotsLeft > 0 && (!this.editingSignup || this.editingSignup.view !== view || this.editingSignup.dateStr !== d.date || this.editingSignup.roleId !== role.id) ? 
                                                    Array(slotsLeft).fill(0).map(() => `
                                                        <button onclick="app.selectedSlot={view:'${view}', dateStr:'${d.date}', roleId:'${role.id}'}; app.showModal=true; app.render();" 
                                                                class="w-full text-left px-2 py-1 mb-1 border-2 border-dashed border-gray-300 rounded hover:border-indigo-500 hover:bg-indigo-50 text-gray-500 text-xs">
                                                            + Add volunteer
                                                        </button>
                                                    `).join('') : ''
                                                }
                                            </td>
                                        `;
                                        }).join('')}
                                        <td class="p-2 border">
                                            <input type="text" 
                                                   placeholder="Add note..." 
                                                   value="${this.getNote(view, d.date)}"
                                                   onchange="app.saveNote('${view}', '${d.date}', this.value)"
                                                   class="w-full p-1 text-xs border rounded" />
                                        </td>
                                        ${view !== 'weekly-tasks' ? `
                                            <td class="p-2 text-center border">
                                                <input type="checkbox" 
                                                       ${this.isGiveawayEnabled(view, d.date) ? 'checked' : ''}
                                                       onchange="app.toggleGiveaway('${view}', '${d.date}')"
                                                       class="w-4 h-4" />
                                            </td>
                                        ` : ''}
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>

                    ${this.showModal ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){app.showModal=false; app.render();}">
                            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 class="text-xl font-bold mb-4">Sign Up</h3>
                                <input type="text" 
                                       placeholder="Enter volunteer name" 
                                       value="${this.volunteerName}"
                                       oninput="app.volunteerName=this.value"
                                       onkeypress="if(event.key==='Enter'){app.addSignup();}"
                                       class="w-full p-3 border rounded-lg mb-4"
                                       autofocus />
                                <div class="flex gap-2">
                                    <button onclick="app.addSignup()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                        Confirm
                                    </button>
                                    <button onclick="app.showModal=false; app.volunteerName=''; app.render();" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                `;
            },

            getDatesForView(view) {
                // Save current view temporarily
                const savedView = this.currentView;
                this.currentView = view;
                const dates = this.getDatesForPeriod();
                this.currentView = savedView;
                return dates;
            },

            renderAdmin() {
                const stats = this.generateReport();
                
                return `
                    <div class="min-h-screen p-4">
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h1 class="text-3xl font-bold">Admin Dashboard</h1>
                                    <button onclick="app.logoutAdmin()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</button>
                                </div>

                                <div class="flex gap-2 mb-6 flex-wrap">
                                    <button onclick="app.adminView='dashboard'; app.render();" class="px-4 py-2 ${this.adminView === 'dashboard' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Dashboard</button>
                                    <button onclick="app.adminView='volunteers'; app.render();" class="px-4 py-2 ${this.adminView === 'volunteers' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Volunteers by Role</button>
                                    <button onclick="app.adminView='thursday-roster'; app.render();" class="px-4 py-2 ${this.adminView === 'thursday-roster' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Thursday Roster</button>
                                    <button onclick="app.adminView='saturday-roster'; app.render();" class="px-4 py-2 ${this.adminView === 'saturday-roster' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Saturday Roster</button>
                                    <button onclick="app.adminView='weekly-roster'; app.render();" class="px-4 py-2 ${this.adminView === 'weekly-roster' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Additional Tasks</button>
                                    <button onclick="app.adminView='settings'; app.render();" class="px-4 py-2 ${this.adminView === 'settings' ? 'bg-indigo-600 text-white' : 'bg-gray-200'} rounded-lg">Settings</button>
                                </div>

                                ${this.adminView === 'dashboard' ? `
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        <div class="p-4 bg-blue-50 rounded-lg">
                                            <div class="text-3xl font-bold text-blue-600">${stats.totalSignups}</div>
                                            <div class="text-gray-600">Total Signups</div>
                                        </div>
                                        <div class="p-4 bg-green-50 rounded-lg">
                                            <div class="text-3xl font-bold text-green-600">${stats.volunteerList.size}</div>
                                            <div class="text-gray-600">Unique Volunteers</div>
                                        </div>
                                        <div class="p-4 bg-purple-50 rounded-lg">
                                            <div class="text-3xl font-bold text-purple-600">${stats.topVolunteers[0]?.[1] || 0}</div>
                                            <div class="text-gray-600">Most Signups</div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xl font-bold mb-3">Top Volunteers by Role</h3>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="p-4 bg-blue-50 rounded-lg">
                                                <h4 class="font-bold text-blue-900 mb-3">👔 Top Meal Managers</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.managers.length > 0 ? stats.topByRole.managers.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-blue-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-green-50 rounded-lg">
                                                <h4 class="font-bold text-green-900 mb-3">🤝 Top Hall Help</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.hallHelp.length > 0 ? stats.topByRole.hallHelp.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-green-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-purple-50 rounded-lg">
                                                <h4 class="font-bold text-purple-900 mb-3">🥤 Top Drinks Trolley</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.drinks.length > 0 ? stats.topByRole.drinks.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-purple-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-yellow-50 rounded-lg">
                                                <h4 class="font-bold text-yellow-900 mb-3">🍽️ Top Dishes</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.dishes.length > 0 ? stats.topByRole.dishes.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-yellow-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>

                                            <div class="p-4 bg-pink-50 rounded-lg">
                                                <h4 class="font-bold text-pink-900 mb-3">🧺 Top Laundry</h4>
                                                <div class="space-y-1">
                                                    ${stats.topByRole.laundry.length > 0 ? stats.topByRole.laundry.map(([name, count], i) => `
                                                        <div class="flex justify-between text-sm">
                                                            <span>${i+1}. ${name}</span>
                                                            <span class="bg-pink-600 text-white px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
                                                        </div>
                                                    `).join('') : '<p class="text-sm text-gray-600">No data</p>'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <h3 class="text-xl font-bold mb-3">By Roster Type</h3>
                                        ${Object.entries(stats.byRoster).map(([type, data]) => `
                                            <div class="mb-3">
                                                <div class="font-bold mb-1">
                                                    ${type === 'thursday-hall' ? 'Thursday Hall' : type === 'saturday-hall' ? 'Saturday Hall' : 'Additional Weekly Tasks'}
                                                    <span class="text-gray-600 font-normal text-sm">(${data.total} signups, ${data.volunteers.size} volunteers)</span>
                                                </div>
                                                <div class="text-sm text-gray-600">
                                                    ${Array.from(data.volunteers).slice(0, 10).join(', ')}${data.volunteers.size > 10 ? '...' : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : this.adminView === 'volunteers' ? `
                                    <div class="space-y-6">
                                        <div class="p-4 bg-blue-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-blue-900 mb-3">👔 Managers (${stats.volunteersByRole.managers.size})</h3>
                                            <div class="text-sm text-blue-800">
                                                ${Array.from(stats.volunteersByRole.managers).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-green-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-green-900 mb-3">🤝 Hall Help (${stats.volunteersByRole.hallHelp.size})</h3>
                                            <div class="text-sm text-green-800">
                                                ${Array.from(stats.volunteersByRole.hallHelp).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-purple-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-purple-900 mb-3">🥤 Drinks Trolley (${stats.volunteersByRole.drinks.size})</h3>
                                            <div class="text-sm text-purple-800">
                                                ${Array.from(stats.volunteersByRole.drinks).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-yellow-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-yellow-900 mb-3">🍽️ Dishes (${stats.volunteersByRole.dishes.size})</h3>
                                            <div class="text-sm text-yellow-800">
                                                ${Array.from(stats.volunteersByRole.dishes).sort().join(', ') || 'None'}
                                            </div>
                                        </div>

                                        <div class="p-4 bg-pink-50 rounded-lg">
                                            <h3 class="text-lg font-bold text-pink-900 mb-3">🧺 Laundry (${stats.volunteersByRole.laundry.size})</h3>
                                            <div class="text-sm text-pink-800">
                                                ${Array.from(stats.volunteersByRole.laundry).sort().join(', ') || 'None'}
                                            </div>
                                        </div>
                                    </div>
                                ` : this.adminView === 'thursday-roster' ? 
                                    this.renderAdminRoster('thursday-hall') :
                                  this.adminView === 'saturday-roster' ? 
                                    this.renderAdminRoster('saturday-hall') :
                                  this.adminView === 'weekly-roster' ? 
                                    this.renderAdminRoster('weekly-tasks') :
                                `
                                    <div class="space-y-4">
                                        <button onclick="app.exportToCSV()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                                            📊 Export to CSV
                                        </button>
                                        <button onclick="app.downloadBackup()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                                            💾 Download Backup
                                        </button>
                                        <button onclick="app.uploadBackup()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">
                                            📂 Upload Backup
                                        </button>
                                        <button onclick="app.addNextQuarter()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700">
                                            ➕ Add Next Quarter
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        app.init();
    </script>
</body>
</html>
