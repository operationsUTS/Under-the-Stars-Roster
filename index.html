<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under the Stars Volunteer Roster</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-orange-50">
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- ðŸ”’ SECURITY WARNING: Replace these with your Supabase credentials ---
        const SUPABASE_URL = 'https://evhjncobivtsxeeqvlue.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2aGpuY29iaXZ0c3hlZXF2bHVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MDAyMTUsImV4cCI6MjA3NzM3NjIxNX0.NZKMBV8WKbef8ADsWAYlgtWlTJsiLqo9T8tjruuy7_k';

        let supabase = null;
        let useLocalStorage = true;

        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && SUPABASE_KEY !== 'YOUR_SUPABASE_ANON_KEY_HERE') {
            try {
                // Initialize Supabase client
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                useLocalStorage = false;
            } catch (e) {
                console.error('Supabase initialization failed. Using local storage mode.', e);
            }
        }

        const app = {
            currentView: 'welcome',
            selectedPeriod: 'jul-sep-2025', 
            showModal: false,
            selectedSlot: null,
            volunteerName: '',
            volunteerEmail: '',
            signups: {},

            periods: [
                { id: 'jan-mar-2025', label: 'January - March 2025', start: '2025-01-01' },
                { id: 'apr-jun-2025', label: 'April - June 2025', start: '2025-04-01' },
                { id: 'jul-sep-2025', label: 'July - September 2025', start: '2025-07-03' }, // Thursday start
                { id: 'oct-dec-2025', label: 'October - December 2025', start: '2025-10-02' }, // Thursday start
            ],

            roles: {
                'thursday-hall': [
                    { id: 'managers', name: 'Managers', time: '9:45am-1:30pm', capacity: 2, note: 'Kitchen & Front of House' },
                    { id: 'hall-help', name: 'Hall Help', time: '10:00am-1:30pm', capacity: 5 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '11:15am-1:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '11:30am-1:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                ],
                'saturday-hall': [
                    { id: 'managers', name: 'Managers', time: '2:45pm-6:30pm', capacity: 2, note: 'Kitchen & Front of House' },
                    { id: 'hall-help', name: 'Hall Help', time: '3:15pm-6:30pm', capacity: 5 },
                    { id: 'drinks', name: 'Drinks Trolley', time: '4:00pm-6:30pm', capacity: 1 },
                    { id: 'dishes', name: 'Dishes', time: '4:30pm-6:30pm', capacity: 1 },
                    { id: 'laundry', name: 'Laundry', time: 'Various', capacity: 1 },
                ],
                'weekly-tasks': [
                    { id: 'wed-pickup', name: 'Wednesday Bakers Delight Pick Up', time: 'Around 3:45pm', capacity: 1 },
                    { id: 'thurs-pickup', name: 'Thursday Bakers Delight Pick Up', time: '4:50pm', capacity: 1 },
                    { id: 'cheesecake', name: 'Cheesecake Shop', time: '3-6pm', capacity: 1 },
                ]
            },

            // --- CORE APP METHODS ---

            async init() {
                if (!this.periods.find(p => p.id === this.selectedPeriod)) {
                     this.selectedPeriod = this.periods[0].id;
                }
                
                await this.loadSignups(); 
                this.render(); 
                this.attachEventListeners(); 
                
                if (!useLocalStorage && supabase) {
                    supabase.channel('signups').on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'volunteer_signups' }, 
                        () => this.loadSignups()
                    ).subscribe();
                }
            },

            attachEventListeners() {
                const appEl = document.getElementById('app');
                if (!appEl) return;
                
                // Event delegation for general clicks in the app
                appEl.addEventListener('click', (event) => {
                    const target = event.target.closest('button, select, [data-action]');
                    if (!target) return;
                    
                    // View/Navigation buttons
                    if (target.dataset.view) {
                        this.currentView = target.dataset.view;
                        this.render();
                    }

                    // Open Modal
                    if (target.dataset.action === 'open-modal') {
                        this.selectedSlot = {
                            view: target.dataset.view,
                            dateStr: target.dataset.date,
                            roleId: target.dataset.role,
                            dateLabel: target.dataset.datelabel,
                            roleName: target.dataset.rolename
                        };
                        this.showModal = true;
                        this.renderModalContainer();
                    }
                    
                    // Remove Signup
                    if (target.dataset.action === 'remove-signup') {
                        const { view, date, role, id, name } = target.dataset;
                        const signup = this.getSignups(view, date, role).find(s => s.id === id || (useLocalStorage && s.name === name));
                        if (signup) {
                            this.removeSignup(view, date, role, signup);
                        }
                    }
                });
                
                // Event delegation for the Modal container (attached to document.body)
                document.body.addEventListener('click', (event) => {
                    const target = event.target.closest('[data-action]');
                    const modalContainer = document.getElementById('modal-container');
                    
                    if (!modalContainer) return; 

                    // Close modal when clicking background 
                    if (event.target === modalContainer.firstChild && event.target.classList.contains('bg-opacity-50')) {
                        this.showModal = false;
                        this.volunteerName = '';
                        this.volunteerEmail = '';
                        this.renderModalContainer();
                        this.renderRosterTable(); 
                    }

                    if (!target) return;
                    
                    // Cancel Signup button
                    if (target.dataset.action === 'cancel-signup') {
                        this.showModal = false;
                        this.volunteerName = '';
                        this.volunteerEmail = '';
                        this.renderModalContainer();
                        this.renderRosterTable();
                    }

                    // Confirm Add Signup button
                    if (target.dataset.action === 'add-signup') {
                        const nameInput = document.getElementById('volName');
                        const emailInput = document.getElementById('volEmail');
                        this.volunteerName = nameInput ? nameInput.value : '';
                        this.volunteerEmail = emailInput ? emailInput.value : '';
                        this.addSignup();
                    }
                });

                // Dropdown Period Selector (uses 'change' event)
                appEl.addEventListener('change', (event) => {
                    if (event.target.id === 'period-selector') {
                        this.selectedPeriod = event.target.value;
                        this.renderRosterTable(); 
                    }
                });
            },
            
            // --- DATA LOGIC ---
            getWeekDates() {
                const periodData = this.periods.find(p => p.id === this.selectedPeriod);
                if (!periodData) return [];

                const weeks = [];
                // Force parsing as local midnight to prevent timezone shift errors
                let currentDate = new Date(periodData.start + 'T00:00:00');
                
                const nextPeriodIndex = this.periods.findIndex(p => p.id === this.selectedPeriod) + 1;
                const nextQuarterStart = new Date((this.periods[nextPeriodIndex]?.start || '2026-01-01') + 'T00:00:00');

                // Helper function to find a specific day of the week (0=Sun, 4=Thu, 6=Sat)
                const getTargetDate = (startDate, targetDay) => {
                    const date = new Date(startDate);
                    const day = date.getDay();
                    const diff = (targetDay - day + 7) % 7;
                    date.setDate(date.getDate() + diff);
                    return date;
                };

                for (let i = 0; i < 14; i++) {
                    const weekStartDate = new Date(currentDate);
                    weekStartDate.setDate(currentDate.getDate() + (i * 7));
                    
                    let shiftDate = new Date(weekStartDate);
                    
                    if (this.currentView === 'thursday-hall') {
                        shiftDate = getTargetDate(weekStartDate, 4); // Thursday (4)
                    } else if (this.currentView === 'saturday-hall') {
                        shiftDate = getTargetDate(weekStartDate, 6); // Saturday (6)
                    } 
                    
                    if (shiftDate.getTime() >= nextQuarterStart.getTime()) break;

                    const thursdayDate = getTargetDate(weekStartDate, 4);
                    const saturdayDate = getTargetDate(thursdayDate, 6); 

                    weeks.push({
                        date: shiftDate.toISOString().split('T')[0],
                        label: shiftDate.toLocaleDateString('en-NZ', { weekday: 'short', day: 'numeric', month: 'long' }),
                        weekLabel: `${thursdayDate.getDate()} ${thursdayDate.toLocaleDateString('en-NZ', { month: 'short' })} - ${saturdayDate.getDate()} ${saturdayDate.toLocaleDateString('en-NZ', { month: 'short' })}`
                    });
                }
                
                return weeks;
            },

            async loadSignups() {
                if (useLocalStorage) {
                    const saved = localStorage.getItem('uts-roster');
                    if (saved) this.signups = JSON.parse(saved);
                } else {
                    try {
                        const { data, error } = await supabase.from('volunteer_signups').select('*');
                        if (error) throw error;
                        
                        this.signups = {};
                        data.forEach(s => {
                            if (!this.signups[s.roster_type]) this.signups[s.roster_type] = {};
                            if (!this.signups[s.roster_type][s.shift_date]) this.signups[s.roster_type][s.shift_date] = {};
                            if (!this.signups[s.roster_type][s.shift_date][s.role_id]) this.signups[s.roster_type][s.shift_date][s.role_id] = [];
                            this.signups[s.roster_type][s.shift_date][s.role_id].push({
                                id: s.id,
                                name: s.volunteer_name,
                                email: s.volunteer_email
                            });
                        });
                    } catch (e) {
                        console.error('Error loading signups. Check RLS policy:', e.message);
                        useLocalStorage = true;
                        const saved = localStorage.getItem('uts-roster');
                        if (saved) this.signups = JSON.parse(saved);
                    }
                }
            },

            async addSignup
